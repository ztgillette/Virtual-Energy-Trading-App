{"version":3,"sources":["../src/util/scale.ts"],"names":[],"mappings":";;;AAGA,6CAAqD;AAIrD,6CAAoG;AAEpG,sEAAiE;AAEjE,MAAM,eAAe,GAAG;IACtB,MAAM,EAAE,oBAAW;IACnB,IAAI,EAAE,kBAAS;IACf,KAAK,EAAE,mBAAU;IACjB,OAAO,EAAE,qBAAY;IACrB,SAAS,EAAE,uBAAc;IACzB,YAAY,EAAE,uCAAiB;CAChC,CAAC;AAEF,SAAgB,WAAW,CAAC,IAAkC;IAC5D,MAAM,gBAAgB,GAAG,eAAe,CAAC,IAAI,CAAC,CAAC;IAC/C,IAAI,gBAAgB,EAAE;QACpB,OAAO,IAAI,gBAAgB,EAAE,CAAC;KAC/B;IAED,OAAO,IAAI,CAAC;AACd,CAAC;AAPD,kCAOC;AAED,SAAgB,mBAAmB,CACjC,IAAkB,EAClB,OAGC;IAED,IAAI,OAAO,IAAI,IAAI,IAAI,IAAI,CAAC,KAAK,EAAE;QACjC,IAAI,IAAA,iBAAQ,EAAC,IAAI,CAAC,KAAK,CAAC,KAAI,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,WAAW,CAAA,EAAE;YAChD,OAAO,OAAO,CAAC,WAAW,CAAC,0BAA0B,CAAC,IAAI,EAAE,OAAO,CAAC,QAAQ,CAAC,CAAC;SAC/E;QACD,OAAO,IAAI,CAAC,KAA8B,CAAC;KAC5C;IACD,MAAM,KAAK,GAAG,WAAW,CAAE,IAAkC,CAAC,IAAI,CAAC,CAAC;IACpE,IAAI,KAAK,EAAE;QACT,iBAAiB,CAAC,KAAK,EAAE,IAAiC,CAAC,CAAC;KAC7D;IACD,OAAO,KAAK,CAAC;AACf,CAAC;AAlBD,kDAkBC;AAGD,SAAS,iBAAiB,CAAC,KAAiB,EAAE,IAA+B;IAC3E,IAAI,CAAC,KAAK,IAAI,CAAC,IAAI,EAAE;QACnB,OAAO;KACR;IAED,IAAI,IAAI,CAAC,MAAM,EAAE;QACf,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;KAC3B;IAED,IAAI,IAAI,CAAC,KAAK,EAAE;QACd,KAAK,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;KACzB;IAED,IAAI,IAAI,CAAC,SAAS,IAAmB,KAAM,CAAC,SAAS,EAAE;QACtC,KAAM,CAAC,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;KACjD;IAED,IAAI,IAAI,CAAC,KAAK,IAAkB,KAAM,CAAC,KAAK,EAAE;QAC9B,KAAM,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;KACxC;AACH,CAAC;AAQD,SAAgB,iBAAiB,CAAC,CAAS,EAAE,CAAc,EAAE,aAAuB;IAClF,IAAI,CAAC,CAAC,EAAE;QACN,OAAO,CAAC,CAAC;KACV;IACD,MAAM,UAAU,GAAG,CAAC,CAAC,KAAK,EAAE,CAAC;IAC7B,MAAM,KAAK,GACT,aAAa,IAAK,CAAS,CAAC,oBAAoB,CAAC,CAAC,CAAE,CAAS,CAAC,oBAAoB,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,EAAE,CAAC;IAC7G,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;IACxD,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;IACxD,OAAO,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC;AACzC,CAAC;AAVD,8CAUC;AAED,SAAgB,oBAAoB,CAAC,CAAoB,EAAE,CAAc,EAAE,aAAuB;IAChG,IAAI,CAAC,CAAC,EAAE;QACN,OAAO,IAAI,CAAC;KACb;IACD,MAAM,UAAU,GAAG,CAAC,CAAC,KAAK,EAAE,CAAC;IAC7B,MAAM,KAAK,GACT,aAAa,IAAK,CAAS,CAAC,oBAAoB,CAAC,CAAC,CAAE,CAAS,CAAC,oBAAoB,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,EAAE,CAAC;IAC7G,MAAM,MAAM,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,CAAS,EAAE,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;IACrD,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,MAAM,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;IAC3D,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,MAAM,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;IAC3D,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE;QACpB,OAAO,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI,GAAG,CAAC,CAAC;KAC3C;IACD,OAAO,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI,GAAG,CAAC;AAC9B,CAAC;AAdD,oDAcC;AAED,SAAgB,oBAAoB,CAAC,SAAc;IACjD,OAAO,IAAA,gBAAO,EAAC,SAAS,aAAT,SAAS,uBAAT,SAAS,CAAE,KAAK,CAAC,IAAI,IAAA,gBAAO,EAAC,SAAS,aAAT,SAAS,uBAAT,SAAS,CAAE,KAAK,CAAC,CAAC;AAChE,CAAC;AAFD,oDAEC","file":"scale.js","sourcesContent":["/**\n * @description Scale 相关的工具函数\n */\nimport { isString, isValid } from '@visactor/vutils';\nimport type { IGlobalScale } from '../scale/interface';\nimport type { IBaseScale } from '@visactor/vscale';\n// eslint-disable-next-line no-duplicate-imports\nimport { BandScale, LinearScale, OrdinalScale, PointScale, ThresholdScale } from '@visactor/vscale';\nimport type { IVisual, IVisualSpecBase } from '../typings/visual';\nimport { ColorOrdinalScale } from '../scale/color-ordinal-scale';\n\nconst defaultScaleMap = {\n  linear: LinearScale,\n  band: BandScale,\n  point: PointScale,\n  ordinal: OrdinalScale,\n  threshold: ThresholdScale,\n  colorOrdinal: ColorOrdinalScale\n};\n\nexport function createScale(type: keyof typeof defaultScaleMap): IBaseScale | null {\n  const scaleConstructor = defaultScaleMap[type];\n  if (scaleConstructor) {\n    return new scaleConstructor();\n  }\n\n  return null;\n}\n\nexport function createScaleWithSpec(\n  spec: IVisual<any>,\n  context: {\n    globalScale: IGlobalScale;\n    seriesId: number;\n  }\n): IBaseScale | null {\n  if ('scale' in spec && spec.scale) {\n    if (isString(spec.scale) && context?.globalScale) {\n      return context.globalScale.registerMarkAttributeScale(spec, context.seriesId);\n    }\n    return spec.scale as unknown as IBaseScale;\n  }\n  const scale = createScale((spec as IVisualSpecBase<any, any>).type);\n  if (scale) {\n    initScaleWithSpec(scale, spec as IVisualSpecBase<any, any>);\n  }\n  return scale;\n}\n\n// 需要一个通用的从spec初始化scale的方法，避免在scale属性更新后需要维护多组逻辑\nfunction initScaleWithSpec(scale: IBaseScale, spec: IVisualSpecBase<any, any>) {\n  if (!scale || !spec) {\n    return;\n  }\n\n  if (spec.domain) {\n    scale.domain(spec.domain);\n  }\n\n  if (spec.range) {\n    scale.range(spec.range);\n  }\n\n  if (spec.specified && (<OrdinalScale>scale).specified) {\n    (<OrdinalScale>scale).specified(spec.specified);\n  }\n\n  if (spec.clamp && (<LinearScale>scale).clamp) {\n    (<LinearScale>scale).clamp(spec.clamp);\n  }\n}\n\n/**\n * value限制在scale range内\n * 对于指标轴: 限制在scale可视范围(scale.range)内, 通常发生在自定义domain的场景中, 防止图元绘制超出画布\n * 对于维度轴: 限制在scale数据范围(scale.wholeRange)内, 通常发生在缩略轴等组件扩大scale区域的场景中, 允许图元超出画布\n * 已知图表范围: 柱状图、条形进度图\n */\nexport function valueInScaleRange(v: number, s?: IBaseScale, useWholeRange?: boolean) {\n  if (!s) {\n    return v;\n  }\n  const scaleRange = s.range();\n  const range =\n    useWholeRange && (s as any)._calculateWholeRange ? (s as any)._calculateWholeRange(scaleRange) : s.range();\n  const min = Math.min(range[0], range[range.length - 1]);\n  const max = Math.max(range[0], range[range.length - 1]);\n  return Math.min(Math.max(min, v), max);\n}\n\nexport function isValueInScaleDomain(v: number | number[], s?: IBaseScale, useWholeRange?: boolean) {\n  if (!s) {\n    return true;\n  }\n  const scaleRange = s.range();\n  const range =\n    useWholeRange && (s as any)._calculateWholeRange ? (s as any)._calculateWholeRange(scaleRange) : s.range();\n  const domain = range.map((v: number) => s.invert(v));\n  const min = Math.min(domain[0], domain[domain.length - 1]);\n  const max = Math.max(domain[0], domain[domain.length - 1]);\n  if (Array.isArray(v)) {\n    return v.every(v => v >= min && v <= max);\n  }\n  return v >= min && v <= max;\n}\n\nexport function isSpecValueWithScale(specValue: any) {\n  return isValid(specValue?.field) && isValid(specValue?.scale);\n}\n"]}