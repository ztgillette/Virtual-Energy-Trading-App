{"version":3,"sources":["../src/plugin/components/tooltip-handler/canvas-tooltip-handler.ts"],"names":[],"mappings":"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","file":"canvas-tooltip-handler.js","sourcesContent":["import type { ILayer, INode, IStage } from '@visactor/vrender-core';\nimport { BaseTooltipHandler } from './base';\nimport { Tooltip as TooltipComponent } from '@visactor/vrender-components';\nimport { isValid, isNil } from '@visactor/vutils';\nimport type { TooltipHandlerParams } from '../../../component/tooltip';\nimport type { IComponentPluginService } from '../interface';\nimport { registerComponentPlugin } from '../register';\nimport { TooltipHandlerType } from '../../../component/tooltip/constant';\nimport type { ITooltipActual } from '../../../typings';\nimport type { IContainerSize } from '@visactor/vrender-components';\nimport { getTooltipAttributes } from './utils/attribute';\nimport type { ITooltipAttributes } from './interface';\n\n/**\n * The tooltip handler class.\n */\nexport class CanvasTooltipHandler extends BaseTooltipHandler {\n  static readonly type = TooltipHandlerType.canvas;\n  readonly type = TooltipHandlerType.canvas;\n\n  private _layer: ILayer;\n  protected _el?: HTMLCanvasElement;\n  protected _tooltipCanvasId?: string;\n  protected _tooltipComponent: TooltipComponent;\n  protected _attributes?: ITooltipAttributes | null = null;\n\n  constructor() {\n    super(CanvasTooltipHandler.type);\n  }\n\n  onAdd(service: IComponentPluginService<any>): void {\n    super.onAdd(service);\n    this._tooltipCanvasId = (this._chartOption.modeParams as any)?.tooltipCanvasId;\n  }\n\n  private _initTooltipComponent(stage: IStage) {\n    const layer = this._getLayer(stage);\n    this._tooltipComponent = new TooltipComponent({\n      autoCalculatePosition: false,\n      autoMeasure: false\n    });\n    layer.add(this._tooltipComponent as unknown as INode);\n  }\n\n  private _getLayer(stage: IStage) {\n    if (this._layer) {\n      return this._layer;\n    }\n\n    this._layer = stage.createLayer(this._tooltipCanvasId);\n\n    // 需要关闭 layer 对应的 canvas 的事件\n    const layerCanvas = this._layer.layerHandler.canvas.nativeCanvas as HTMLCanvasElement;\n    // TODO：待 vrender 支持\n    if (layerCanvas && layerCanvas.style) {\n      layerCanvas.style.touchAction = 'none';\n      layerCanvas.style.pointerEvents = 'none';\n    }\n\n    return this._layer;\n  }\n\n  // 计算 tooltip 内容区域的宽高，并缓存结果\n  protected _getTooltipBoxSize(actualTooltip: ITooltipActual, changePositionOnly: boolean): IContainerSize | undefined {\n    if (!changePositionOnly || isNil(this._attributes)) {\n      const globalFontFamily = this._chartOption?.getTheme('fontFamily');\n      this._attributes = getTooltipAttributes(actualTooltip, this._component.getSpec(), globalFontFamily);\n    }\n    const { panel } = this._attributes ?? {};\n    // canvas模式下, size需要考虑border size, 目的是为了精准判断边界是否超出画布，达到confine效果\n    // html模式不提供confine, 所以不考虑精准计算size\n\n    return {\n      width: panel.width + panel.lineWidth,\n      height: panel.height + panel.lineWidth\n    };\n  }\n\n  protected _removeTooltip() {\n    if (this._layer) {\n      this._layer.removeAllChild();\n      // this._layer.render();\n    }\n    this._attributes = null;\n  }\n\n  protected _updateTooltip(visible: boolean, params: TooltipHandlerParams) {\n    this._visible = visible;\n\n    const stage = this._compiler.getStage();\n    if (!stage) {\n      return;\n    }\n\n    if (!visible) {\n      if (this._tooltipComponent && this._tooltipComponent.attribute.visible) {\n        this._tooltipComponent.hideAll();\n        this._tooltipComponent.setAttributes({\n          visibleAll: false\n        });\n      }\n      return;\n    }\n\n    if (!this._tooltipComponent) {\n      this._initTooltipComponent(stage);\n    }\n\n    const { activeTooltipSpec } = params;\n    const pos = activeTooltipSpec.position;\n    if (!params.changePositionOnly) {\n      this._tooltipComponent.setAttributes({\n        ...this._attributes,\n        ...pos\n      });\n    } else if (isValid(pos)) {\n      this._tooltipComponent.setAttributes(pos);\n    }\n\n    if (!this._tooltipComponent.attribute.visible) {\n      this._tooltipComponent.showAll();\n      this._tooltipComponent.setAttributes({\n        visibleAll: true\n      });\n    }\n  }\n\n  isTooltipShown() {\n    return this._tooltipComponent?.attribute.visibleAll;\n  }\n\n  release() {\n    super.release();\n    this._layer?.release();\n  }\n}\n\nexport const registerCanvasTooltipHandler = () => {\n  registerComponentPlugin(CanvasTooltipHandler);\n};\n"]}