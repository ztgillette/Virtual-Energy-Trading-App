{"version":3,"sources":["../src/component/marker/mark-line/base-mark-line.ts"],"names":[],"mappings":"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","file":"base-mark-line.js","sourcesContent":["import { DataView } from '@visactor/vdataset';\nimport type { IMarkLine, IMarkLineSpec } from './interface';\nimport { markerAggregation } from '../../../data/transforms/aggregation';\nimport {\n  computeClipRange,\n  transformLabelAttributes,\n  transformState,\n  transformStyle,\n  getMarkLineProcessInfo\n} from '../utils';\nimport { registerDataSetInstanceTransform } from '../../../data/register';\nimport type { MarkArcLineAttrs, MarkLineAttrs } from '@visactor/vrender-components';\n// eslint-disable-next-line no-duplicate-imports\nimport type { MarkLine as MarkLineComponent, MarkArcLine as MarkArcLineComponent } from '@visactor/vrender-components';\nimport { transformToGraphic } from '../../../util/style';\nimport { BaseMarker } from '../base-marker';\nimport type { IGroup } from '@visactor/vrender-core';\nimport type { IMarkerSymbol } from '../interface';\nimport { markerRegression } from '../../../data/transforms/regression';\nimport { LayoutZIndex } from '../../../constant/layout';\nimport { markerFilter } from '../../../data/transforms/marker-filter';\nimport { array } from '@visactor/vutils';\n\nexport abstract class BaseMarkLine extends BaseMarker<IMarkLineSpec> implements IMarkLine {\n  static specKey = 'markLine';\n  specKey = 'markLine';\n  layoutZIndex: number = LayoutZIndex.MarkLine;\n\n  // eslint-disable-next-line max-len\n  protected abstract _newMarkLineComponent(\n    attr: MarkLineAttrs | MarkArcLineAttrs\n  ): MarkLineComponent | MarkArcLineComponent;\n  protected abstract _computePointsAttr(): any;\n\n  static _getMarkerCoordinateType(markerSpec: any): string {\n    const { doAngleProcess, doRadiusProcess, doAngRadRad1Process, doRadAngAng1Process, doRadAngProcess } =\n      getMarkLineProcessInfo(markerSpec);\n\n    if (\n      markerSpec.coordinateType === 'polar' ||\n      doAngleProcess ||\n      doRadiusProcess ||\n      doAngRadRad1Process ||\n      doRadAngAng1Process ||\n      doRadAngProcess\n    ) {\n      return 'polar';\n    }\n    return 'cartesian';\n  }\n\n  protected _createMarkerComponent() {\n    const { startSymbol = {} as IMarkerSymbol, endSymbol = {} as IMarkerSymbol } = this._spec as IMarkLineSpec;\n    const label = array(this._spec.label ?? {});\n\n    const markLineAttrs: MarkLineAttrs | MarkArcLineAttrs = {\n      zIndex: this.layoutZIndex,\n      interactive: this._spec.interactive ?? true,\n      hover: this._spec.interactive ?? true,\n      select: this._spec.interactive ?? true,\n      points: [\n        { x: 0, y: 0 },\n        { x: 0, y: 0 }\n      ],\n      center: {\n        x: 0,\n        y: 0\n      },\n      radius: 0,\n      startAngle: 0,\n      endAngle: 0,\n      lineStyle: transformStyle(\n        transformToGraphic(this._spec.line?.style),\n        this._markerData,\n        this._markAttributeContext\n      ),\n      clipInRange: this._spec.clip ?? false,\n      label: label.map(labelItem => {\n        return transformLabelAttributes(labelItem, this._markerData, this._markAttributeContext);\n      }),\n      state: {\n        line: transformState(this._spec.line?.state ?? {}, this._markerData, this._markAttributeContext),\n        lineStartSymbol: transformState(\n          this._spec.startSymbol?.state ?? {},\n          this._markerData,\n          this._markAttributeContext\n        ),\n        lineEndSymbol: transformState(this._spec.endSymbol?.state ?? {}, this._markerData, this._markAttributeContext),\n        label: label.map(labelItem => {\n          return transformState(labelItem.state ?? {}, this._markerData, this._markAttributeContext);\n        }),\n        labelBackground: label.map(labelItem => {\n          return transformState(labelItem.labelBackground?.state ?? {}, this._markerData, this._markAttributeContext);\n        })\n      },\n      animation: this._spec.animation ?? false,\n      animationEnter: this._spec.animationEnter,\n      animationExit: this._spec.animationExit,\n      animationUpdate: this._spec.animationUpdate\n    };\n\n    if (startSymbol.visible) {\n      markLineAttrs.startSymbol = {\n        ...startSymbol,\n        visible: true,\n        style: transformStyle(transformToGraphic(startSymbol.style), this._markerData, this._markAttributeContext)\n      };\n    } else {\n      markLineAttrs.startSymbol = {\n        visible: false\n      };\n    }\n\n    if (endSymbol.visible) {\n      markLineAttrs.endSymbol = {\n        ...endSymbol,\n        visible: true,\n        style: transformStyle(transformToGraphic(endSymbol.style), this._markerData, this._markAttributeContext)\n      };\n    } else {\n      markLineAttrs.endSymbol = {\n        visible: false\n      };\n    }\n    const markLine = this._newMarkLineComponent(markLineAttrs);\n    return markLine as unknown as IGroup;\n  }\n\n  protected _getUpdateMarkerAttrs() {\n    const spec = this._spec;\n    const data = this._markerData;\n    const startRelativeSeries = this._startRelativeSeries;\n    const endRelativeSeries = this._endRelativeSeries;\n    const relativeSeries = this._relativeSeries;\n\n    const pointsAttr = this._computePointsAttr();\n\n    const seriesData = relativeSeries.getViewData().latestData;\n    const dataPoints =\n      data.latestData[0] && data.latestData[0].latestData ? data.latestData[0].latestData : data.latestData;\n\n    let limitRect;\n    if (spec.clip || array(spec.label).some(labelCfg => labelCfg?.confine)) {\n      const { minX, maxX, minY, maxY } = computeClipRange([\n        startRelativeSeries.getRegion(),\n        endRelativeSeries.getRegion(),\n        relativeSeries.getRegion()\n      ]);\n      limitRect = {\n        x: minX,\n        y: minY,\n        width: maxX - minX,\n        height: maxY - minY\n      };\n    }\n    const markerComponentAttr = this._markerComponent?.attribute ?? {};\n    const prevLabelAttrs = array(markerComponentAttr.label);\n    const specLabels = array(this._spec.label);\n\n    const labelAttrs = prevLabelAttrs.map((prevLabel, index) => {\n      const specLabel = specLabels[index] || {};\n      return {\n        ...prevLabel,\n        text: specLabel.formatMethod ? (specLabel.formatMethod(dataPoints, seriesData) as any) : prevLabel?.text\n      };\n    });\n    return {\n      ...pointsAttr,\n      label: labelAttrs as MarkLineComponent['attribute']['label'],\n      limitRect,\n      dx: this._layoutOffsetX,\n      dy: this._layoutOffsetY\n    };\n  }\n\n  protected _markerLayout() {\n    const updateAttrs = this._getUpdateMarkerAttrs();\n    this._markerComponent?.setAttributes(updateAttrs);\n  }\n\n  protected _initDataView(): void {\n    const spec = this._spec;\n    const isCoordinateProcess = 'coordinates' in spec;\n\n    const {\n      doXProcess,\n      doYProcess,\n      doXYY1Process,\n      doYXX1Process,\n      doXYProcess,\n      doAngleProcess,\n      doRadiusProcess,\n      doAngRadRad1Process,\n      doRadAngAng1Process,\n      doRadAngProcess\n    } = getMarkLineProcessInfo(spec);\n    this._markerData = this._getRelativeDataView();\n\n    if (\n      !doXProcess &&\n      !doYProcess &&\n      !doXYY1Process &&\n      !doYXX1Process &&\n      !doXYProcess &&\n      !doAngleProcess &&\n      !doRadiusProcess &&\n      !doAngRadRad1Process &&\n      !doRadAngAng1Process &&\n      !doRadAngProcess &&\n      !isCoordinateProcess\n    ) {\n      return;\n    }\n\n    registerDataSetInstanceTransform(this._option.dataSet, 'markerAggregation', markerAggregation);\n    registerDataSetInstanceTransform(this._option.dataSet, 'markerRegression', markerRegression);\n    registerDataSetInstanceTransform(this._option.dataSet, 'markerFilter', markerFilter);\n\n    const { options, needAggr, needRegr, processData } = this._computeOptions();\n\n    const data = new DataView(this._option.dataSet);\n    data.parse([processData], {\n      type: 'dataview'\n    });\n    if (needAggr) {\n      data.transform({\n        type: 'markerAggregation',\n        options\n      });\n    }\n    if (needRegr) {\n      data.transform({\n        type: 'markerRegression',\n        options\n      });\n    }\n\n    data.transform({\n      type: 'markerFilter',\n      options: this._getAllRelativeSeries()\n    });\n\n    data.target.on('change', () => {\n      this._markerLayout();\n    });\n    this._markerData = data;\n  }\n}\n"]}