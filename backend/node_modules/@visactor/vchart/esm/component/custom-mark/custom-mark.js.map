{"version":3,"sources":["../src/component/custom-mark/custom-mark.ts"],"names":[],"mappings":"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","file":"custom-mark.js","sourcesContent":["import { BaseComponent } from '../base/base-component';\nimport { ComponentTypeEnum } from '../interface/type';\n// eslint-disable-next-line no-duplicate-imports\nimport { LayoutLevel, LayoutZIndex } from '../../constant/layout';\nimport { PREFIX } from '../../constant/base';\nimport type { EnableMarkType, ICustomMarkGroupSpec, ICustomMarkSpec, ILayoutRect } from '../../typings';\nimport { IComponentMark, MarkTypeEnum, type IGroupMark } from '../../mark/interface';\n// eslint-disable-next-line no-duplicate-imports\nimport { Bounds, isEqual, isNil, isValid, isValidNumber } from '@visactor/vutils';\nimport { Factory } from '../../core/factory';\nimport { animationConfig, userAnimationConfig } from '../../animation/utils';\nimport type { IModelMarkAttributeContext } from '../../compile/mark/interface';\n\n// TODO: 规范范型\nexport class CustomMark extends BaseComponent<ICustomMarkSpec<EnableMarkType>> {\n  static type = ComponentTypeEnum.customMark;\n  type = ComponentTypeEnum.customMark;\n\n  static specKey = 'customMark';\n  specKey = 'customMark';\n\n  layoutType: 'none' = 'none';\n  layoutZIndex: number = LayoutZIndex.CustomMark;\n  layoutLevel: number = LayoutLevel.CustomMark;\n\n  protected declare _spec: ICustomMarkSpec<Exclude<EnableMarkType, 'group'>> | ICustomMarkGroupSpec;\n\n  created() {\n    super.created();\n    this.initMarks();\n    this.initEvent();\n  }\n\n  protected _markAttributeContext: IModelMarkAttributeContext;\n  getMarkAttributeContext() {\n    return this._markAttributeContext;\n  }\n\n  protected _buildMarkAttributeContext() {\n    this._markAttributeContext = {\n      vchart: this._option.globalInstance,\n      globalScale: (key: string, value: string | number) => {\n        return this._option.globalScale.getScale(key)?.scale(value);\n      }\n    };\n  }\n\n  protected initMarks() {\n    if (!this._spec) {\n      return;\n    }\n\n    let parentMark: IGroupMark | null = null;\n    if (this._spec.parent) {\n      const mark = this.getChart()\n        .getAllMarks()\n        .find(m => m.getUserId() === this._spec.parent) as IGroupMark;\n      if (mark.type === 'group') {\n        parentMark = mark;\n      }\n    }\n    this._createExtensionMark(this._spec, parentMark, `${PREFIX}_series_${this.id}_extensionMark`, 0);\n  }\n\n  private _createExtensionMark(\n    spec: ICustomMarkSpec<Exclude<EnableMarkType, 'group'>> | ICustomMarkGroupSpec,\n    parentMark: null | IGroupMark,\n    namePrefix: string,\n    index: number = 0\n  ) {\n    const mark = this._createMark(\n      {\n        type: spec.type,\n        name: isValid(spec.name) ? `${spec.name}` : `${namePrefix}_${index}`\n      },\n      {\n        // 避免二次dataflow\n        skipBeforeLayouted: true,\n        attributeContext: this._getMarkAttributeContext(),\n        componentType: spec.componentType,\n        key: spec.dataKey\n      }\n    ) as IGroupMark;\n    if (!mark) {\n      return;\n    }\n\n    if (isValid(spec.id)) {\n      mark.setUserId(spec.id);\n    }\n\n    if (this._option.globalInstance?.isAnimationEnable() && spec.animation) {\n      // 自定义图元默认不添加动画\n      const config = animationConfig({}, userAnimationConfig(spec.type, spec as any, this._markAttributeContext));\n      mark.setAnimationConfig(config);\n    }\n\n    if (isNil(parentMark)) {\n      this._marks.addMark(mark);\n    } else if (parentMark) {\n      parentMark.addMark(mark);\n    }\n    // set style\n    this.initMarkStyleWithSpec(mark, spec);\n    if (spec.type === 'group') {\n      namePrefix = `${namePrefix}_${index}`;\n      spec.children?.forEach((s, i) => {\n        this._createExtensionMark(s as any, mark, namePrefix, i);\n      });\n    }\n\n    if (isValid(spec.dataId) || isValidNumber(spec.dataIndex)) {\n      const dataview = this.getChart().getSeriesData(spec.dataId, spec.dataIndex);\n      if (dataview) {\n        dataview.target.addListener('change', () => {\n          mark.getData().updateData();\n        });\n        mark.setDataView(dataview);\n      }\n    }\n  }\n\n  initEvent() {\n    // do nothing\n  }\n\n  /**\n   * updateSpec\n   */\n  _compareSpec(spec: ICustomMarkSpec<EnableMarkType>, prevSpec: ICustomMarkSpec<EnableMarkType>) {\n    const result = super._compareSpec(spec, prevSpec);\n    if (!isEqual(prevSpec, spec)) {\n      result.reMake = true;\n    }\n\n    result.change = true;\n    result.reRender = true;\n    return result;\n  }\n\n  private _getMarkAttributeContext() {\n    return {\n      vchart: this._option.globalInstance,\n      chart: this.getChart(),\n      globalScale: (key: string, value: string | number) => {\n        return this._option.globalScale.getScale(key)?.scale(value);\n      },\n      getLayoutBounds: () => {\n        const { x, y } = this.getLayoutStartPoint();\n        const { width, height } = this.getLayoutRect();\n        return new Bounds().set(x, y, x + width, y + height);\n      }\n    };\n  }\n\n  private _getLayoutRect() {\n    const bounds = new Bounds();\n\n    this.getMarks().forEach(mark => {\n      const product = mark.getProduct();\n\n      if (product) {\n        bounds.union(product.AABBBounds);\n      }\n    });\n\n    if (bounds.empty()) {\n      return {\n        width: 0,\n        height: 0\n      };\n    }\n\n    return {\n      width: bounds.width(),\n      height: bounds.height()\n    };\n  }\n\n  getBoundsInRect(rect: ILayoutRect) {\n    this.setLayoutRect(rect);\n\n    const result = this._getLayoutRect();\n    const { x, y } = this.getLayoutStartPoint();\n    return {\n      x1: x,\n      y1: y,\n      x2: x + result.width,\n      y2: y + result.height\n    };\n  }\n\n  getVRenderComponents() {\n    const comps: any[] = [];\n    const checkFunc = (m: IComponentMark) => {\n      if (m && m.type === MarkTypeEnum.group) {\n        m.getMarks().forEach(child => {\n          checkFunc(child as IComponentMark);\n        });\n      } else if (m.type === MarkTypeEnum.component) {\n        const comp = m?.getComponent();\n\n        if (comp) {\n          comps.push(comp);\n        }\n      }\n    };\n\n    this.getMarks().forEach(m => {\n      checkFunc(m as IComponentMark);\n    });\n\n    return comps;\n  }\n}\n\nexport const registerCustomMark = () => {\n  Factory.registerComponent(CustomMark.type, CustomMark);\n};\n"]}