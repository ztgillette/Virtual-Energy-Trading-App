{"version":3,"sources":["../src/component/label/base-label.ts"],"names":[],"mappings":"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","file":"base-label.js","sourcesContent":["import { BaseComponent } from '../base/base-component';\nimport type { IComponentOption } from '../interface';\n// eslint-disable-next-line no-duplicate-imports\nimport { ComponentTypeEnum } from '../interface/type';\nimport type { IRegion } from '../../region/interface';\nimport type { IModelRenderOption } from '../../model/interface';\nimport { LayoutZIndex } from '../../constant/layout';\nimport type { ILabelSpec } from './interface';\nimport type { IHoverSpec, ISelectSpec } from '../../interaction/interface/spec';\nimport { array, isEqual, isNil, isPlainObject } from '@visactor/vutils';\nimport type { IGraphic } from '@visactor/vrender-core';\nimport type { IComponentMark } from '../../mark/interface/mark';\nimport type { ICompilableMark } from '../../compile/mark/interface';\nimport { DiffState } from '../../mark/interface/enum';\nimport type { Datum } from '../../typings/common';\nimport { MarkTypeEnum } from '../../mark/interface/type';\nimport type { IMark } from '../../mark/interface/common';\nimport { getActualColor } from '../../core';\n\nexport abstract class BaseLabelComponent<T = any> extends BaseComponent<T> {\n  static type = ComponentTypeEnum.label;\n  type = ComponentTypeEnum.label;\n  name: string = ComponentTypeEnum.label;\n\n  layoutType: 'none' = 'none';\n  layoutZIndex: number = LayoutZIndex.Label;\n\n  constructor(spec: T, options: IComponentOption) {\n    super(spec, options);\n    this._regions = options.getRegionsInIndex(options.regionIndexes);\n  }\n\n  protected _interactiveConfig(labelSpec: ILabelSpec) {\n    const { interactive } = labelSpec;\n    const result = { hover: false, select: false, state: labelSpec.state };\n    if (interactive !== true) {\n      return result;\n    }\n\n    const { hover, select } = this._option.getChart().getSpec();\n    if (hover !== false || (hover as unknown as IHoverSpec).enable !== false) {\n      result.hover = true;\n    }\n    if (select !== false || (select as unknown as ISelectSpec).enable !== false) {\n      result.select = true;\n    }\n    return result;\n  }\n\n  /** Update API **/\n  _compareSpec(spec: T, prevSpec: T) {\n    const result = super._compareSpec(spec, prevSpec);\n    result.reRender = true;\n    if (!isEqual(prevSpec, spec)) {\n      result.reMake = true;\n    }\n\n    return result;\n  }\n\n  _getDataLabelType(baseMark: ICompilableMark, type?: string) {\n    const markType = baseMark.type;\n\n    if (markType === 'line' || markType === 'area') {\n      return type ?? 'line-data';\n    }\n    if (markType === MarkTypeEnum.rect) {\n      return 'rect';\n    }\n\n    if (markType === MarkTypeEnum.arc) {\n      return 'arc';\n    }\n\n    if (markType === MarkTypeEnum.symbol || markType === MarkTypeEnum.cell) {\n      return 'symbol';\n    }\n\n    return baseMark.setDataLabelType ? baseMark.setDataLabelType() : '';\n  }\n\n  _setTransformOfComponent(labelComponent: IComponentMark, baseMark: IMark | IMark[]) {\n    labelComponent.setAttributeTransform(({ labelStyle, size, itemEncoder }) => {\n      const regionSize = size();\n      const defaultFill = getActualColor({ type: 'palette', key: 'secondaryFontColor' }, this.getColorScheme());\n      const dataLabels = array(baseMark).map((mark: IMark, labelIndex: number) => {\n        const labelStyleRes = labelStyle(labelIndex);\n        const labelData: any[] = [];\n        const graphics = (mark as any).getGraphics();\n\n        if (!graphics) {\n          return;\n        }\n\n        if (labelStyleRes.data && labelStyleRes.data.length) {\n          labelStyleRes.data.forEach((d: Datum, index: number) => {\n            if (graphics[index]) {\n              const formattedDatum = itemEncoder(d, { labelIndex });\n\n              if (isNil(formattedDatum.fill)) {\n                formattedDatum.fill = defaultFill;\n              }\n              if (isNil(formattedDatum.data)) {\n                formattedDatum.data = d;\n              }\n\n              labelData.push(formattedDatum);\n            }\n          });\n        } else {\n          graphics.forEach((g: IGraphic) => {\n            const { data, diffState } = g.context;\n\n            if (diffState !== DiffState.exit) {\n              data.forEach((datum: Datum, {}) => {\n                const formattedDatum = itemEncoder(datum, { labelIndex });\n\n                if (isNil(formattedDatum.fill)) {\n                  formattedDatum.fill = defaultFill;\n                }\n                if (isNil(formattedDatum.data)) {\n                  formattedDatum.data = datum;\n                }\n\n                labelData.push(formattedDatum);\n              });\n            }\n          });\n        }\n\n        if (isPlainObject(labelStyleRes.overlap) && isNil(labelStyleRes.overlap.size)) {\n          labelStyleRes.overlap.size = {\n            ...regionSize\n          };\n        }\n\n        return {\n          smartInvert: false, // 之前在vgrammar 中设置的默认值\n          baseMarkGroupName: mark.getProductId(),\n          getBaseMarks: () => graphics,\n          ...labelStyleRes,\n          type: this._getDataLabelType(mark, labelStyleRes.type),\n          data: labelData\n        };\n      });\n\n      return {\n        dataLabels,\n        size: regionSize\n      };\n    });\n  }\n\n  getVRenderComponents() {\n    const labels: any[] = [];\n    this.getMarks().forEach(m => {\n      const graphicItem = (m as IComponentMark).getComponent();\n      if (graphicItem) {\n        labels.push(graphicItem);\n      }\n    });\n    return labels;\n  }\n\n  clear() {\n    super.clear();\n\n    this.getMarks().forEach(m => {\n      if (m) {\n        (m as IComponentMark).clearComponent();\n      }\n    });\n  }\n}\n"]}