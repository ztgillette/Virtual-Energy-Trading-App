{"version":3,"sources":["../src/model/base-model.ts"],"names":[],"mappings":";;;;;;;;;;;AAAA,OAAO,EAAE,QAAQ,EAAE,MAAM,YAAY,CAAC;AACtC,OAAO,EAAE,KAAK,EAAE,MAAM,gBAAgB,CAAC;AA+BvC,OAAO,EAAE,OAAO,EAAE,MAAM,kBAAkB,CAAC;AAC3C,OAAO,EAAE,OAAO,EAAE,MAAM,iBAAiB,CAAC;AAC1C,OAAO,EAAE,OAAO,EAAE,MAAM,kBAAkB,CAAC;AAE3C,OAAO,EAAE,cAAc,EAAE,MAAM,4BAA4B,CAAC;AAC5D,OAAO,EAAE,MAAM,EAAE,MAAM,kBAAkB,CAAC;AAC1C,OAAO,EAAE,wBAAwB,EAAE,MAAM,0BAA0B,CAAC;AACpE,OAAO,EAAE,WAAW,EAAE,MAAM,4BAA4B,CAAC;AAIzD,MAAM,OAAgB,SAAgC,SAAQ,cAAc;IAI1E,OAAO;QACL,OAAO,IAAI,CAAC,KAAK,IAAK,EAAQ,CAAC;IACjC,CAAC;IAGD,WAAW;;QACT,OAAO,MAAA,IAAI,CAAC,OAAO,0CAAE,QAAQ,CAAC;IAChC,CAAC;IAGD,eAAe;;QACb,OAAO,MAAA,MAAA,IAAI,CAAC,OAAO,0CAAE,YAAY,mCAAI,MAAA,IAAI,CAAC,OAAO,0CAAE,QAAQ,CAAC;IAC9D,CAAC;IAiBD,OAAO;QACL,OAAO,IAAI,CAAC,KAAK,CAAC;IACpB,CAAC;IAID,IAAI,MAAM;QACR,OAAO,IAAI,CAAC,OAAO,CAAC;IACtB,CAAC;IAKD,SAAS;QACP,OAAO,IAAI,CAAC,OAAO,CAAC;IACtB,CAAC;IAGD,QAAQ;;QACN,OAAO,MAAA,MAAA,IAAI,CAAC,MAAM,0CAAE,QAAQ,EAAE,mCAAI,EAAE,CAAC;IACvC,CAAC;IACD,cAAc;;QACZ,OAAO,MAAA,IAAI,CAAC,MAAM,0CAAE,cAAc,EAAE,CAAC;IACvC,CAAC;IACD,UAAU;QACR,OAAO,IAAI,CAAC,MAAM,CAAC;IACrB,CAAC;IAED,QAAQ;QACN,OAAO,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;IACjC,CAAC;IAED,IAAc,MAAM;;QAClB,OAAO,MAAA,IAAI,CAAC,WAAW,EAAE,0CAAE,KAAK,CAAC;IACnC,CAAC;IAKD,YAAY,IAAO,EAAE,MAAoB;;QACvC,KAAK,CAAC,MAAM,CAAC,CAAC;QAxEP,2BAAsB,GAAG,wBAAwB,CAAC;QAiBlD,SAAI,GAAW,MAAM,CAAC;QACtB,cAAS,GAAW,MAAM,CAAC;QAIpC,WAAM,GAA+B,SAAS,CAAC;QASrC,UAAK,GAAoB,IAAI,CAAC;QAM9B,YAAO,GAAiB,IAAI,CAAC;QAK9B,YAAO,GAAW,EAAE,CAAC;QAOpB,WAAM,GAAY,IAAI,OAAO,EAAE,CAAC;QAoBhC,oBAAe,GAAgB,IAAI,CAAC;QAI5C,IAAI,CAAC,EAAE,GAAG,QAAQ,EAAE,CAAC;QACrB,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,EAAE,CAAC;QACtB,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;QAClB,IAAI,CAAC,MAAM,GAAG,EAAE,CAAC;QACjB,IAAI,CAAC,KAAK,GAAG,IAAI,KAAK,CAAC,MAAM,CAAC,eAAe,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC;QAC5D,MAAA,MAAM,CAAC,GAAG,0CAAE,GAAG,CAAC,IAAI,CAAC,EAAE,EAAE,IAAI,CAAC,CAAC;IACjC,CAAC;IAGS,aAAa;QACrB,IAAI,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC;IACvB,CAAC;IAED,OAAO;QACL,IAAI,CAAC,eAAe,EAAE,CAAC;IACzB,CAAC;IAED,IAAI,CAAC,MAAwB;IAE7B,CAAC;IAED,SAAS;IAET,CAAC;IAED,UAAU;;QACR,OAAO,CAAA,MAAC,IAAI,CAAC,KAAwB,0CAAE,OAAO,MAAK,KAAK,CAAC;IAC3D,CAAC;IAED,aAAa,CAAC,UAAiB,EAAE,QAAqB;;QAEpD,MAAA,IAAI,CAAC,OAAO,0CAAE,aAAa,CAAC,UAAU,EAAE,QAAQ,CAAC,CAAC;IACpD,CAAC;IACD,WAAW;;QACT,MAAA,IAAI,CAAC,OAAO,0CAAE,WAAW,EAAE,CAAC;QAC5B,IAAI,CAAC,QAAQ,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC,CAAC;IACtD,CAAC;IAED,aAAa,CAAC,GAAyB;IAEvC,CAAC;IAED,cAAc;IAEd,CAAC;IAED,YAAY;IAEZ,CAAC;IAED,aAAa;IAEb,CAAC;IAED,KAAK;QACH,IAAI,CAAC,QAAQ,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,WAAC,OAAA,MAAA,CAAC,CAAC,KAAK,iDAAI,CAAA,EAAA,CAAC,CAAC;IAC5C,CAAC;IAED,OAAO;;QACL,IAAI,CAAC,aAAa,EAAE,CAAC;QACrB,IAAI,CAAC,KAAK,GAAG,SAAS,CAAC;QACvB,IAAI,CAAC,QAAQ,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,OAAO,EAAE,CAAC,CAAC;QAC1C,MAAA,IAAI,CAAC,KAAK,0CAAE,OAAO,EAAE,CAAC;QACtB,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;QAClB,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC;QACpB,KAAK,CAAC,OAAO,EAAE,CAAC;IAClB,CAAC;IAED,UAAU,CAAC,IAAO;;QAChB,MAAM,MAAM,GAAG,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;QAEnD,IAAI,MAAM,CAAC,QAAQ,IAAI,MAAM,CAAC,MAAM,IAAI,MAAM,CAAC,SAAS,EAAE;YACxD,MAAA,IAAI,CAAC,OAAO,0CAAE,gBAAgB,EAAE,CAAC;SAClC;QACD,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;QAElB,OAAO,MAAM,CAAC;IAChB,CAAC;IAES,YAAY,CAAC,IAAO,EAAE,QAAW;QACzC,MAAM,MAAM,GAAG;YACb,MAAM,EAAE,KAAK;YACb,MAAM,EAAE,KAAK;YACb,QAAQ,EAAE,KAAK;YACf,MAAM,EAAE,KAAK;YACb,SAAS,EAAE,KAAK;SACjB,CAAC;QACF,OAAO,MAAM,CAAC;IAChB,CAAC;IAED,MAAM,CAAC,IAAQ;QACb,IAAI,IAAI,EAAE;YACR,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;SACnB;QACD,IAAI,CAAC,eAAe,EAAE,CAAC;IACzB,CAAC;IAED,qBAAqB;IAErB,CAAC;IAED,eAAe;;QACb,MAAA,IAAI,CAAC,OAAO,0CAAE,eAAe,CAAC,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,OAAO,CAAC,gBAAgB,EAAE,CAAC,CAAC;IAC7E,CAAC;IAGS,iBAAiB,CACzB,KAAyD;QAEzD,yBAAY,KAAK,EAAG;IACtB,CAAC;IAED,YAAY,CACV,IAAiB,EACjB,KAA0D,EAC1D,KAAsB,EACtB,KAAc;QAEd,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;YACrC,OAAO;SACR;QACD,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC,EAAE,KAAK,EAAE,KAAK,CAAC,CAAC;IAC7D,CAAC;IAED,qBAAqB,CAAC,IAAY,EAAE,IAAU;QAC5C,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE;YACpC,OAAO;SACR;QACD,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG,IAAI,CAAC;QAC9B,MAAM,OAAO,qBAAQ,IAAI,CAAE,CAAC;QAE5B,IAAI,KAAK,EAAE;YACT,OAAO,CAAC,KAAK,GAAG,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC,CAAC;SAC/C;QACD,IAAI,KAAK,EAAE;YACT,OAAO,CAAC,KAAK,GAAG,EAAE,CAAC;YACnB,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE;gBAC/B,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC;YAC1D,CAAC,CAAC,CAAC;SACJ;QACD,IAAI,CAAC,iBAAiB,CAAC,OAAO,CAAC,CAAC;IAClC,CAAC;IAES,oBAAoB,CAAC,GAAW,EAAE,GAAY;QACtD,IAAI,IAAI,GAAG,GAAG,MAAM,IAAI,IAAI,CAAC,SAAS,IAAI,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,CAAC;QACxE,GAAG,IAAI,CAAC,IAAI,IAAI,IAAI,GAAG,EAAE,CAAC,CAAC;QAC3B,OAAO,IAAI,CAAC;IACd,CAAC;IAED,WAAW;;QACT,MAAA,IAAI,CAAC,KAAK,0CAAE,OAAO,EAAE,CAAC;IACxB,CAAC;IAED,YAAY,CAAC,KAAc;QACzB,IAAI,CAAC,QAAQ,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE;YAC1B,CAAC,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC;QACvB,CAAC,CAAC,CAAC;IACL,CAAC;IAES,WAAW,CACnB,QAAwB,EACxB,SAA+B,EAAE,EACjC,MAA2B;QAE3B,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,GAAG,QAAQ,CAAC;QAChC,MAAM,EAAE,MAAM,KAAgB,MAAM,EAAjB,MAAM,UAAK,MAAM,EAA9B,UAAqB,CAAS,CAAC;QACrC,MAAM,CAAC,GAAG,OAAO,CAAC,UAAU,CAAC,IAAW,EAAE,IAAI,kBAC5C,KAAK,EAAE,IAAI,EACX,GAAG,EAAE,IAAI,CAAC,OAAO,CAAC,GAAG,EACrB,WAAW,EAAE,IAAI,CAAC,WAAW,EAC7B,WAAW,EAAE,IAAI,CAAC,OAAO,CAAC,WAAW,IAClC,MAAM,EACJ,CAAC;QAER,IAAI,MAAM,EAAE;YACV,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;SACnB;aAAM;YACL,IAAI,CAAC,WAAW,EAAE,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;SACnC;QAED,IAAI,CAAC,EAAE;YACL,CAAC,CAAC,OAAO,EAAE,CAAC;YACZ,MAAM,IAAI,CAAC,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;SACnC;QACD,OAAO,CAAC,CAAC;IACX,CAAC;IAOS,aAAa;QACrB,OAAO,SAAS,CAAC;IACnB,CAAC;IAED,cAAc;;QACZ,OAAO,MAAA,MAAA,IAAI,CAAC,OAAO,EAAC,QAAQ,mDAAG,aAAa,CAAC,CAAC;IAChD,CAAC;IAED,WAAW;;QACT,MAAM,QAAQ,GAAG,MAAA,MAAA,MAAA,IAAI,CAAC,OAAO,EAAC,WAAW,kDAAI,mCAAI,EAAE,CAAC;QACpD,OAAO,WAAW,CAAiB,QAAQ,EAAE,IAAI,CAAC,eAAe,EAAE,CAAC,CAAC;IACvE,CAAC;IAED,YAAY;QACV,MAAM,IAAI,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC;QAChC,IAAI,CAAC,CAAA,IAAI,aAAJ,IAAI,uBAAJ,IAAI,CAAE,MAAM,CAAA,EAAE;YACjB,OAAO,CAAC,CAAC;SACV;QACD,MAAM,KAAK,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;QAC5C,IAAI,KAAK,CAAC,KAAK,CAAC,EAAE;YAChB,OAAO,CAAC,CAAC;SACV;QACD,OAAO,KAAK,CAAC;IACf,CAAC;IAID,0BAA0B,CAAC,QAAyD;QAClF,IAAI,CAAC,uBAAuB,GAAG,QAAQ,CAAC;IAC1C,CAAC;IAED,yBAAyB;QACvB,OAAO,IAAI,CAAC,uBAAuB,CAAC;IACtC,CAAC;CACF","file":"base-model.js","sourcesContent":["import { createID } from '../util/id';\nimport { Event } from '../event/event';\nimport type { IEvent } from '../event/interface';\nimport type {\n  IEffect,\n  IModel,\n  IModelInitOption,\n  IModelOption,\n  IModelEvaluateOption,\n  IModelSpec,\n  IModelMarkInfo,\n  IModelSpecInfo\n} from './interface';\nimport type { CoordinateType } from '../typings/coordinate';\nimport type {\n  AnimationStateValues,\n  ICompileMarkConfig,\n  IMark,\n  IMarkGraphic,\n  IMarkOption,\n  IMarkRaw,\n  IMarkStyle\n} from '../mark/interface';\nimport type {\n  Datum,\n  StateValueType,\n  ConvertToMarkStyleSpec,\n  ICommonSpec,\n  StringOrNumber,\n  IRect,\n  ILayoutRect\n} from '../typings';\nimport { isValid } from '@visactor/vutils';\nimport { Factory } from '../core/factory';\nimport { MarkSet } from '../mark/mark-set';\nimport type { ILayoutItem } from '../layout/interface';\nimport { CompilableBase } from '../compile/compilable-base';\nimport { PREFIX } from '../constant/base';\nimport { BaseModelSpecTransformer } from './base-model-transformer';\nimport { getProperty } from '@visactor/vutils-extension';\nimport type { IGroup } from '@visactor/vrender-core';\nimport type { ICompilableData } from '../compile/data/interface';\n\nexport abstract class BaseModel<T extends IModelSpec> extends CompilableBase implements IModel {\n  readonly transformerConstructor = BaseModelSpecTransformer;\n\n  protected _spec: T;\n  getSpec(): T {\n    return this._spec || ({} as T);\n  }\n\n  /** 获取当前 model 对应在图表 spec 上的路径 */\n  getSpecPath() {\n    return this._option?.specPath;\n  }\n\n  /** 获取当前 model 对应在图表 specInfo 上的路径 */\n  getSpecInfoPath() {\n    return this._option?.specInfoPath ?? this._option?.specPath;\n  }\n\n  readonly type: string = 'null';\n  readonly modelType: string = 'null';\n\n  readonly id;\n\n  userId: StringOrNumber | undefined = undefined;\n\n  // 事件\n  readonly event: IEvent;\n\n  // 副作用\n  readonly effect: IEffect;\n\n  // 数据\n  protected _data: ICompilableData = null;\n  getData() {\n    return this._data;\n  }\n\n  // 布局\n  protected _layout?: ILayoutItem = null;\n  get layout() {\n    return this._layout;\n  }\n\n  readonly specKey: string = '';\n\n  protected declare _option: IModelOption;\n  getOption() {\n    return this._option;\n  }\n\n  protected _marks: MarkSet = new MarkSet();\n  getMarks(): IMark[] {\n    return this._marks?.getMarks() ?? [];\n  }\n  getMarkNameMap() {\n    return this._marks?.getMarkNameMap();\n  }\n  getMarkSet() {\n    return this._marks;\n  }\n\n  getChart() {\n    return this._option.getChart();\n  }\n\n  protected get _theme() {\n    return this.getSpecInfo()?.theme;\n  }\n\n  /** for layout diff */\n  protected _lastLayoutRect: ILayoutRect = null;\n\n  constructor(spec: T, option: IModelOption) {\n    super(option);\n    this.id = createID();\n    this.userId = spec.id;\n    this._spec = spec;\n    this.effect = {};\n    this.event = new Event(option.eventDispatcher, option.mode);\n    option.map?.set(this.id, this);\n  }\n  coordinate?: CoordinateType;\n\n  protected _releaseEvent() {\n    this.event.release();\n  }\n\n  created() {\n    this.setAttrFromSpec();\n  }\n\n  init(option: IModelInitOption) {\n    // do nothing\n  }\n\n  afterInit() {\n    // do nothing\n  }\n\n  getVisible() {\n    return (this._spec as unknown as any)?.visible !== false;\n  }\n\n  onLayoutStart(layoutRect: IRect, viewRect: ILayoutRect): void {\n    // do nothing\n    this._layout?.onLayoutStart(layoutRect, viewRect);\n  }\n  onLayoutEnd(): void {\n    this._layout?.onLayoutEnd();\n    this.getMarks().forEach(m => m.commit(false, true));\n  }\n\n  onEvaluateEnd(ctx: IModelEvaluateOption) {\n    // do nothing\n  }\n\n  onBeforeRender() {\n    // do nothing\n  }\n\n  onDataUpdate() {\n    // do nothing\n  }\n\n  beforeRelease() {\n    // do nothing\n  }\n\n  clear() {\n    this.getMarks().forEach(m => m.clear?.());\n  }\n\n  release() {\n    this._releaseEvent();\n    this._spec = undefined;\n    this.getMarks().forEach(m => m.release());\n    this._data?.release();\n    this._data = null;\n    this._marks.clear();\n    super.release();\n  }\n\n  updateSpec(spec: T) {\n    const result = this._compareSpec(spec, this._spec);\n    // 如果发现需要改变\n    if (result.reRender || result.reMake || result.reCompile) {\n      this._layout?.setWillLayoutTag();\n    }\n    this._spec = spec;\n\n    return result;\n  }\n\n  protected _compareSpec(spec: T, prevSpec: T) {\n    const result = {\n      change: false,\n      reMake: false,\n      reRender: false,\n      reSize: false,\n      reCompile: false\n    };\n    return result;\n  }\n\n  reInit(spec?: T) {\n    if (spec) {\n      this._spec = spec;\n    }\n    this.setAttrFromSpec();\n  }\n\n  updateLayoutAttribute() {\n    // do nothing\n  }\n\n  setAttrFromSpec() {\n    this._layout?.setAttrFromSpec(this._spec, this._option.getChartViewRect());\n  }\n\n  /** mark style 内部转换逻辑，override 使用 */\n  protected _convertMarkStyle<T extends ICommonSpec = ICommonSpec>(\n    style: Partial<IMarkStyle<T> | ConvertToMarkStyleSpec<T>>\n  ): Partial<IMarkStyle<T> | ConvertToMarkStyleSpec<T>> {\n    return { ...style };\n  }\n\n  setMarkStyle<T extends ICommonSpec>(\n    mark: IMarkRaw<T>,\n    style?: Partial<IMarkStyle<T> | ConvertToMarkStyleSpec<T>>,\n    state?: StateValueType,\n    level?: number\n  ) {\n    if (!isValid(mark) || !isValid(style)) {\n      return;\n    }\n    mark.setStyle(this._convertMarkStyle(style), state, level);\n  }\n\n  initMarkStyleWithSpec(mark?: IMark, spec?: any) {\n    if (!isValid(mark) || !isValid(spec)) {\n      return;\n    }\n    const { style, state } = spec;\n    const newSpec = { ...spec };\n\n    if (style) {\n      newSpec.style = this._convertMarkStyle(style);\n    }\n    if (state) {\n      newSpec.state = {};\n      Object.keys(state).forEach(key => {\n        newSpec.state[key] = this._convertMarkStyle(state[key]);\n      });\n    }\n    mark.initStyleWithSpec(newSpec);\n  }\n\n  protected stateKeyToSignalName(key: string, opt?: string) {\n    let name = `${PREFIX}_${this.modelType}_${this.type}_${this.id}_${key}`;\n    opt && (name += `_${opt}`);\n    return name;\n  }\n\n  compileData() {\n    this._data?.compile();\n  }\n\n  compileMarks(group?: IGroup) {\n    this.getMarks().forEach(m => {\n      m.compile({ group });\n    });\n  }\n\n  protected _createMark<T extends IMark>(\n    markInfo: IModelMarkInfo,\n    option: Partial<IMarkOption> = {},\n    config?: ICompileMarkConfig\n  ): T {\n    const { type, name } = markInfo;\n    const { parent, ...others } = option;\n    const m = Factory.createMark(type as any, name, {\n      model: this,\n      map: this._option.map,\n      getCompiler: this.getCompiler,\n      globalScale: this._option.globalScale,\n      ...others\n    }) as T;\n\n    if (parent) {\n      parent.addMark(m);\n    } else {\n      this.getCompiler().addRootMark(m);\n    }\n\n    if (m) {\n      m.created();\n      config && m.setMarkConfig(config);\n    }\n    return m;\n  }\n\n  /**\n   * 数据唯一ID\n   * 根据自身动画数据匹配需求设置返回值。\n   * 默认返回 undefined 时，根据 VGrammar 默认数据 ID 进行索引和匹配。\n   */\n  protected _getDataIdKey(): string | ((datum: Datum) => string) | undefined {\n    return undefined;\n  }\n\n  getColorScheme() {\n    return this._option.getTheme?.('colorScheme');\n  }\n\n  getSpecInfo() {\n    const specInfo = this._option.getSpecInfo?.() ?? {};\n    return getProperty<IModelSpecInfo>(specInfo, this.getSpecInfoPath());\n  }\n\n  getSpecIndex() {\n    const path = this.getSpecPath();\n    if (!path?.length) {\n      return 0;\n    }\n    const index = Number(path[path.length - 1]);\n    if (isNaN(index)) {\n      return 0;\n    }\n    return index;\n  }\n\n  private _aniamtionStateCallback: (graphic: IMarkGraphic) => AnimationStateValues;\n\n  updateAnimateStateCallback(callback: (graphic: IMarkGraphic) => AnimationStateValues) {\n    this._aniamtionStateCallback = callback;\n  }\n\n  getAnimationStateCallback() {\n    return this._aniamtionStateCallback;\n  }\n}\n"]}