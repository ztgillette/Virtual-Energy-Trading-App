{"version":3,"sources":["../src/animation/utils.ts"],"names":[],"mappings":"AAUA,OAAO,EAAE,UAAU,EAAE,aAAa,EAAE,MAAM,cAAc,CAAC;AACzD,OAAO,EAAE,kBAAkB,EAAE,MAAM,kBAAkB,CAAC;AACtD,OAAO,EAAE,wBAAwB,EAAE,MAAM,UAAU,CAAC;AACpD,OAAO,EAAE,SAAS,EAAE,OAAO,EAAE,QAAQ,EAAE,OAAO,EAAE,MAAM,kBAAkB,CAAC;AAEzE,OAAO,EAAE,SAAS,EAAE,MAAM,4BAA4B,CAAC;AAOvD,MAAM,CAAC,MAAM,eAAe,GAAG,CAAC,GAAG,MAAM,CAAC,IAAI,CAAC,wBAAwB,CAAC,EAAE,QAAQ,CAAC,CAAC;AAEpF,MAAM,UAAU,eAAe,CAC7B,gBAAmC,EAAE,EACrC,UAEC,EACD,MAGC;IAED,MAAM,MAAM,GAAG,EAAuB,CAAC;IACvC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,eAAe,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;QAC/C,MAAM,KAAK,GAAG,eAAe,CAAC,CAAC,CAAC,CAAC;QACjC,MAAM,eAAe,GAAG,UAAU,CAAC,CAAC,CAAE,UAAkB,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC;QAE5E,IAAI,eAAe,KAAK,KAAK,EAAE;YAC7B,SAAS;SACV;QAED,IAAI,KAAK,KAAK,QAAQ,EAAE;YACtB,eAAe,IAAI,CAAC,MAAM,CAAC,MAAM,GAAG,eAAuC,CAAC,CAAC;YAC7E,SAAS;SACV;aAAM,IAAI,KAAK,KAAK,OAAO,EAAE;YAC5B,IAAI,eAAe,KAAK,KAAK,EAAE;gBAC7B,MAAM,CAAC,KAAK,GAAG,CAAC,eAAe,aAAf,eAAe,cAAf,eAAe,GAAI,wBAAwB,CAAC,KAAK,CAAQ,CAAC;aAC3E;YACD,SAAS;SACV;QAED,IAAI,KAAK,KAAK,QAAQ,IAAI,CAAC,eAAe,IAAI,CAAE,aAAqB,CAAC,KAAK,CAAC,EAAE;YAE5E,SAAS;SACV;QAGD,IAAI,kBAAsC,CAAC;QAC3C,IAAI,OAAO,CAAE,aAAqB,CAAC,KAAK,CAAC,CAAC,EAAE;YAC1C,kBAAkB,GAAI,aAAqB,CAAC,KAAK,CAAuB,CAAC;SAC1E;aAAM;YACL,kBAAkB,GAAG,CAAC,gCAAM,wBAAgC,CAAC,KAAK,CAAC,GAAM,aAAqB,CAAC,KAAK,CAAC,CAAS,CAAC,CAAC;SACjH;QAGD,IAAI,KAAK,KAAK,MAAM,EAAE;YACpB,kBAAkB,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE;gBACtC,UAAU,CAAC,cAAc,GAAG,EAAE,mBAAmB,EAAE,IAAI,EAAE,CAAC;YAC5D,CAAC,CAAC,CAAC;SACJ;QAED,IAAI,CAAC,eAAe,EAAE;YACnB,MAAc,CAAC,KAAK,CAAC,GAAG,kBAAkB,CAAC;YAC5C,SAAS;SACV;QAGD,IAAI,WAA+B,CAAC;QACpC,IAAI,OAAO,CAAC,eAAe,CAAC,EAAE;YAC5B,WAAW,GAAG,eAAe,CAAC,GAAG,CAAC,CAAC,UAAU,EAAE,CAAC,EAAE,EAAE;;gBAClD,IAAI,YAAY,GAAqB,UAAU,CAAC;gBAEhD,IAAI,kBAAkB,CAAC,YAAY,CAAC,EAAE;oBAGpC,OAAQ,YAAoC,CAAC,IAAI,CAAC;iBACnD;gBACD,IAAI,YAAY,CAAC,QAAQ,EAAE;oBACzB,YAAY,GAAG,eAAe,CAC5B,YAAoC,EACpC,MAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,SAAS,mCAAI,gBAAgB,EACrC,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,SAAS,CAClB,CAAC;iBACH;gBACD,OAAO,YAAY,CAAC;YACtB,CAAC,CAAC,CAAC;SACJ;aAAM;YACL,WAAW,GAAG,kBAAkB,CAAC,GAAG,CAAC,CAAC,WAAW,EAAE,CAAC,EAAE,EAAE;;gBACtD,IAAI,YAAY,GAAqB,SAAS,CAAC,EAAE,EAAE,kBAAkB,CAAC,CAAC,CAAC,EAAE,eAAe,CAAqB,CAAC;gBAC/G,IAAI,kBAAkB,CAAC,YAAY,CAAC,EAAE;oBAGpC,OAAQ,YAAoC,CAAC,IAAI,CAAC;iBACnD;gBAED,IAAI,YAAY,CAAC,QAAQ,EAAE;oBACzB,YAAY,GAAG,eAAe,CAC5B,YAAoC,EACpC,MAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,SAAS,mCAAI,gBAAgB,EACrC,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,SAAS,CAClB,CAAC;iBACH;gBACD,OAAO,YAAY,CAAC;YACtB,CAAC,CAAC,CAAC;SACJ;QAEA,MAAc,CAAC,KAAK,CAAC,GAAG,WAAW,CAAC;KACtC;IACD,OAAO,MAAM,CAAC;AAChB,CAAC;AAED,MAAM,UAAU,mBAAmB,CACjC,QAAqC,EACrC,IAA+B,EAC/B,GAA+B;;IAE/B,MAAM,UAAU,GAEZ,EAAE,CAAC;IAEP,IAAI,OAAO,CAAC,IAAI,CAAC,eAAe,CAAC,EAAE;QACjC,UAAU,CAAC,MAAM,GAAG,MAAA,IAAI,CAAC,eAAe,CAAC,QAAQ,CAAC,mCAAI,IAAI,CAAC,eAAe,CAAC;KAC5E;IACD,IAAI,OAAO,CAAC,IAAI,CAAC,kBAAkB,CAAC,EAAE;QACpC,UAAU,CAAC,SAAS,GAAG,MAAA,IAAI,CAAC,kBAAkB,CAAC,QAAQ,CAAC,mCAAI,IAAI,CAAC,kBAAkB,CAAC;KACrF;IACD,IAAI,OAAO,CAAC,IAAI,CAAC,cAAc,CAAC,EAAE;QAChC,UAAU,CAAC,KAAK,GAAG,MAAA,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,mCAAI,IAAI,CAAC,cAAc,CAAC;KACzE;IACD,IAAI,OAAO,CAAC,IAAI,CAAC,aAAa,CAAC,EAAE;QAC/B,UAAU,CAAC,IAAI,GAAG,MAAA,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,mCAAI,IAAI,CAAC,aAAa,CAAC;KACtE;IACD,IAAI,OAAO,CAAC,IAAI,CAAC,eAAe,CAAC,EAAE;QACjC,UAAU,CAAC,MAAM,GAAG,MAAA,IAAI,CAAC,eAAe,CAAC,QAAQ,CAAC,mCAAI,IAAI,CAAC,eAAe,CAAC;KAC5E;IACD,IAAI,OAAO,CAAC,IAAI,CAAC,cAAc,CAAC,EAAE;QAChC,UAAU,CAAC,KAAK,GAAG,MAAA,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,mCAAI,IAAI,CAAC,cAAc,CAAC;KACzE;IACD,IAAI,IAAI,CAAC,eAAe,IAAI,IAAI,CAAC,eAAe,CAAC,QAAQ,CAAC,EAAE;QAC1D,UAAU,CAAC,MAAM,GAAG,IAAI,CAAC,eAAe,CAAC,QAAQ,CAAC,CAAC;KACpD;IAED,OAAO,sBAAsB,CAAC,UAAU,EAAE,GAAG,CAAC,CAAC;AACjD,CAAC;AAKD,SAAS,eAAe,CACtB,WAAiC,EACjC,SAA8C,EAC9C,SAAwB;IAExB,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE,KAAK,EAAE,UAAU,EAAE,GAAG,WAAW,CAAC;IAC9D,WAAW,CAAC,KAAK,GAAG,CAAC,KAAU,EAAE,CAAW,EAAE,MAAW,EAAE,EAAE;QAC3D,MAAM,KAAK,GAAG,SAAS,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;QACvC,MAAM,YAAY,GAAG,UAAU,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;QAChH,MAAM,SAAS,GAAG,UAAU,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,EAAE,CAAC,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;QACjG,IAAI,YAAY,GAAG,UAAU,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC;QAChF,IAAI,YAAY,KAAK,KAAK,EAAE;YAC1B,OAAO,SAAS,CAAC;SAClB;QACD,YAAY,GAAG,YAAY,KAAK,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,YAAY,CAAC;QACxD,OAAO,SAAS,GAAG,KAAK,GAAG,CAAC,YAAY,GAAG,YAAY,CAAC,CAAC;IAC3D,CAAC,CAAC;IACF,WAAW,CAAC,UAAU,GAAG,CAAC,KAAU,EAAE,CAAW,EAAE,MAAW,EAAE,EAAE;QAChE,MAAM,KAAK,GAAG,SAAS,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;QACvC,MAAM,YAAY,GAAG,UAAU,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;QAChH,MAAM,cAAc,GAAG,UAAU,CAAC,UAAU,CAAC;YAC3C,CAAC,CAAC,UAAU,CAAC,KAAK,EAAE,CAAC,EAAE,MAAM,CAAC;YAC9B,CAAC,CAAC,aAAa,CAAC,UAAU,CAAC;gBAC3B,CAAC,CAAC,UAAU;gBACZ,CAAC,CAAC,CAAC,CAAC;QACN,IAAI,YAAY,GAAG,UAAU,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC;QAChF,IAAI,YAAY,KAAK,KAAK,EAAE;YAC1B,OAAO,cAAc,CAAC;SACvB;QACD,MAAM,UAAU,GAAG,SAAS,CAAC,CAAC,CAAC,SAAS,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,GAAG,CAAC,CAAC;QAChE,YAAY,GAAG,YAAY,KAAK,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,YAAY,CAAC;QACxD,OAAO,cAAc,GAAG,CAAC,UAAU,GAAG,KAAK,CAAC,GAAG,CAAC,YAAY,GAAG,YAAY,CAAC,CAAC;IAC/E,CAAC,CAAC;IACF,OAAO,WAAW,CAAC,QAAQ,CAAC;IAC5B,OAAO,WAAW,CAAC;AACrB,CAAC;AAED,SAAS,gBAAgB,CAAC,KAAU,EAAE,OAAqB;;IACzD,OAAO,MAAA,KAAK,aAAL,KAAK,uBAAL,KAAK,CAAG,kBAAkB,CAAC,mCAAI,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC;AACrE,CAAC;AAED,MAAM,UAAU,iBAAiB,CAAC,IAAkD,EAAE,QAAgB;;IACpG,IAAI,IAAI,CAAC,SAAS,KAAK,KAAK,EAAE;QAC5B,OAAO,KAAK,CAAC;KACd;IAED,IAAI,CAAA,MAAA,IAAI,CAAC,KAAK,0CAAE,MAAM,MAAK,KAAK,EAAE;QAChC,OAAO,KAAK,CAAC;KACd;IAED,MAAM,sBAAsB,GAAG,CAAC,MAAA,MAAA,IAAI,CAAC,eAAe,0CAAG,QAAQ,CAAC,mCAAI,IAAI,CAAC,eAAe,CAAC,KAAK,KAAK,CAAC;IACpG,MAAM,sBAAsB,GAAG,CAAC,MAAA,MAAA,IAAI,CAAC,eAAe,0CAAG,QAAQ,CAAC,mCAAI,IAAI,CAAC,eAAe,CAAC,KAAK,KAAK,CAAC;IAEpG,IAAI,CAAC,sBAAsB,IAAI,CAAC,sBAAsB,EAAE;QACtD,OAAO,KAAK,CAAC;KACd;IAED,OAAO,IAAI,CAAC;AACd,CAAC;AAED,MAAM,UAAU,mBAAmB,CAAC,eAAiC;IACnE,OAAO,OAAO,CAAE,eAAsC,CAAC,UAAU,CAAC,CAAC;AACrE,CAAC;AAED,MAAM,UAAU,kBAAkB,CAAC,eAAiC;IAClE,OAAO,CAAC,mBAAmB,CAAC,eAAe,CAAC,IAAI,OAAO,CAAE,eAA0C,CAAC,OAAO,CAAC,CAAC;AAC/G,CAAC;AAED,MAAM,UAAU,sBAAsB,CACpC,MAAqH,EACrH,GAA+B;IAE/B,IAAI,CAAC,MAAM,EAAE;QACX,OAAO,MAAM,CAAC;KACf;IACD,MAAM,WAAW,GAAG,CAAC,QAAQ,EAAE,kBAAkB,CAAC,CAAC;IACnD,MAAM,GAAG,SAAS,CAAC,MAAM,EAAE,IAAI,EAAE,WAAW,CAAC,CAAC;IAC9C,YAAY,CACV,MAAM,EACN,CAAC,IAAS,EAAE,EAAE;;QAGZ,IAAI,UAAU,CAAC,IAAI,CAAC,IAAI,CAAA,MAAA,IAAI,CAAC,SAAS,0CAAE,WAAW,MAAK,IAAI,EAAE;YAC5D,MAAM,IAAI,GAAG,CAAC,GAAG,IAAS,EAAE,EAAE;gBAC5B,OAAO,IAAI,CAAC,GAAG,IAAI,EAAE,GAAG,CAAC,CAAC;YAC5B,CAAC,CAAC;YACF,OAAO,IAAI,CAAC;SACb;QACD,OAAO,IAAI,CAAC;IACd,CAAC,EACD,WAAW,CACZ,CAAC;IAEF,OAAO,MAAM,CAAC;AAChB,CAAC;AAED,SAAS,YAAY,CAAC,IAAS,EAAE,SAAmD,EAAE,cAAwB,EAAE;IAC9G,IAAI,OAAO,CAAC,IAAI,CAAC,EAAE;QACjB,IAAI,CAAC,OAAO,CAAC,CAAC,CAAM,EAAE,KAAa,EAAE,EAAE;YACrC,IAAI,CAAC,KAAK,CAAC,GAAG,SAAS,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,KAAK,CAAC,CAAC;YAC5C,YAAY,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,SAAS,EAAE,WAAW,CAAC,CAAC;QACpD,CAAC,CAAC,CAAC;KACJ;SAAM,IAAI,QAAQ,CAAC,IAAI,CAAC,EAAE;QACzB,KAAK,MAAM,GAAG,IAAI,IAAI,EAAE;YACtB,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;gBAC9B,IAAI,CAAC,GAAG,CAAC,GAAG,SAAS,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,GAAG,CAAC,CAAC;gBACtC,YAAY,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,SAAS,EAAE,WAAW,CAAC,CAAC;aACjD;SACF;KACF;AACH,CAAC;AAED,MAAM,UAAU,2BAA2B,CAAC,MAAe;;IACzD,MAAM,UAAU,GAAG,MAAM,CAAC,OAAO,EAAE,CAAC;IAEpC,IAAI,UAAU,CAAC,SAAS,KAAK,KAAK,EAAE;QAClC,OAAO,KAAK,CAAC;KACd;IAED,IAAI,CAAA,MAAA,MAAA,MAAM,CAAC,SAAS,EAAE,0CAAE,cAAc,0CAAE,iBAAiB,EAAE,MAAK,KAAK,EAAE;QACrE,OAAO,KAAK,CAAC;KACd;IAMD,IAAI,kBAAkB,GAAG,MAAA,UAAU,CAAC,kBAAkB,mCAAI,MAAM,CAAC,gBAAgB,CAAC;IAIlF,MAAA,MAAM,CAAC,QAAQ,EAAE,0CAAE,OAAO,CAAC,CAAC,CAAC,EAAE;QAC7B,MAAM,MAAM,GAAG,CAAC,CAAC,aAAa,EAAE,CAAC;QACjC,IAAI,MAAM,EAAE;YACV,IAAI,MAAM,CAAC,KAAK,IAAI,MAAM,CAAC,cAAc,EAAE;gBACzC,kBAAkB,GAAG,IAAI,CAAC,GAAG,CAAC,kBAAkB,EAAE,MAAM,CAAC,cAAc,CAAC,CAAC;aAC1E;YACD,IAAI,MAAM,CAAC,oBAAoB,EAAE;gBAC/B,kBAAkB,GAAG,IAAI,CAAC,GAAG,CAAC,kBAAkB,EAAE,MAAM,CAAC,oBAAoB,CAAC,CAAC;aAChF;SACF;IACH,CAAC,CAAC,CAAC;IAEH,IAAI,CAAA,MAAA,MAAA,MAAM,CAAC,UAAU,EAAE,0CAAE,UAAU,0CAAE,MAAM,KAAI,kBAAkB,EAAE;QACjE,OAAO,KAAK,CAAC;KACd;IAED,OAAO,IAAI,CAAC;AACd,CAAC","file":"utils.js","sourcesContent":["import type {\n  MarkAnimationSpec,\n  IAnimationState,\n  IAnimationConfig,\n  ChannelAnimationConfig,\n  IAnimationTypeConfig,\n  IAnimationTimeline,\n  TypeAnimationConfig\n} from './interface';\nimport type { IStateAnimateSpec, IAnimationSpec } from './spec';\nimport { isFunction, isValidNumber } from '../util/type';\nimport { DEFAULT_DATA_INDEX } from '../constant/data';\nimport { DEFAULT_ANIMATION_CONFIG } from './config';\nimport { cloneDeep, isArray, isObject, isValid } from '@visactor/vutils';\nimport type { SeriesMarkNameEnum } from '../series/interface/type';\nimport { mergeSpec } from '@visactor/vutils-extension';\nimport type { ISeries } from '../series';\nimport type { ISeriesSpec } from '../typings';\nimport type { IModelMarkAttributeContext } from '../compile/mark';\nimport type { IGraphic } from '@visactor/vrender-core';\nimport type { IMarkGraphic } from '../core';\n\nexport const AnimationStates = [...Object.keys(DEFAULT_ANIMATION_CONFIG), 'normal'];\n\nexport function animationConfig<Preset extends string>(\n  defaultConfig: MarkAnimationSpec = {},\n  userConfig?: Partial<\n    Record<IAnimationState, boolean | IStateAnimateSpec<Preset> | IAnimationConfig | IAnimationConfig[]>\n  >,\n  params?: {\n    dataIndex: (datum: any, params: any) => number;\n    dataCount: () => number;\n  }\n) {\n  const config = {} as MarkAnimationSpec;\n  for (let i = 0; i < AnimationStates.length; i++) {\n    const state = AnimationStates[i];\n    const userStateConfig = userConfig ? (userConfig as any)[state] : undefined;\n\n    if (userStateConfig === false) {\n      continue;\n    }\n\n    if (state === 'normal') {\n      userStateConfig && (config.normal = userStateConfig as IAnimationTypeConfig);\n      continue;\n    } else if (state === 'state') {\n      if (userStateConfig !== false) {\n        config.state = (userStateConfig ?? DEFAULT_ANIMATION_CONFIG.state) as any;\n      }\n      continue;\n    }\n\n    if (state !== 'update' && !userStateConfig && !(defaultConfig as any)[state]) {\n      // no user config and default config\n      continue;\n    }\n\n    // 开始处理默认动画逻辑\n    let defaultStateConfig: IAnimationConfig[];\n    if (isArray((defaultConfig as any)[state])) {\n      defaultStateConfig = (defaultConfig as any)[state] as IAnimationConfig[];\n    } else {\n      defaultStateConfig = [{ ...(DEFAULT_ANIMATION_CONFIG as any)[state], ...(defaultConfig as any)[state] } as any];\n    }\n    // FIXME: 用来控制当动画状态发生变更时是否清除正在执行的动画。\n    // 现在 vrender 对于同一个视觉通道的 tween 不会做覆盖的处理。若不做动画清空同时 exit 动画比 update 动画时间长的情况下，效果会不正确\n    if (state === 'exit') {\n      defaultStateConfig.forEach(exitConfig => {\n        exitConfig.controlOptions = { stopWhenStateChange: true };\n      });\n    }\n\n    if (!userStateConfig) {\n      (config as any)[state] = defaultStateConfig;\n      continue;\n    }\n\n    // 开始处理用户配置的动画逻辑\n    let stateConfig: IAnimationConfig[];\n    if (isArray(userStateConfig)) {\n      stateConfig = userStateConfig.map((userConfig, i) => {\n        let singleConfig: IAnimationConfig = userConfig;\n        // not merge default config when user animation config is array\n        if (isChannelAnimation(singleConfig)) {\n          // `type` and `channel` is conflict, and `type` has a higher priority.\n          // here if user configured `channel`, we should remove `type` which will come from default animation config\n          delete (singleConfig as TypeAnimationConfig).type;\n        }\n        if (singleConfig.oneByOne) {\n          singleConfig = produceOneByOne(\n            singleConfig as IAnimationTypeConfig,\n            params?.dataIndex ?? defaultDataIndex,\n            params?.dataCount\n          );\n        }\n        return singleConfig;\n      });\n    } else {\n      stateConfig = defaultStateConfig.map((stateConfig, i) => {\n        let singleConfig: IAnimationConfig = mergeSpec({}, defaultStateConfig[i], userStateConfig) as IAnimationConfig;\n        if (isChannelAnimation(singleConfig)) {\n          // `type` and `channel` is conflict, and `type` has a higher priority.\n          // here if user configured `channel`, we should remove `type` which will come from default animation config\n          delete (singleConfig as TypeAnimationConfig).type;\n        }\n\n        if (singleConfig.oneByOne) {\n          singleConfig = produceOneByOne(\n            singleConfig as IAnimationTypeConfig,\n            params?.dataIndex ?? defaultDataIndex,\n            params?.dataCount\n          );\n        }\n        return singleConfig;\n      });\n    }\n\n    (config as any)[state] = stateConfig;\n  }\n  return config;\n}\n\nexport function userAnimationConfig<M extends string, Preset extends string>(\n  markName: SeriesMarkNameEnum | string,\n  spec: IAnimationSpec<M, Preset>,\n  ctx: IModelMarkAttributeContext\n) {\n  const userConfig: Partial<\n    Record<IAnimationState, boolean | IStateAnimateSpec<Preset> | IAnimationConfig | IAnimationConfig[]>\n  > = {};\n\n  if (isValid(spec.animationAppear)) {\n    userConfig.appear = spec.animationAppear[markName] ?? spec.animationAppear;\n  }\n  if (isValid(spec.animationDisappear)) {\n    userConfig.disappear = spec.animationDisappear[markName] ?? spec.animationDisappear;\n  }\n  if (isValid(spec.animationEnter)) {\n    userConfig.enter = spec.animationEnter[markName] ?? spec.animationEnter;\n  }\n  if (isValid(spec.animationExit)) {\n    userConfig.exit = spec.animationExit[markName] ?? spec.animationExit;\n  }\n  if (isValid(spec.animationUpdate)) {\n    userConfig.update = spec.animationUpdate[markName] ?? spec.animationUpdate;\n  }\n  if (isValid(spec.animationState)) {\n    userConfig.state = spec.animationState[markName] ?? spec.animationState;\n  }\n  if (spec.animationNormal && spec.animationNormal[markName]) {\n    userConfig.normal = spec.animationNormal[markName];\n  }\n\n  return uniformAnimationConfig(userConfig, ctx);\n}\n\n/**\n * oneByOne\n */\nfunction produceOneByOne(\n  stateConfig: IAnimationTypeConfig,\n  dataIndex: (datum: any, params: any) => number,\n  dataCount?: () => number\n) {\n  const { oneByOne, duration, delay, delayAfter } = stateConfig;\n  stateConfig.delay = (datum: any, g: IGraphic, params: any) => {\n    const index = dataIndex(datum, params);\n    const durationTime = isFunction(duration) ? duration(datum, g, params) : isValidNumber(duration) ? duration : 0;\n    const userDelay = isFunction(delay) ? delay(datum, g, params) : isValidNumber(delay) ? delay : 0;\n    let oneByOneTime = isFunction(oneByOne) ? oneByOne(datum, g, params) : oneByOne;\n    if (oneByOneTime === false) {\n      return userDelay;\n    }\n    oneByOneTime = oneByOneTime === true ? 0 : oneByOneTime;\n    return userDelay + index * (durationTime + oneByOneTime);\n  };\n  stateConfig.delayAfter = (datum: any, g: IGraphic, params: any) => {\n    const index = dataIndex(datum, params);\n    const durationTime = isFunction(duration) ? duration(datum, g, params) : isValidNumber(duration) ? duration : 0;\n    const userDelayAfter = isFunction(delayAfter)\n      ? delayAfter(datum, g, params)\n      : isValidNumber(delayAfter)\n      ? delayAfter\n      : 0;\n    let oneByOneTime = isFunction(oneByOne) ? oneByOne(datum, g, params) : oneByOne;\n    if (oneByOneTime === false) {\n      return userDelayAfter;\n    }\n    const indexCount = dataCount ? dataCount() : g.parent.count - 1;\n    oneByOneTime = oneByOneTime === true ? 0 : oneByOneTime;\n    return userDelayAfter + (indexCount - index) * (durationTime + oneByOneTime);\n  };\n  delete stateConfig.oneByOne;\n  return stateConfig;\n}\n\nfunction defaultDataIndex(datum: any, graphic: IMarkGraphic) {\n  return datum?.[DEFAULT_DATA_INDEX] ?? graphic.context.graphicIndex;\n}\n\nexport function shouldMarkDoMorph(spec: ISeriesSpec & IAnimationSpec<string, string>, markName: string) {\n  if (spec.animation === false) {\n    return false;\n  }\n\n  if (spec.morph?.enable === false) {\n    return false;\n  }\n\n  const appearAnimationEnabled = (spec.animationAppear?.[markName] ?? spec.animationAppear) !== false;\n  const updateAnimationEnabled = (spec.animationUpdate?.[markName] ?? spec.animationUpdate) !== false;\n\n  if (!appearAnimationEnabled || !updateAnimationEnabled) {\n    return false;\n  }\n\n  return true;\n}\n\nexport function isTimeLineAnimation(animationConfig: IAnimationConfig) {\n  return isValid((animationConfig as IAnimationTimeline).timeSlices);\n}\n\nexport function isChannelAnimation(animationConfig: IAnimationConfig) {\n  return !isTimeLineAnimation(animationConfig) && isValid((animationConfig as ChannelAnimationConfig).channel);\n}\n\nexport function uniformAnimationConfig<Preset extends string>(\n  config: Partial<Record<IAnimationState, boolean | IStateAnimateSpec<Preset> | IAnimationConfig | IAnimationConfig[]>>,\n  ctx: IModelMarkAttributeContext\n) {\n  if (!config) {\n    return config;\n  }\n  const excludeKeys = ['custom', 'customParameters'];\n  config = cloneDeep(config, null, excludeKeys);\n  traverseSpec(\n    config,\n    (node: any) => {\n      // 将函数转换为 vchart 代理的函数\n      // 这里可能会传自定义动画的构造函数，不能被代理\n      if (isFunction(node) && node.prototype?.constructor !== node) {\n        const name = (...args: any) => {\n          return node(...args, ctx);\n        };\n        return name;\n      }\n      return node;\n    },\n    excludeKeys\n  );\n\n  return config;\n}\n\nfunction traverseSpec(spec: any, transform: (node: any, key: string | number) => any, excludeKeys: string[] = []) {\n  if (isArray(spec)) {\n    spec.forEach((i: any, index: number) => {\n      spec[index] = transform(spec[index], index);\n      traverseSpec(spec[index], transform, excludeKeys);\n    });\n  } else if (isObject(spec)) {\n    for (const key in spec) {\n      if (!excludeKeys.includes(key)) {\n        spec[key] = transform(spec[key], key);\n        traverseSpec(spec[key], transform, excludeKeys);\n      }\n    }\n  }\n}\n\nexport function isAnimationEnabledForSeries(series: ISeries) {\n  const seriesSpec = series.getSpec();\n\n  if (seriesSpec.animation === false) {\n    return false;\n  }\n\n  if (series.getOption()?.globalInstance?.isAnimationEnable() === false) {\n    return false;\n  }\n\n  // if (!isValid(series.getRegion().animate)) {\n  //   return false;\n  // }\n\n  let animationThreshold = seriesSpec.animationThreshold ?? Number.MAX_SAFE_INTEGER;\n\n  // set mark stroke color follow series color\n  // only set normal state in the level lower than level Series\n  series.getMarks()?.forEach(m => {\n    const config = m.getMarkConfig();\n    if (config) {\n      if (config.large && config.largeThreshold) {\n        animationThreshold = Math.min(animationThreshold, config.largeThreshold);\n      }\n      if (config.progressiveThreshold) {\n        animationThreshold = Math.min(animationThreshold, config.progressiveThreshold);\n      }\n    }\n  });\n  // auto close animation\n  if (series.getRawData()?.latestData?.length >= animationThreshold) {\n    return false;\n  }\n\n  return true;\n}\n"]}