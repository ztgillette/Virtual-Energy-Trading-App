{"version":3,"sources":["../src/charts/sequence-scatter-kde/sequence-scatter-kde-transformer.ts"],"names":[],"mappings":"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","file":"sequence-scatter-kde-transformer.js","sourcesContent":["import { Datum } from '@visactor/vchart/src/typings';\nimport type { ISequenceScatterKDESpec } from './interface';\nimport { CommonChartSpecTransformer } from '@visactor/vchart';\nimport { Point } from './interface';\nimport { calculateKDE } from './utils';\n\nconst DATA_KEY = 'dataKey';\n\nexport class SequenceScatterKDEChartSpecTransformer extends CommonChartSpecTransformer<any> {\n  transformSpec(spec: any): void {\n    super.transformSpec(spec);\n    const dataSpecs = processSequenceData(spec as unknown as ISequenceScatterKDESpec);\n\n    spec.type = 'common';\n    spec.dataKey = DATA_KEY;\n    spec.data = dataSpecs[0].data;\n\n    spec.scales = [\n      {\n        id: 'colorScale',\n        type: 'ordinal',\n        specified: {\n          '0': 'rgb(150, 10, 100)',\n          '1': 'rgb(31, 119, 180)',\n          '2': 'rgb(255, 127, 14)',\n          '3': 'rgb(44, 160, 44)',\n          '4': 'rgb(214, 39, 40)',\n          '5': 'rgb(148, 103, 189)',\n          '6': 'rgb(140, 86, 75)',\n          '7': 'rgb(227, 119, 194)',\n          '8': 'rgb(127, 127, 127)',\n          '9': 'rgb(188, 189, 34)',\n          '10': 'rgb(23, 190, 207)'\n        }\n      },\n      {\n        id: 'brighterColorScale',\n        type: 'ordinal',\n        specified: {\n          '0': 'rgb(150, 10, 150)',\n          '1': 'rgb(31, 119, 230)',\n          '2': 'rgb(255, 127, 64)',\n          '3': 'rgb(44, 160, 94)',\n          '4': 'rgb(214, 39, 90)',\n          '5': 'rgb(148, 103, 239)',\n          '6': 'rgb(140, 86, 125)',\n          '7': 'rgb(227, 119, 244)',\n          '8': 'rgb(127, 127, 177)',\n          '9': 'rgb(188, 189, 84)',\n          '10': 'rgb(23, 190, 255)'\n        }\n      },\n      ...(spec.scales ?? [])\n    ];\n    spec.series = [\n      {\n        type: 'scatter',\n        dataIndex: 0,\n        xField: spec.xField,\n        yField: spec.yField,\n        seriesField: spec.seriesField,\n        size: 5,\n        point: {\n          zIndex: 1000,\n          style: {\n            fill: {\n              scale: 'colorScale',\n              field: spec.seriesField\n            }\n          }\n        }\n      }\n    ];\n    // spec.width = 800;\n    // spec.height = 500;\n\n    // 获取图元位置\n    const regionX = 54;\n    const regionY = 26;\n\n    spec.customMark = [\n      {\n        type: 'text',\n        dataIndex: 1,\n        style: {\n          text: (datum: Datum) => datum['iter'],\n          x: 10,\n          y: () => 10,\n          textBaseline: 'top',\n          textAlign: 'left',\n          fontSize: 25,\n          fontWeight: 'bolder',\n          fill: 'black',\n          fillOpacity: 0.2,\n          ...spec.infoLabel?.style\n        }\n      },\n      {\n        type: 'symbol',\n        dataIndex: 2,\n        style: {\n          symbolType: 'rect',\n          x: (datum: any, ctx: any) => {\n            // 获取region位置\n            // const regionStartPoint = ctx.chart.getAllRegions()[0].getLayoutStartPoint();\n            // const { x: regionX } = regionStartPoint;\n            // 获取图元位置\n            const valueToX = ctx.chart.getAllSeries()[0]._markAttributeContext.valueToX;\n            const markX = valueToX([datum.x]);\n            return regionX + markX;\n          },\n          y: (datum: any, ctx: any) => {\n            const valueToY = ctx.chart.getAllSeries()[0]._markAttributeContext.valueToY;\n            const markY = valueToY([datum.y]);\n            return markY + regionY;\n          },\n          size: 5,\n          fill: {\n            scale: 'brighterColorScale',\n            field: 'label'\n          },\n          fillOpacity: (datum: any) => datum.kde * 10\n        }\n      }\n    ];\n\n    spec.tooltip = {\n      visible: true,\n      fields: ['x', 'y', 'label']\n    };\n\n    if (spec.player) {\n      spec.player = {\n        ...spec.player,\n        specs: dataSpecs\n      };\n\n      spec.animationAppear = {\n        duration: spec.player?.duration ?? 2000,\n        easing: 'linear'\n      };\n\n      spec.animationUpdate = {\n        duration: spec.player?.duration ?? 2000,\n        easing: 'linear'\n      };\n    }\n\n    spec.axes = [\n      {\n        orient: 'left',\n        type: 'linear',\n        nice: true\n      },\n      {\n        orient: 'bottom',\n        type: 'linear',\n        nice: true,\n        label: { visible: true }\n      }\n    ];\n\n    super.transformSpec(spec);\n  }\n}\n\nexport function processSequenceData(spec: ISequenceScatterKDESpec) {\n  const result: any[] = [];\n  Object.keys(spec.data).forEach(iter => {\n    const currentData = spec.data[iter].map((d: Datum, i) => ({\n      ...(d as Point),\n      [DATA_KEY]: i\n    }));\n\n    const kdeResults = calculateKDE(currentData, 150);\n    result.push({\n      data: [\n        {\n          id: 'nodes',\n          values: currentData\n        },\n        {\n          id: 'iter',\n          values: [{ iter }]\n        },\n        {\n          id: 'kde',\n          values: kdeResults\n        }\n      ]\n    });\n  });\n  return result;\n}\n"]}