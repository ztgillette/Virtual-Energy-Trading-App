{"version":3,"sources":["../src/custom/disappear/base/DisappearAnimateBase.ts"],"names":[],"mappings":"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","file":"DisappearAnimateBase.js","sourcesContent":["import type { EasingType } from '@visactor/vrender-core';\nimport { vglobal } from '@visactor/vrender-core';\nimport { AStageAnimate } from '../../custom-animate';\n\n/**\n * 特效动画基类，提取公共的WebGL和Canvas 2D操作\n */\nexport abstract class DisappearAnimateBase<T = any> extends AStageAnimate<T> {\n  protected webglCanvas: HTMLCanvasElement | null = null;\n  protected gl: WebGLRenderingContext | null = null;\n  protected program: WebGLProgram | null = null;\n  protected currentAnimationRatio = 0;\n  protected animationTime = 0;\n\n  constructor(from: null, to: null, duration: number, easing: EasingType, params: any) {\n    super(from, to, duration, easing, params);\n  }\n\n  onUpdate(end: boolean, ratio: number, out: any): void {\n    super.onUpdate(end, ratio, out);\n    this.currentAnimationRatio = ratio;\n    this.animationTime = ratio * Math.PI * 2;\n  }\n\n  /**\n   * 获取基于动画进度的时间\n   */\n  protected getAnimationTime(): number {\n    if (this.currentAnimationRatio > 0) {\n      return this.animationTime;\n    }\n    return Date.now() / 1000.0;\n  }\n\n  /**\n   * 获取动画持续时间\n   */\n  protected getDurationFromParent(): number {\n    return this.duration || 1000;\n  }\n\n  /**\n   * 初始化WebGL上下文 - WebGL公共逻辑\n   */\n  protected initWebGL(canvas: HTMLCanvasElement): boolean {\n    try {\n      this.webglCanvas = vglobal.createCanvas({\n        width: canvas.width,\n        height: canvas.height,\n        dpr: vglobal.devicePixelRatio\n      });\n\n      if (!this.webglCanvas) {\n        console.warn('WebGL canvas creation failed');\n        return false;\n      }\n\n      this.webglCanvas.style.width = canvas.style.width || `${canvas.width}px`;\n      this.webglCanvas.style.height = canvas.style.height || `${canvas.height}px`;\n\n      let glContext: WebGLRenderingContext | null = null;\n      try {\n        glContext = this.webglCanvas.getContext('webgl') as WebGLRenderingContext;\n        if (!glContext) {\n          glContext = this.webglCanvas.getContext('experimental-webgl') as WebGLRenderingContext;\n        }\n      } catch (e) {\n        console.warn('Failed to get WebGL context:', e);\n      }\n\n      this.gl = glContext;\n      if (!this.gl) {\n        console.warn('WebGL not supported');\n        return false;\n      }\n\n      const shaders = this.getShaderSources();\n      this.program = this.createShaderProgram(shaders.vertex, shaders.fragment);\n      return this.program !== null;\n    } catch (error) {\n      console.warn('Failed to initialize WebGL:', error);\n      return false;\n    }\n  }\n\n  /**\n   * 创建着色器程序 - WebGL公共逻辑\n   */\n  protected createShaderProgram(vertexSource: string, fragmentSource: string): WebGLProgram | null {\n    if (!this.gl) {\n      return null;\n    }\n\n    const vertexShader = this.createShader(this.gl.VERTEX_SHADER, vertexSource);\n    const fragmentShader = this.createShader(this.gl.FRAGMENT_SHADER, fragmentSource);\n\n    if (!vertexShader || !fragmentShader) {\n      return null;\n    }\n\n    const program = this.gl.createProgram();\n    if (!program) {\n      return null;\n    }\n\n    this.gl.attachShader(program, vertexShader);\n    this.gl.attachShader(program, fragmentShader);\n    this.gl.linkProgram(program);\n\n    if (!this.gl.getProgramParameter(program, this.gl.LINK_STATUS)) {\n      console.error('Shader program link error:', this.gl.getProgramInfoLog(program));\n      return null;\n    }\n\n    return program;\n  }\n\n  /**\n   * 创建着色器 - WebGL公共逻辑\n   */\n  protected createShader(type: number, source: string): WebGLShader | null {\n    if (!this.gl) {\n      return null;\n    }\n\n    const shader = this.gl.createShader(type);\n    if (!shader) {\n      return null;\n    }\n\n    this.gl.shaderSource(shader, source);\n    this.gl.compileShader(shader);\n\n    if (!this.gl.getShaderParameter(shader, this.gl.COMPILE_STATUS)) {\n      console.error('Shader compile error:', this.gl.getShaderInfoLog(shader));\n      this.gl.deleteShader(shader);\n      return null;\n    }\n\n    return shader;\n  }\n\n  /**\n   * 设置WebGL视口和基本状态 - WebGL公共逻辑\n   */\n  protected setupWebGLState(canvas: HTMLCanvasElement): void {\n    if (!this.gl || !this.webglCanvas) {\n      return;\n    }\n\n    // 确保WebGL canvas尺寸正确\n    if (this.webglCanvas.width !== canvas.width || this.webglCanvas.height !== canvas.height) {\n      this.webglCanvas.width = canvas.width;\n      this.webglCanvas.height = canvas.height;\n    }\n\n    this.gl.viewport(0, 0, this.webglCanvas.width, this.webglCanvas.height);\n    this.gl.clearColor(0.0, 0.0, 0.0, 0.0);\n    this.gl.clear(this.gl.COLOR_BUFFER_BIT);\n  }\n\n  /**\n   * 创建标准的全屏四边形顶点缓冲区 - WebGL公共逻辑\n   */\n  protected createFullScreenQuad(): WebGLBuffer | null {\n    if (!this.gl) {\n      return null;\n    }\n\n    const vertices = new Float32Array([\n      // 位置      纹理坐标\n      -1,\n      -1,\n      0,\n      1, // 左下角 -> 左上角纹理\n      1,\n      -1,\n      1,\n      1, // 右下角 -> 右上角纹理\n      -1,\n      1,\n      0,\n      0, // 左上角 -> 左下角纹理\n      1,\n      1,\n      1,\n      0 // 右上角 -> 右下角纹理\n    ]);\n\n    const vertexBuffer = this.gl.createBuffer();\n    this.gl.bindBuffer(this.gl.ARRAY_BUFFER, vertexBuffer);\n    this.gl.bufferData(this.gl.ARRAY_BUFFER, vertices, this.gl.STATIC_DRAW);\n\n    return vertexBuffer;\n  }\n\n  /**\n   * 创建纹理 - WebGL公共逻辑\n   */\n  protected createTextureFromCanvas(canvas: HTMLCanvasElement): WebGLTexture | null {\n    if (!this.gl) {\n      return null;\n    }\n\n    const texture = this.gl.createTexture();\n    this.gl.activeTexture(this.gl.TEXTURE0); // 激活纹理单元0\n    this.gl.bindTexture(this.gl.TEXTURE_2D, texture);\n    this.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA, this.gl.RGBA, this.gl.UNSIGNED_BYTE, canvas);\n    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_S, this.gl.CLAMP_TO_EDGE);\n    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_T, this.gl.CLAMP_TO_EDGE);\n    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MIN_FILTER, this.gl.LINEAR);\n    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MAG_FILTER, this.gl.LINEAR);\n\n    return texture;\n  }\n\n  /**\n   * 设置顶点属性 - WebGL公共逻辑\n   */\n  protected setupVertexAttributes(): void {\n    if (!this.gl || !this.program) {\n      return;\n    }\n\n    const positionLocation = this.gl.getAttribLocation(this.program, 'a_position');\n    const texCoordLocation = this.gl.getAttribLocation(this.program, 'a_texCoord');\n\n    this.gl.enableVertexAttribArray(positionLocation);\n    this.gl.vertexAttribPointer(positionLocation, 2, this.gl.FLOAT, false, 16, 0);\n\n    this.gl.enableVertexAttribArray(texCoordLocation);\n    this.gl.vertexAttribPointer(texCoordLocation, 2, this.gl.FLOAT, false, 16, 8);\n  }\n\n  /**\n   * 创建Canvas 2D输出画布 - Canvas 2D公共逻辑\n   */\n  protected createOutputCanvas(\n    canvas: HTMLCanvasElement\n  ): { canvas: HTMLCanvasElement; ctx: CanvasRenderingContext2D } | null {\n    const outputCanvas = vglobal.createCanvas({\n      width: canvas.width,\n      height: canvas.height,\n      dpr: vglobal.devicePixelRatio\n    });\n    const ctx = outputCanvas.getContext('2d');\n    if (!ctx) {\n      return null;\n    }\n\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n    ctx.drawImage(canvas, 0, 0);\n\n    return { canvas: outputCanvas, ctx };\n  }\n\n  // 可选的抽象方法，由子类选择性实现\n  protected getShaderSources(): { vertex: string; fragment: string } | null {\n    // 默认返回null，表示不支持WebGL实现\n    return null;\n  }\n\n  protected applyWebGLEffect(canvas: HTMLCanvasElement): HTMLCanvasElement | null {\n    // 默认返回null，表示不支持WebGL实现\n    return null;\n  }\n\n  protected applyCanvas2DEffect(canvas: HTMLCanvasElement): HTMLCanvasElement | null {\n    // 默认返回null，表示不支持Canvas 2D实现\n    return null;\n  }\n\n  /**\n   * 检查是否支持WebGL实现\n   */\n  protected supportsWebGL(): boolean {\n    return this.getShaderSources() !== null;\n  }\n\n  /**\n   * 检查是否支持Canvas 2D实现\n   */\n  protected supportsCanvas2D(): boolean {\n    // 通过尝试调用来检查是否有实现\n    // 这里通过检查方法是否被重写来判断\n    return this.applyCanvas2DEffect !== DisappearAnimateBase.prototype.applyCanvas2DEffect;\n  }\n\n  /**\n   * 释放WebGL资源\n   */\n  release(): void {\n    super.release();\n\n    // 清理WebGL资源\n    if (this.gl) {\n      // 删除着色器程序\n      if (this.program) {\n        this.gl.deleteProgram(this.program);\n        this.program = null;\n      }\n\n      // WebGL上下文会在canvas被垃圾回收时自动清理\n      this.gl = null;\n    }\n\n    // 清理WebGL canvas\n    if (this.webglCanvas) {\n      this.webglCanvas = null;\n    }\n\n    // 重置动画状态\n    this.currentAnimationRatio = 0;\n    this.animationTime = 0;\n  }\n\n  protected afterStageRender(stage: any, canvas: HTMLCanvasElement): HTMLCanvasElement | void | null | false {\n    let result: HTMLCanvasElement | null = null;\n\n    // 优先尝试WebGL实现\n    if (this.supportsWebGL()) {\n      if (!this.gl && !this.initWebGL(canvas)) {\n        console.warn('WebGL初始化失败，尝试Canvas 2D回退');\n      }\n\n      if (this.gl) {\n        result = this.applyWebGLEffect(canvas);\n        if (result) {\n          return result;\n        }\n        console.warn('WebGL特效执行失败，尝试Canvas 2D回退');\n      }\n    }\n\n    // 尝试Canvas 2D实现\n    if (this.supportsCanvas2D()) {\n      result = this.applyCanvas2DEffect(canvas);\n      if (result) {\n        return result;\n      }\n      console.warn('Canvas 2D特效执行失败');\n    }\n\n    // 如果都不支持或都失败了，给出明确的错误信息\n    if (!this.supportsWebGL() && !this.supportsCanvas2D()) {\n      console.error(\n        `特效类 ${this.constructor.name} 未实现任何渲染方法。请实现 applyWebGLEffect 或 applyCanvas2DEffect 方法。`\n      );\n    }\n\n    // 返回原图作为最后的回退\n    return canvas;\n  }\n}\n"]}