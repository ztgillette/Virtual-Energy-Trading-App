{"version":3,"sources":["../src/canvas/contributions/taro/context.ts"],"names":[],"mappings":"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","file":"context.js","sourcesContent":["// 参考konva\nimport { injectable, createColor, getScaledStroke } from '@visactor/vrender-core';\nimport type {\n  ICommonStyleParams,\n  IContext2d,\n  ISetCommonStyleParams,\n  ISetStrokeStyleParams,\n  IStrokeStyleParams,\n  ITextStyleParams,\n  IConicalGradientData,\n  EnvType\n} from '@visactor/vrender-core';\nimport { BrowserContext2d } from '../browser';\nimport { getContextFont } from '@visactor/vutils';\n\n// 考虑taro-feishu等环境\ninterface ITTContext {\n  setFillStyle: (c: string | CanvasGradient) => void;\n  setStrokeStyle: (c: string | CanvasGradient) => void;\n  setGlobalAlpha: (alpha: number) => void;\n  setLineWidth: (width: number) => void;\n  setMiterLimit: (limit: number) => void;\n  setLineJoin: (lineJoin: string) => void;\n  setLineCap: (lineCap: string) => void;\n  setTextAlign: (align: string) => void;\n  setTextBaseline: (baseline: string) => void;\n  setLineDash: (lineDash: number[]) => void;\n  setFontSize: ((size: number) => void) & ((fontSize: number) => void);\n  font: string;\n}\n\n@injectable()\nexport class TaroContext2d extends BrowserContext2d implements IContext2d {\n  static env: EnvType = 'taro';\n\n  declare nativeContext: ITTContext;\n\n  declare _globalAlpha: number;\n\n  // feishu小程序无法正常获取到globalAlpha\n  get globalAlpha(): number {\n    return this._globalAlpha;\n  }\n  set globalAlpha(ga: number) {\n    this.nativeContext.setGlobalAlpha(ga);\n    this._globalAlpha = ga;\n  }\n\n  draw() {\n    const _context = this.nativeContext as any;\n    _context.draw();\n  }\n\n  strokeText(text: string, x: number, y: number) {\n    return;\n  }\n\n  _setCommonStyle(\n    params: ISetCommonStyleParams,\n    attribute: ICommonStyleParams,\n    // 用于渐变色\n    offsetX: number,\n    offsetY: number,\n    defaultParams?: ICommonStyleParams\n  ) {\n    const _context = this.nativeContext;\n    if (!defaultParams) {\n      defaultParams = this.fillAttributes;\n    }\n    const {\n      fillOpacity = defaultParams.fillOpacity,\n      opacity = defaultParams.opacity,\n      fill = defaultParams.fill\n    } = attribute;\n    if (fillOpacity > 1e-12 && opacity > 1e-12) {\n      _context.setGlobalAlpha(fillOpacity * opacity);\n      _context.setFillStyle(createColor(this, fill, params, offsetX, offsetY));\n      // todo 小程序\n    } else {\n      // _context.setGlobalAlpha(fillOpacity * opacity);\n    }\n  }\n\n  _setStrokeStyle(\n    params: ISetStrokeStyleParams,\n    attribute: IStrokeStyleParams,\n    // 用于渐变色\n    offsetX: number,\n    offsetY: number,\n    defaultParams?: IStrokeStyleParams\n  ) {\n    const _context = this.nativeContext;\n    if (!defaultParams) {\n      defaultParams = this.strokeAttributes;\n    }\n    const { strokeOpacity = defaultParams.strokeOpacity, opacity = defaultParams.opacity } = attribute;\n    if (strokeOpacity > 1e-12 && opacity > 1e-12) {\n      const {\n        lineWidth = defaultParams.lineWidth,\n        stroke = defaultParams.stroke,\n        lineJoin = defaultParams.lineJoin,\n        lineDash = defaultParams.lineDash,\n        lineDashOffset = defaultParams.lineDashOffset,\n        lineCap = defaultParams.lineCap,\n        miterLimit = defaultParams.miterLimit,\n        keepStrokeScale = defaultParams.keepStrokeScale\n      } = attribute;\n      _context.setGlobalAlpha(strokeOpacity * opacity);\n      _context.setLineWidth(keepStrokeScale ? lineWidth : getScaledStroke(this, lineWidth, this.dpr));\n      _context.setStrokeStyle(createColor(this, stroke as any, params, offsetX, offsetY));\n      _context.setLineJoin(lineJoin);\n      if (lineDash) {\n        _context.setLineDash(lineDash);\n        (_context as any).lineDashOffset = lineDashOffset;\n      }\n      _context.setLineCap(lineCap);\n      _context.setMiterLimit(miterLimit);\n    }\n  }\n  setTextStyleWithoutAlignBaseline(params: Partial<ITextStyleParams>, defaultParams?: ITextStyleParams) {\n    const _context = this.nativeContext;\n    if (!defaultParams) {\n      defaultParams = this.textAttributes;\n    }\n    if (params.font) {\n      _context.font = params.font;\n    } else {\n      _context.font = getContextFont(params, defaultParams);\n    }\n    _context.setFontSize(params.fontSize ?? defaultParams.fontSize);\n    // // 这里不使用defaultParams\n    // _context.textAlign = params.textAlign || 'left';\n    // _context.textBaseline = params.textBaseline || 'alphabetic';\n  }\n  setTextStyle(params: Partial<ITextStyleParams>, defaultParams?: ITextStyleParams) {\n    const _context = this.nativeContext;\n    if (!defaultParams) {\n      defaultParams = this.textAttributes;\n    }\n    if (params.font) {\n      _context.font = params.font;\n    } else {\n      _context.font = getContextFont(params, defaultParams);\n    }\n    _context.setTextAlign(params.textAlign ?? defaultParams.textAlign);\n    _context.setTextBaseline(params.textBaseline ?? defaultParams.textBaseline);\n  }\n  createConicGradient(x: number, y: number, startAngle: number, endAngle: number): IConicalGradientData {\n    return null;\n  }\n\n  createPattern(image: HTMLImageElement | HTMLCanvasElement | HTMLVideoElement, repetition: string): CanvasPattern {\n    return null;\n  }\n\n  getImageData(sx: number, sy: number, sw: number, sh: number): any {\n    const ctx = this.nativeContext as any;\n    const taro = ctx.taro;\n    if (!(ctx && taro)) {\n      return;\n    }\n    if (!ctx.getImageData && taro.canvasGetImageData) {\n      return new Promise((resolve, reject) => {\n        try {\n          taro.canvasGetImageData({\n            canvasId: this.canvas.nativeCanvas.id,\n            sx,\n            sy,\n            sw,\n            sh,\n            success(res: any) {\n              resolve(res);\n            }\n          });\n        } catch (err) {\n          reject(err);\n        }\n      });\n    }\n  }\n\n  createRadialGradient(x0: number, y0: number, r0: number, x1: number, y1: number, r1: number): CanvasGradient {\n    return (\n      (this.nativeContext as any).createCircularGradient &&\n      (this.nativeContext as any).createCircularGradient(x0, y0, r0, x1, y1, r1)\n    );\n  }\n}\n"]}