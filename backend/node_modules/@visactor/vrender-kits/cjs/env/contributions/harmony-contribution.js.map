{"version":3,"sources":["../src/env/contributions/harmony-contribution.ts"],"names":[],"mappings":"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","file":"harmony-contribution.js","sourcesContent":["import { injectable, BaseEnvContribution, RafBasedSTO } from '@visactor/vrender-core';\n// import { loadFeishuContributions } from '../../../kits';\nimport type {\n  ICanvasLike,\n  EnvType,\n  ICreateCanvasParams,\n  IEnvContribution,\n  IGlobal,\n  ILynxCanvas\n} from '@visactor/vrender-core';\nimport { CanvasWrapDisableWH, CanvasWrapEnableWH } from './canvas-wrap';\n\nfunction createCanvas(width: number, height: number, id?: string) {\n  // const context = new (OffscreenCanvasRenderingContext2D as any)(width, height);\n  // 浏览器debug\n  const _c = new OffscreenCanvas(width, height);\n  const context = _c.getContext('2d');\n\n  const nativeCanvas = {\n    width,\n    height,\n    context,\n    _c,\n    getBoundingClientRect() {\n      return {\n        width,\n        height\n      };\n    },\n    getContext() {\n      return context;\n    }\n  };\n  return new CanvasWrapDisableWH(nativeCanvas, context, 1, width, height, id);\n}\n\n@injectable()\nexport class HarmonyEnvContribution extends BaseEnvContribution implements IEnvContribution {\n  type: EnvType = 'harmony';\n  supportEvent: boolean = true;\n  rafSTO: RafBasedSTO;\n\n  constructor() {\n    super();\n    this.supportsTouchEvents = true;\n    try {\n      this.supportsPointerEvents = !!globalThis.PointerEvent;\n      this.supportsMouseEvents = !!globalThis.MouseEvent;\n    } catch (err) {\n      this.supportsPointerEvents = false;\n      this.supportsMouseEvents = false;\n    }\n    this.applyStyles = true;\n    this.rafSTO = new RafBasedSTO(0);\n  }\n\n  // TODO：VGrammar在小程序环境会重复调用setEnv传入canvas，所以每次configure并不会释放\n  // 这里等待后续和VGrammar沟通\n  configure(\n    service: IGlobal,\n    params: { domref: any; canvasIdLists: string[]; freeCanvasIdx: number; offscreen?: boolean; pixelRatio?: number }\n  ) {\n    if (service.env === this.type) {\n      service.setActiveEnvContribution(this);\n\n      // loadFeishuContributions();\n    }\n  }\n  /**\n   * 获取动态canvas的数量，offscreenCanvas或者framebuffer\n   */\n  getDynamicCanvasCount(): number {\n    return 9999;\n  }\n\n  /**\n   * 获取静态canvas的数量，纯粹canvas\n   */\n  getStaticCanvasCount(): number {\n    return 9999;\n  }\n\n  loadImage(url: string): Promise<{\n    loadState: 'success' | 'fail';\n    data: HTMLImageElement | ImageData | null;\n  }> {\n    return;\n  }\n\n  loadSvg(url: string): Promise<{\n    loadState: 'success' | 'fail';\n    data: HTMLImageElement | ImageData | null;\n  }> {\n    // 飞书小组件不支持DOMParser和URL.createObjectURL，无法解析svg字符串，可以通过url使用svg资源\n    return Promise.reject();\n  }\n\n  createCanvas(params: ICreateCanvasParams): ILynxCanvas {\n    return createCanvas(params.width, params.height, params.id);\n  }\n\n  createOffscreenCanvas(params: ICreateCanvasParams) {\n    return;\n  }\n\n  releaseCanvas(canvas: ICanvasLike | string) {\n    return;\n  }\n\n  getDevicePixelRatio(): number {\n    return 1;\n  }\n\n  getRequestAnimationFrame(): (callback: FrameRequestCallback) => number {\n    // return requestAnimationFrame;\n\n    // 飞书小组件，在云文档浏览器环境中，没有requestAnimationFrame\n    // 但是在小组件工作台环境和模拟器中正常\n    // 反馈飞书修改，目前先使用setTimeout模拟，进行测试，飞书修复后替换回requestAnimationFrame\n    // return function (callback: FrameRequestCallback) {\n    //   return setTimeout(callback, 1000 / 60, true);\n    // } as any;\n    return (callback: FrameRequestCallback) => {\n      return this.rafSTO.call(callback);\n    };\n  }\n\n  getCancelAnimationFrame(): (h: number) => void {\n    return (h: number) => {\n      this.rafSTO.clear(h);\n    };\n  }\n\n  mapToCanvasPoint(event: any) {\n    if (event?.type?.startsWith('mouse')) {\n      return event;\n    }\n    return event;\n  }\n\n  addEventListener<K extends keyof DocumentEventMap>(\n    type: K,\n    listener: (this: Document, ev: DocumentEventMap[K]) => any,\n    options?: boolean | AddEventListenerOptions | undefined\n  ): void;\n  addEventListener(\n    type: string,\n    listener: EventListenerOrEventListenerObject,\n    options?: boolean | AddEventListenerOptions | undefined\n  ): void;\n  addEventListener(type: unknown, listener: unknown, options?: unknown): void {\n    return null;\n  }\n\n  removeEventListener<K extends keyof DocumentEventMap>(\n    type: K,\n    listener: (this: Document, ev: DocumentEventMap[K]) => any,\n    options?: boolean | EventListenerOptions | undefined\n  ): void;\n  removeEventListener(\n    type: string,\n    listener: EventListenerOrEventListenerObject,\n    options?: boolean | EventListenerOptions | undefined\n  ): void;\n  removeEventListener(type: unknown, listener: unknown, options?: unknown): void {\n    return null;\n  }\n\n  dispatchEvent(event: any): boolean {\n    return null;\n  }\n\n  // 只能索引canvas\n  getElementById(str: string): any | null {\n    return null;\n  }\n\n  getRootElement(): HTMLElement | null {\n    return null;\n  }\n\n  getDocument(): Document | null {\n    return null;\n  }\n\n  release(...params: any): void {\n    return;\n  }\n}\n"]}