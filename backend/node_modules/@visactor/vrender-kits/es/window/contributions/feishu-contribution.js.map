{"version":3,"sources":["../src/window/contributions/feishu-contribution.ts"],"names":[],"mappings":"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","file":"feishu-contribution.js","sourcesContent":["import {\n  inject,\n  injectable,\n  Generator,\n  BaseWindowHandlerContribution,\n  VGlobal,\n  ContainerModule,\n  WindowHandlerContribution\n} from '@visactor/vrender-core';\nimport type {\n  EnvType,\n  IGlobal,\n  IContext2d,\n  ICanvas,\n  IDomRectLike,\n  IWindowHandlerContribution,\n  IWindowParams\n} from '@visactor/vrender-core';\nimport type { IBoundsLike } from '@visactor/vutils';\nimport { FeishuCanvas } from '../../canvas/contributions/feishu';\n\nclass MiniAppEventManager {\n  addEventListener(type: string, func: EventListenerOrEventListenerObject) {\n    if (!type || !func) {\n      return;\n    }\n    this.cache[type] = this.cache[type] || {\n      listener: []\n    };\n    this.cache[type].listener.push(func);\n  }\n  removeEventListener(type: string, func: EventListenerOrEventListenerObject) {\n    if (!type || !func) {\n      return;\n    }\n    if (!this.cache[type]) {\n      return;\n    }\n    const index = this.cache[type].listener.findIndex((f: EventListenerOrEventListenerObject) => f === func);\n    if (index >= 0) {\n      this.cache[type].listener.splice(index, 1);\n    }\n  }\n  cleanEvent() {\n    this.cache = {};\n  }\n  cache: Record<string, { listener: EventListenerOrEventListenerObject[] }> = {};\n}\n\n@injectable()\nexport class FeishuWindowHandlerContribution\n  extends BaseWindowHandlerContribution\n  implements IWindowHandlerContribution\n{\n  static env: EnvType = 'feishu';\n  type: EnvType = 'feishu';\n\n  protected eventManager = new MiniAppEventManager();\n\n  canvas: ICanvas;\n  get container(): HTMLElement | null {\n    return null;\n  }\n\n  constructor(@inject(VGlobal) private readonly global: IGlobal) {\n    super();\n  }\n\n  getTitle(): string {\n    return this.canvas.id.toString();\n  }\n\n  getWH(): { width: number; height: number } {\n    return {\n      width: this.canvas.width / (this.canvas.dpr || 1),\n      height: this.canvas.height / (this.canvas.dpr || 1)\n    };\n  }\n\n  getXY(): { x: number; y: number } {\n    return { x: 0, y: 0 };\n  }\n\n  createWindow(params: IWindowParams): void {\n    // 如果没有传入canvas，那么就创建一个canvas\n    if (!params.canvas) {\n      this.createWindowByConfig(params);\n    } else {\n      this.createWindowByCanvas(params);\n    }\n  }\n  private createWindowByConfig(params: IWindowParams) {\n    // 创建canvas\n    const nativeCanvas = this.global.createCanvas({\n      width: params.width,\n      height: params.height\n    });\n\n    // 绑定\n    const options = {\n      width: params.width,\n      height: params.height,\n      dpr: params.dpr,\n      nativeCanvas,\n      id: Generator.GenAutoIncrementId().toString(),\n      canvasControled: false\n    };\n    this.canvas = new FeishuCanvas(options);\n  }\n  private createWindowByCanvas(params: IWindowParams) {\n    // 获取canvas\n    let canvas: HTMLCanvasElement | null;\n    if (typeof params.canvas === 'string') {\n      canvas = this.global.getElementById(params.canvas) as HTMLCanvasElement | null;\n      if (!canvas) {\n        throw new Error('canvasId 参数不正确，请确认canvas存在并插入dom');\n      }\n    } else {\n      canvas = params!.canvas as HTMLCanvasElement | null;\n    }\n\n    // 如果没有传入wh，或者是不受控制的canvas，那就用canvas的原始wh\n    let width = params.width;\n    let height = params.height;\n    if (width == null || height == null || !params.canvasControled) {\n      const data = canvas.getBoundingClientRect();\n      width = data.width;\n      height = data.height;\n    }\n    // 如果没有dpr，就使用canvas的原始dpr\n    let dpr = params.dpr;\n    if (dpr == null) {\n      dpr = canvas.width / width;\n    }\n    this.canvas = new FeishuCanvas({\n      width: width,\n      height: height,\n      dpr: dpr,\n      nativeCanvas: canvas,\n      canvasControled: params.canvasControled\n    });\n  }\n  releaseWindow(): void {\n    return;\n  }\n  resizeWindow(width: number, height: number): void {\n    return;\n  }\n  setDpr(dpr: number): void {\n    this.canvas.dpr = dpr;\n  }\n\n  getContext(): IContext2d {\n    return this.canvas.getContext();\n  }\n  getNativeHandler(): ICanvas {\n    return this.canvas;\n  }\n  getDpr(): number {\n    return this.canvas.dpr;\n  }\n\n  addEventListener<K extends keyof DocumentEventMap>(\n    type: K,\n    listener: (this: Document, ev: DocumentEventMap[K]) => any,\n    options?: boolean | AddEventListenerOptions\n  ): void;\n  addEventListener(type: string, listener: EventListenerOrEventListenerObject): void {\n    this.eventManager.addEventListener(type, listener);\n  }\n  removeEventListener<K extends keyof DocumentEventMap>(\n    type: K,\n    listener: (this: Document, ev: DocumentEventMap[K]) => any,\n    options?: boolean | EventListenerOptions\n  ): void;\n  removeEventListener(type: string, listener: EventListenerOrEventListenerObject): void {\n    this.eventManager.removeEventListener(type, listener);\n  }\n  dispatchEvent(event: any): boolean {\n    const { type } = event;\n    if (!this.eventManager.cache[type]) {\n      return false;\n    }\n\n    // hack for offsetX offsetY\n    if (event.changedTouches && event.changedTouches[0]) {\n      event.offsetX = event.changedTouches[0].x;\n      event.changedTouches[0].offsetX = event.changedTouches[0].x;\n      event.changedTouches[0].clientX = event.changedTouches[0].x;\n      event.offsetY = event.changedTouches[0].y;\n      event.changedTouches[0].offsetY = event.changedTouches[0].y;\n      event.changedTouches[0].clientY = event.changedTouches[0].y;\n    }\n    event.preventDefault = () => {\n      return;\n    };\n    event.stopPropagation = () => {\n      return;\n    };\n    if (this.eventManager.cache[type].listener) {\n      this.eventManager.cache[type].listener.forEach((f: EventListener) => {\n        f(event);\n      });\n    }\n    return true;\n  }\n\n  getStyle(): CSSStyleDeclaration | Record<string, any> {\n    return {};\n  }\n  setStyle(style: CSSStyleDeclaration | Record<string, any>) {\n    return;\n  }\n\n  getBoundingClientRect(): IDomRectLike {\n    const wh = this.getWH();\n    return {\n      x: 0,\n      y: 0,\n      width: wh.width,\n      height: wh.height,\n      left: 0,\n      top: 0,\n      right: 0,\n      bottom: 0\n    };\n  }\n\n  clearViewBox(color?: string): void {\n    const vb = this.viewBox;\n    const context = this.getContext();\n    const dpr = this.getDpr();\n    context.nativeContext.save();\n    (context.nativeContext as CanvasRenderingContext2D).setTransform(dpr, 0, 0, dpr, 0, 0);\n    context.clearRect(vb.x1, vb.y1, vb.x2 - vb.x1, vb.y2 - vb.y1);\n    if (color) {\n      context.fillStyle = color;\n      context.fillRect(vb.x1, vb.y1, vb.x2 - vb.x1, vb.y2 - vb.y1);\n    }\n    context.nativeContext.restore();\n  }\n}\n\nexport const feishuWindowModule = new ContainerModule(bind => {\n  // feishu\n  bind(FeishuWindowHandlerContribution).toSelf();\n  bind(WindowHandlerContribution)\n    .toDynamicValue(ctx => ctx.container.get(FeishuWindowHandlerContribution))\n    .whenTargetNamed(FeishuWindowHandlerContribution.env);\n});\n"]}