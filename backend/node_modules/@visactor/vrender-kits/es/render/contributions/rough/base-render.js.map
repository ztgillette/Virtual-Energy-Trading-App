{"version":3,"sources":["../src/render/contributions/rough/base-render.ts"],"names":[],"mappings":"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","file":"base-render.js","sourcesContent":["import type { IRenderService } from '@visactor/vrender-core';\nimport {\n  type IGraphicAttribute,\n  type IContext2d,\n  type IGraphic,\n  type IMarkAttribute,\n  type IThemeAttribute,\n  type IDrawContext,\n  type IGraphicRenderDrawParams,\n  type IGraphicRender,\n  CustomPath2D\n} from '@visactor/vrender-core';\nimport rough from 'roughjs';\nimport { RoughContext2d } from './context';\nimport { defaultRouthThemeSpec } from './config';\n\nexport abstract class RoughBaseRender {\n  canvasRenderer!: IGraphicRender;\n  drawShape(\n    graphic: IGraphic,\n    ctx: IContext2d,\n    x: number,\n    y: number,\n    drawContext: IDrawContext,\n    params?: IGraphicRenderDrawParams,\n    fillCb?: (\n      ctx: IContext2d,\n      markAttribute: Partial<IMarkAttribute & IGraphicAttribute>,\n      themeAttribute: IThemeAttribute\n    ) => boolean,\n    strokeCb?: (\n      ctx: IContext2d,\n      markAttribute: Partial<IMarkAttribute & IGraphicAttribute>,\n      themeAttribute: IThemeAttribute\n    ) => boolean\n  ): void {\n    if (this.canvasRenderer.drawShape) {\n      return this.canvasRenderer.drawShape(graphic, ctx, x, y, drawContext, params, fillCb, strokeCb);\n    }\n  }\n\n  doDraw(\n    graphic: IGraphic,\n    renderService: IRenderService,\n    drawContext: IDrawContext,\n    params?: IGraphicRenderDrawParams\n  ) {\n    const { context } = drawContext;\n    if (!context) {\n      return;\n    }\n    // 获取到原生canvas\n    const canvas = context.canvas.nativeCanvas;\n    const rc = rough.canvas(canvas);\n\n    // context.highPerformanceSave();\n\n    const customPath = new CustomPath2D();\n    const roughContext = new RoughContext2d(context, customPath);\n\n    context.save();\n    // 不管怎么样，都transform\n    context.transformFromMatrix(graphic.transMatrix, true);\n\n    const { fill, stroke, roughStyle = {}, lineWidth } = graphic.attribute as any;\n\n    const {\n      maxRandomnessOffset = defaultRouthThemeSpec.maxRandomnessOffset,\n      roughness = defaultRouthThemeSpec.roughness,\n      bowing = defaultRouthThemeSpec.bowing,\n      curveFitting = defaultRouthThemeSpec.curveFitting,\n      curveTightness = defaultRouthThemeSpec.curveTightness,\n      curveStepCount = defaultRouthThemeSpec.curveStepCount,\n      fillStyle = defaultRouthThemeSpec.fillStyle,\n      fillWeight = defaultRouthThemeSpec.fillWeight,\n      hachureAngle = defaultRouthThemeSpec.hachureAngle,\n      hachureGap = defaultRouthThemeSpec.hachureGap,\n      simplification = defaultRouthThemeSpec.simplification,\n      dashOffset = defaultRouthThemeSpec.dashOffset,\n      dashGap = defaultRouthThemeSpec.dashGap,\n      zigzagOffset = defaultRouthThemeSpec.zigzagOffset,\n      seed = defaultRouthThemeSpec.seed,\n      fillLineDash = defaultRouthThemeSpec.fillLineDash,\n      fillLineDashOffset = defaultRouthThemeSpec.fillLineDashOffset,\n      disableMultiStroke = defaultRouthThemeSpec.disableMultiStroke,\n      disableMultiStrokeFill = defaultRouthThemeSpec.disableMultiStrokeFill,\n      preserveVertices = defaultRouthThemeSpec.preserveVertices,\n      fixedDecimalPlaceDigits = defaultRouthThemeSpec.fixedDecimalPlaceDigits\n    } = roughStyle;\n\n    let rendered = false;\n    const doRender = () => {\n      if (rendered) {\n        return;\n      }\n      rendered = true;\n      const path = customPath.toString();\n      context.beginPath();\n      rc.path(path, {\n        fill,\n        stroke,\n        strokeWidth: lineWidth,\n        maxRandomnessOffset,\n        roughness,\n        bowing,\n        curveFitting,\n        curveTightness,\n        curveStepCount,\n        fillStyle,\n        fillWeight,\n        hachureAngle,\n        hachureGap,\n        simplification,\n        dashOffset,\n        dashGap,\n        zigzagOffset,\n        seed,\n        fillLineDash,\n        fillLineDashOffset,\n        disableMultiStroke,\n        disableMultiStrokeFill,\n        preserveVertices,\n        fixedDecimalPlaceDigits\n      });\n    };\n    this.canvasRenderer.drawShape(\n      graphic,\n      roughContext,\n      0,\n      0,\n      drawContext,\n      params,\n      () => {\n        doRender();\n        return false;\n      },\n      () => {\n        doRender();\n        return false;\n      }\n    );\n\n    context.restore();\n\n    // context.highPerformanceRestore();\n  }\n  reInit() {\n    this.canvasRenderer?.reInit();\n  }\n}\n"]}