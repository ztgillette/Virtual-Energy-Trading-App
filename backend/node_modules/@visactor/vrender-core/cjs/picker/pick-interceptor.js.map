{"version":3,"sources":["../src/picker/pick-interceptor.ts"],"names":[],"mappings":"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","file":"pick-interceptor.js","sourcesContent":["import type { IMatrix, IPointLike } from '@visactor/vutils';\nimport { Point } from '@visactor/vutils';\nimport { injectable } from '../common/inversify-lite';\nimport type {\n  IContext2d,\n  IGraphic,\n  IGroup,\n  IPickItemInterceptorContribution,\n  IPickParams,\n  IPickServiceInterceptorContribution,\n  IPickerService,\n  PickResult\n} from '../interface';\nimport { matrixAllocate } from '../allocator/matrix-allocate';\nimport { draw3dItem } from '../common/3d-interceptor';\nimport { getTheme } from '../graphic';\n\n@injectable()\nexport class ShadowPickServiceInterceptorContribution implements IPickServiceInterceptorContribution {\n  order: number = 1;\n  afterPickItem(\n    result: PickResult,\n    pickerService: IPickerService,\n    point: IPointLike,\n    pickParams: IPickParams,\n    params?: {\n      parentMatrix: IMatrix;\n    }\n  ): null | PickResult {\n    if (result.graphic) {\n      let g = result.graphic;\n      while (g.parent) {\n        g = g.parent;\n      }\n      if (g.shadowHost) {\n        result.params = {\n          shadowTarget: result.graphic\n        };\n        result.graphic = g.shadowHost;\n      }\n    }\n    return result;\n  }\n}\n\n/**\n * 影子节点拦截器，用于渲染影子节点\n */\n@injectable()\nexport class ShadowRootPickItemInterceptorContribution implements IPickItemInterceptorContribution {\n  order: number = 1;\n  afterPickItem(\n    graphic: IGraphic,\n    pickerService: IPickerService,\n    point: IPointLike,\n    pickParams: IPickParams,\n    params?: {\n      parentMatrix: IMatrix;\n    }\n  ): null | PickResult {\n    if (graphic.attribute.shadowRootIdx > 0 || !graphic.attribute.shadowRootIdx) {\n      return this._pickItem(graphic, pickerService, point, pickParams, params);\n    }\n    return null;\n  }\n\n  beforePickItem(\n    graphic: IGraphic,\n    pickerService: IPickerService,\n    point: IPointLike,\n    pickParams: IPickParams,\n    params?: {\n      parentMatrix: IMatrix;\n    }\n  ): null | PickResult {\n    if (graphic.attribute.shadowRootIdx < 0) {\n      return this._pickItem(graphic, pickerService, point, pickParams, params);\n    }\n    return null;\n  }\n\n  protected _pickItem(\n    graphic: IGraphic,\n    pickerService: IPickerService,\n    point: IPointLike,\n    pickParams: IPickParams,\n    params?: {\n      parentMatrix: IMatrix;\n    }\n  ): PickResult | null {\n    if (!graphic.shadowRoot) {\n      return null;\n    }\n    const { parentMatrix } = params || {};\n    if (!parentMatrix) {\n      return null;\n    }\n\n    const context = pickerService.pickContext;\n    context.highPerformanceSave();\n\n    const theme = (getTheme(graphic) as any)?.[graphic.type];\n    const { shadowPickMode = theme?.shadowPickMode } = graphic.attribute;\n    const g = graphic.shadowRoot;\n    const currentGroupMatrix = matrixAllocate.allocateByObj(parentMatrix);\n    const newPoint = new Point(\n      currentGroupMatrix.a * point.x + currentGroupMatrix.c * point.y + currentGroupMatrix.e,\n      currentGroupMatrix.b * point.x + currentGroupMatrix.d * point.y + currentGroupMatrix.f\n    );\n    // const transMatrix = graphic.transMatrix;\n    // currentGroupMatrix.multiply(\n    //   transMatrix.a,\n    //   transMatrix.b,\n    //   transMatrix.c,\n    //   transMatrix.d,\n    //   transMatrix.e,\n    //   transMatrix.f\n    // );\n\n    // currentGroupMatrix.transformPoint(newPoint, newPoint);\n    const result = pickerService.pickGroup(g, newPoint, currentGroupMatrix, pickParams);\n\n    context.highPerformanceRestore();\n\n    // 影子节点pick到group也算pick到graphic\n    if (!result.graphic && result.group && shadowPickMode === 'full') {\n      result.graphic = result.group;\n    }\n\n    return result;\n  }\n}\n\n@injectable()\nexport class InteractivePickItemInterceptorContribution implements IPickItemInterceptorContribution {\n  order: number = 1;\n\n  beforePickItem(\n    graphic: IGraphic,\n    pickerService: IPickerService,\n    point: IPointLike,\n    pickParams: IPickParams,\n    params?: {\n      parentMatrix: IMatrix;\n    }\n  ): null | PickResult {\n    const originGraphic = graphic.baseGraphic;\n    if (originGraphic && originGraphic.parent) {\n      const newPoint = new Point(point.x, point.y);\n      const context = pickerService.pickContext;\n      context.highPerformanceSave();\n      const parentMatrix = originGraphic.parent.globalTransMatrix;\n      parentMatrix.transformPoint(newPoint, newPoint);\n\n      const result = originGraphic.isContainer\n        ? pickerService.pickGroup(originGraphic, newPoint.clone(), parentMatrix, pickParams)\n        : pickerService.pickItem(originGraphic, newPoint.clone(), parentMatrix, pickParams);\n      context.highPerformanceRestore();\n      return result;\n    }\n    return null;\n  }\n}\n\n/**\n * 3d拦截器，用于渲染3d视角\n */\n@injectable()\nexport class Canvas3DPickItemInterceptor implements IPickItemInterceptorContribution {\n  // canvas?: ICanvas;\n  order: number = 1;\n\n  beforePickItem(\n    graphic: IGraphic,\n    pickerService: IPickerService,\n    point: IPointLike,\n    pickParams: IPickParams,\n    params?: {\n      parentMatrix: IMatrix;\n    }\n  ) {\n    if (!graphic.in3dMode || pickParams.in3dInterceptor) {\n      return null;\n    }\n\n    const context = pickerService.pickContext;\n    const stage = graphic.stage;\n    if (!(context && stage)) {\n      return null;\n    }\n    pickParams.in3dInterceptor = true;\n\n    // 使用3d模式渲染\n    context.save();\n    this.initCanvasCtx(context);\n    context.camera = stage.camera;\n\n    // 设置context的transform到上一个节点\n    if (graphic.isContainer) {\n      const result = draw3dItem(\n        context,\n        graphic,\n        () => {\n          return pickerService.pickGroup(graphic as IGroup, point, params.parentMatrix, pickParams);\n        },\n        pickParams\n      );\n\n      context.camera = null;\n\n      pickParams.in3dInterceptor = false;\n      context.restore();\n      return result;\n    }\n    context.restore();\n    return null;\n  }\n\n  initCanvasCtx(context: IContext2d) {\n    context.setTransformForCurrent();\n  }\n}\n"]}