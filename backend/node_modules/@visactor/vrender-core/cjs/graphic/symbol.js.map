{"version":3,"sources":["../src/graphic/symbol.ts"],"names":[],"mappings":"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","file":"symbol.js","sourcesContent":["import type { IAABBBounds } from '@visactor/vutils';\nimport { isArray } from '@visactor/vutils';\nimport type { ISymbol, ISymbolClass, ISymbolGraphicAttribute } from '../interface';\nimport { Graphic, GRAPHIC_UPDATE_TAG_KEY, NOWORK_ANIMATE_ATTR } from './graphic';\nimport { getTheme } from './theme';\nimport { application } from '../application';\nimport { CustomPath2D } from '../common/custom-path2d';\nimport { SYMBOL_NUMBER_TYPE } from './constants';\nimport { updateBoundsOfSymbolOuterBorder } from './graphic-service/symbol-outer-border-bounds';\n\nconst SYMBOL_UPDATE_TAG_KEY = ['symbolType', 'size', ...GRAPHIC_UPDATE_TAG_KEY];\n\n/**\n * symbol\n */\nexport class Symbol extends Graphic<ISymbolGraphicAttribute> implements ISymbol {\n  type: 'symbol' = 'symbol';\n\n  static NOWORK_ANIMATE_ATTR = {\n    symbolType: 1,\n    ...NOWORK_ANIMATE_ATTR\n  };\n\n  constructor(params: ISymbolGraphicAttribute = { symbolType: 'circle' }) {\n    super(params);\n    this.numberType = SYMBOL_NUMBER_TYPE;\n  }\n\n  protected _parsedPath?: ISymbolClass;\n\n  getParsedPath(): ISymbolClass {\n    if (this.shouldUpdateShape()) {\n      this._parsedPath = this.doUpdateParsedPath();\n      this.clearUpdateShapeTag();\n    }\n    return this._parsedPath as ISymbolClass;\n  }\n\n  getParsedPath2D(x = 0, y = 0, size = 1): Path2D | null {\n    let path: Path2D | null = null;\n    try {\n      path = new Path2D();\n    } catch (err) {\n      return null;\n    }\n    const parsedPath = this.getParsedPath();\n    if (!parsedPath) {\n      return null;\n    }\n    parsedPath.draw(path, size, x, y);\n  }\n\n  isValid(): boolean {\n    return super.isValid() && this._isValid();\n  }\n  private _isValid(): boolean {\n    const { size } = this.attribute;\n    return isArray(size) ? size.length === 2 && size.every(this._validNumber) : this._validNumber(size);\n  }\n\n  protected doUpdateParsedPath(): ISymbolClass {\n    const { symbolType = 'circle' } = this.attribute;\n    return super.parsePath(symbolType);\n  }\n\n  getGraphicTheme(): Required<ISymbolGraphicAttribute> {\n    return getTheme(this).symbol;\n  }\n\n  protected updateAABBBounds(\n    attribute: ISymbolGraphicAttribute,\n    symbolTheme: Required<ISymbolGraphicAttribute>,\n    aabbBounds: IAABBBounds,\n    full?: boolean\n  ) {\n    if (!this.updatePathProxyAABBBounds(aabbBounds)) {\n      full\n        ? this.updateSymbolAABBBoundsImprecise(attribute, symbolTheme, aabbBounds)\n        : this.updateSymbolAABBBoundsAccurate(attribute, symbolTheme, aabbBounds);\n    }\n\n    const { tb1, tb2 } = application.graphicService.updateTempAABBBounds(aabbBounds);\n\n    updateBoundsOfSymbolOuterBorder(attribute, symbolTheme, tb1);\n    aabbBounds.union(tb1);\n    tb1.setValue(tb2.x1, tb2.y1, tb2.x2, tb2.y2);\n\n    this.widthWithoutTransform = aabbBounds.x2 - aabbBounds.x1;\n    this.heightWithoutTransform = aabbBounds.y2 - aabbBounds.y1;\n    this.x1WithoutTransform = aabbBounds.x1;\n    this.y1WithoutTransform = aabbBounds.y1;\n\n    const { lineJoin = symbolTheme.lineJoin } = attribute;\n    application.graphicService.transformAABBBounds(attribute, aabbBounds, symbolTheme, lineJoin === 'miter', this);\n    return aabbBounds;\n  }\n\n  protected updateSymbolAABBBoundsImprecise(\n    attribute: ISymbolGraphicAttribute,\n    symbolTheme: Required<ISymbolGraphicAttribute>,\n    aabbBounds: IAABBBounds\n  ): IAABBBounds {\n    // 当做正方形计算\n    const { size = symbolTheme.size } = attribute;\n\n    if (isArray(size)) {\n      aabbBounds.set(-size[0] / 2, -size[1] / 2, size[0] / 2, size[1] / 2);\n    } else {\n      const halfWH = size / 2;\n\n      aabbBounds.set(-halfWH, -halfWH, halfWH, halfWH);\n    }\n\n    return aabbBounds;\n  }\n\n  protected updateSymbolAABBBoundsAccurate(\n    attribute: ISymbolGraphicAttribute,\n    symbolTheme: Required<ISymbolGraphicAttribute>,\n    aabbBounds: IAABBBounds\n  ): IAABBBounds {\n    const { size = symbolTheme.size } = attribute;\n\n    const symbolClass = this.getParsedPath();\n    symbolClass.bounds(size, aabbBounds);\n\n    return aabbBounds;\n  }\n\n  protected needUpdateTags(keys: string[]): boolean {\n    return super.needUpdateTags(keys, SYMBOL_UPDATE_TAG_KEY);\n  }\n  protected needUpdateTag(key: string): boolean {\n    return super.needUpdateTag(key, SYMBOL_UPDATE_TAG_KEY);\n  }\n\n  toCustomPath() {\n    const symbolInstance = this.getParsedPath();\n    const size = this.attribute.size;\n    const x = 0;\n    const y = 0;\n    const formattedSize = isArray(size) ? size : [size, size];\n\n    return symbolInstance.path\n      ? new CustomPath2D().fromCustomPath2D(symbolInstance.path, x, y, formattedSize[0], formattedSize[1])\n      : new CustomPath2D().fromString(symbolInstance.pathStr, x, y, formattedSize[0], formattedSize[1]);\n  }\n\n  clone() {\n    return new Symbol({ ...this.attribute });\n  }\n\n  getNoWorkAnimateAttr(): Record<string, number> {\n    return Symbol.NOWORK_ANIMATE_ATTR;\n  }\n}\n\nexport function createSymbol(attributes: ISymbolGraphicAttribute): ISymbol {\n  return new Symbol(attributes);\n}\n\n// addAttributeToPrototype(DefaultSymbolStyle, Symbol, PURE_STYLE_KEY);\n"]}