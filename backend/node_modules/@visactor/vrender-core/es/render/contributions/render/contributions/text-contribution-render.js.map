{"version":3,"sources":["../src/render/contributions/render/contributions/text-contribution-render.ts"],"names":[],"mappings":"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","file":"text-contribution-render.js","sourcesContent":["import type { IAABBBounds, IMatrix } from '@visactor/vutils';\nimport { isObject } from '@visactor/vutils';\nimport { BaseRenderContributionTime } from '../../../../common/enums';\nimport type {\n  IContext2d,\n  IDrawContext,\n  IGraphicAttribute,\n  IText,\n  ITextRenderContribution,\n  IThemeAttribute\n} from '../../../../interface';\nimport { DefaultBaseBackgroundRenderContribution } from './base-contribution-render';\nimport { boundsAllocate } from '../../../../allocator/bounds-allocate';\nimport { getTextBounds } from '../../../../graphic/bounds';\nimport { createRectPath } from '../../../../common/shape/rect';\n\nexport class DefaultTextBackgroundRenderContribution\n  extends DefaultBaseBackgroundRenderContribution\n  implements ITextRenderContribution\n{\n  time: BaseRenderContributionTime = BaseRenderContributionTime.beforeFillStroke;\n\n  drawShape(\n    graphic: IText,\n    context: IContext2d,\n    x: number,\n    y: number,\n    doFill: boolean,\n    doStroke: boolean,\n    fVisible: boolean,\n    sVisible: boolean,\n    graphicAttribute: Required<IGraphicAttribute>,\n    drawContext: IDrawContext,\n    fillCb?: (ctx: IContext2d, markAttribute: Partial<IGraphicAttribute>, themeAttribute: IThemeAttribute) => boolean,\n    strokeCb?: (ctx: IContext2d, markAttribute: Partial<IGraphicAttribute>, themeAttribute: IThemeAttribute) => boolean\n  ) {\n    const {\n      backgroundMode = graphicAttribute.backgroundMode,\n      backgroundFit = graphicAttribute.backgroundFit,\n      backgroundKeepAspectRatio = graphicAttribute.backgroundKeepAspectRatio\n    } = graphic.attribute;\n    let { background } = graphic.attribute;\n    if (!background) {\n      return;\n    }\n    let matrix: IMatrix;\n    const save = () => {\n      if (graphic.type === 'richtext') {\n        matrix = context.currentMatrix.clone();\n        context.restore();\n        context.save();\n        context.setTransformForCurrent();\n      }\n    };\n    const restore = () => {\n      if (graphic.type === 'richtext') {\n        context.restore();\n        context.save();\n        matrix && context.setTransformFromMatrix(matrix, true, 1);\n      }\n    };\n    save();\n    let b: IAABBBounds;\n    const shouldReCalBounds = isObject(background) && (background as any).background;\n    const onlyTranslate = graphic.transMatrix.onlyTranslate();\n    if (shouldReCalBounds) {\n      const _b = graphic.AABBBounds;\n      const x = ((background as any).x ?? _b.x1) + ((background as any).dx ?? 0);\n      const y = ((background as any).y ?? _b.y1) + ((background as any).dy ?? 0);\n      const w = (background as any).width ?? _b.width();\n      const h = (background as any).height ?? _b.height();\n      b = boundsAllocate.allocate(x, y, x + w, y + h);\n      background = (background as any).background;\n      if (!onlyTranslate) {\n        const w = b.width();\n        const h = b.height();\n        b.set(\n          ((background as any).x ?? 0) + ((background as any).dx ?? 0),\n          ((background as any).y ?? 0) + ((background as any).dy ?? 0),\n          w,\n          h\n        );\n      }\n    } else {\n      b = graphic.AABBBounds;\n      if (!onlyTranslate) {\n        b = getTextBounds({ ...graphic.attribute, angle: 0, scaleX: 1, scaleY: 1, x: 0, y: 0, dx: 0, dy: 0 }).clone();\n      }\n    }\n\n    if (graphic.backgroundImg && graphic.resources) {\n      const res = graphic.resources.get(background as any);\n      if (res.state !== 'success' || !res.data) {\n        restore();\n        return;\n      }\n\n      context.highPerformanceSave();\n      // 默认应用旋转\n      if (!onlyTranslate) {\n        // TODO 性能优化\n        // const _b = getTextBounds({ ...graphic.attribute, angle: 0, scaleX: 1, scaleY: 1, x: 0, y: 0, dx: 0, dy: 0 });\n        // b.copy(_b);\n      } else {\n        context.setTransformFromMatrix(graphic.parent.globalTransMatrix, true);\n      }\n\n      context.setCommonStyle(graphic, graphic.attribute, x, y, graphicAttribute);\n      this.doDrawImage(context, res.data, b, { backgroundMode, backgroundFit, backgroundKeepAspectRatio });\n      context.highPerformanceRestore();\n      context.setTransformForCurrent();\n    } else {\n      const { backgroundCornerRadius } = graphic.attribute;\n      context.highPerformanceSave();\n      context.setCommonStyle(graphic, graphic.attribute, x, y, graphicAttribute);\n      context.fillStyle = background as string;\n      if (backgroundCornerRadius) {\n        // 测试后，cache对于重绘性能提升不大，但是在首屏有一定性能损耗，因此rect不再使用cache\n        createRectPath(context, b.x1, b.y1, b.width(), b.height(), backgroundCornerRadius, true);\n        context.fill();\n      } else {\n        context.fillRect(b.x1, b.y1, b.width(), b.height());\n      }\n      context.highPerformanceRestore();\n    }\n\n    if (shouldReCalBounds) {\n      boundsAllocate.free(b);\n    }\n    restore();\n  }\n}\n\nexport const defaultTextBackgroundRenderContribution = new DefaultTextBackgroundRenderContribution();\n\n// @injectable()\n// export class DefaultTextPopTipRenderContribution\n//   extends DefaultBasePopTipRenderContribution\n//   implements ITextRenderContribution\n// {\n//   time: BaseRenderContributionTime = BaseRenderContributionTime.afterFillStroke;\n// }\n"]}