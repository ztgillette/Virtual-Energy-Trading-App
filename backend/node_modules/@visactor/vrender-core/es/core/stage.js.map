{"version":3,"sources":["../src/core/stage.ts"],"names":[],"mappings":"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","file":"stage.js","sourcesContent":["import type { IAABBBounds, IBounds, IBoundsLike, IMatrix } from '@visactor/vutils';\nimport { Bounds, Point, isString } from '@visactor/vutils';\nimport type {\n  IGraphic,\n  IExportType,\n  IStage,\n  IStageParams,\n  ILayer,\n  IColor,\n  IGlobal,\n  IOption3D,\n  ICamera,\n  vec3,\n  IDirectionLight,\n  ITicker,\n  IRenderService,\n  IPickerService,\n  IPluginService,\n  ISyncHook,\n  IDrawContext,\n  IWindow,\n  ILayerService,\n  ITimeline,\n  IOptimizeType,\n  LayerMode,\n  PickResult,\n  IPlugin,\n  IGraphicService,\n  IRenderServiceDrawParams\n} from '../interface';\nimport { VWindow } from './window';\nimport type { Layer } from './layer';\nimport { EventSystem } from '../event';\nimport { container } from '../container';\nimport { RenderService } from '../render';\nimport { Group } from '../graphic/group';\nimport { Theme } from '../graphic/theme';\nimport { PickerService } from '../picker/constants';\nimport { PluginService } from '../plugins/constants';\nimport { AutoRenderPlugin } from '../plugins/builtin-plugin/auto-render-plugin';\nimport { AutoRefreshPlugin } from '../plugins/builtin-plugin/auto-refresh-plugin';\nimport { IncrementalAutoRenderPlugin } from '../plugins/builtin-plugin/incremental-auto-render-plugin';\nimport { DirtyBoundsPlugin } from '../plugins/builtin-plugin/dirty-bounds-plugin';\nimport { SyncHook } from '../tapable';\nimport { LayerService } from './constants';\nimport { application } from '../application';\nimport { isBrowserEnv } from '../env-check';\nimport { Factory } from '../factory';\nimport { Graphic, GraphicService } from '../graphic';\n\nconst DefaultConfig = {\n  WIDTH: 500,\n  HEIGHT: 500,\n  X: 0,\n  Y: 0,\n  BACKGROUND: 'white'\n};\n\ntype IStageState = 'rendering' | 'normal';\n\n/**\n * Stage是一个舞台或一个视口，并不直接对应一个或多个Canvas，逻辑上和Canvas无关\n *\n * 1. Stage对应一个Canvas的整体，Stage的宽高即为Canvas的宽高\n * 2. Stage小于Canvas，Stage作为Canvas某个区域的视口，只管理这个区域\n * 3. 多图层时Stage的多个图层对应多个Canvas\n *\n * 原生环境下Stage可以拥有一个Window或者使用Window的一块区域\n *\n * 【注】如果希望获取完整的Canvas或窗口或者调整窗口信息，请使用Window模块\n */\nexport class Stage extends Group implements IStage {\n  declare parent: IStage | null;\n\n  declare state: IStageState;\n\n  private _background: string | IColor;\n  protected nextFrameRenderLayerSet: Set<Layer>;\n  protected willNextFrameRender: boolean;\n  protected _cursor: string;\n  renderCount: number;\n  dirtyBounds: IBounds | null;\n  option3d?: IOption3D;\n  declare light?: IDirectionLight;\n  declare camera?: ICamera;\n  declare renderStyle?: string;\n\n  declare hooks: {\n    beforeRender: ISyncHook<[IStage]>;\n    afterRender: ISyncHook<[IStage]>;\n    afterClearScreen: ISyncHook<[IRenderServiceDrawParams]>;\n    afterClearRect: ISyncHook<[IRenderServiceDrawParams]>;\n  };\n\n  set viewBox(b: IBoundsLike) {\n    this.window.setViewBox(b);\n  }\n  get viewBox(): IAABBBounds {\n    return this.window.getViewBox();\n  }\n\n  /**\n   * @deprecated 不建议使用\n   */\n  get x(): number {\n    return this.window.getViewBox().x1;\n  }\n  /**\n   * @deprecated 不建议使用\n   */\n  set x(x: number) {\n    const b = this.window.getViewBox();\n    b.translate(x - b.x1, 0);\n    this.window.setViewBox(b);\n  }\n  /**\n   * @deprecated 不建议使用\n   */\n  get y(): number {\n    return this.window.getViewBox().y1;\n  }\n  /**\n   * @deprecated 不建议使用\n   */\n  set y(y: number) {\n    const b = this.window.getViewBox();\n    b.translate(0, y - b.y1);\n    this.window.setViewBox(b);\n  }\n  get width(): number {\n    return this.window.width;\n  }\n  set width(w: number) {\n    this.resize(w, this.height);\n  }\n  get viewWidth(): number {\n    return this.window.getViewBox().width();\n  }\n  set viewWidth(w: number) {\n    this.resizeView(w, this.viewHeight);\n  }\n  get viewHeight(): number {\n    return this.window.getViewBox().height();\n  }\n  set viewHeight(h: number) {\n    this.resizeView(this.viewWidth, h);\n  }\n  get height(): number {\n    return this.window.height;\n  }\n  set height(h: number) {\n    this.resize(this.width, h);\n  }\n  get dpr(): number {\n    return this.window.dpr;\n  }\n  set dpr(r: number) {\n    this.setDpr(r);\n  }\n  get background(): string | IColor {\n    return this._background ?? DefaultConfig.BACKGROUND;\n  }\n  set background(b: string | IColor) {\n    this._background = b;\n  }\n  get defaultLayer(): ILayer {\n    return this.at(0) as unknown as ILayer;\n  }\n\n  protected _ticker: ITicker;\n\n  autoRender: boolean;\n  autoRefresh: boolean;\n  _enableLayout: boolean;\n  htmlAttribute: boolean | string | any;\n  reactAttribute: boolean | string | any;\n  increaseAutoRender: boolean;\n  view3dTranform: boolean;\n  readonly window: IWindow;\n  private readonly global: IGlobal;\n  readonly renderService: IRenderService;\n  protected pickerService?: IPickerService;\n  readonly pluginService: IPluginService;\n  readonly layerService: ILayerService;\n  readonly graphicService: IGraphicService;\n  private _eventSystem?: EventSystem;\n  private get eventSystem(): EventSystem {\n    return this._eventSystem;\n  }\n\n  protected _beforeRenderList: Array<(stage: IStage) => void>;\n  protected _afterRenderList: Array<(stage: IStage) => void>;\n  protected _afterClearScreen?: (drawParams: any) => void;\n  protected _afterClearRect?: (drawParams: any) => void;\n  // 0: 正常渲染, > 0: 跳过隐藏canvas的渲染, < 0: 禁止渲染\n  protected _skipRender?: number;\n  protected _afterNextRenderCbs?: ((stage: IStage) => void)[];\n  protected lastRenderparams?: Partial<IDrawContext>;\n\n  protected interactiveLayer?: ILayer;\n  protected supportInteractiveLayer: boolean;\n  protected timeline: ITimeline;\n\n  declare params: Partial<IStageParams>;\n\n  // 是否在render之前执行了tick，如果没有执行，尝试执行tick用来应用动画属性，避免动画过程中随意赋值然后又调用同步render导致属性的突变\n  // 第一次render不需要强行走动画\n  protected tickedBeforeRender: boolean = true;\n\n  // 随机分配一个rafId\n  readonly rafId: number;\n\n  get ticker() {\n    return this._ticker;\n  }\n\n  set ticker(ticker: ITicker) {\n    ticker.bindStage(this);\n    if (this._ticker) {\n      this._ticker.removeListener('tick', this.afterTickCb);\n    }\n    ticker.addTimeline(this.timeline);\n    this._ticker = ticker;\n    this._ticker.on('tick', this.afterTickCb);\n  }\n\n  /**\n   * 所有属性都具有默认值。\n   * Canvas为字符串或者Canvas元素，那么默认图层就会绑定到这个Canvas上\n   * 如果不传入Canvas，那么会新建一个Canvas，用户可以通过Window模块管理这个Canvas\n   * 1. 如果没有传入宽高，那么默认为canvas宽高，如果传入了宽高则stage使用传入宽高作为视口宽高\n   * @param params\n   */\n  constructor(params: Partial<IStageParams> = {}) {\n    super({});\n    this.params = params;\n    this.theme = new Theme();\n    this.hooks = {\n      beforeRender: new SyncHook(['stage']),\n      afterRender: new SyncHook(['stage']),\n      afterClearScreen: new SyncHook(['stage']),\n      afterClearRect: new SyncHook(['stage'])\n    };\n    this.global = application.global;\n    if (!this.global.env && isBrowserEnv()) {\n      // 如果是浏览器环境，默认设置env\n      this.global.setEnv('browser');\n    }\n    this.window = container.get<IWindow>(VWindow);\n    this.renderService = container.get<IRenderService>(RenderService);\n    this.pluginService = container.get<IPluginService>(PluginService);\n    this.layerService = container.get<ILayerService>(LayerService);\n    this.graphicService = container.get<IGraphicService>(GraphicService);\n    this.pluginService.active(this, params);\n    this._beforeRenderList = [];\n    this._afterRenderList = [];\n\n    this.window.create({\n      width: params.width,\n      height: params.height,\n      viewBox: params.viewBox,\n      container: params.container,\n      dpr: params.dpr || this.global.devicePixelRatio,\n      canvasControled: params.canvasControled !== false,\n      title: params.title || '',\n      canvas: params.canvas\n    });\n\n    this.state = 'normal';\n    this.renderCount = 0;\n    this.tryInitEventSystem();\n    // // 没有传入xy就默认为0\n    // this._x = params.x ?? DefaultConfig.X;\n    // this._y = params.y ?? DefaultConfig.Y;\n    // // 没有传入view的宽高则默认为window的宽高\n    // this._viewWidth = params.viewWidth ?? this.window.width;\n    // this._viewHeight = params.viewHeight ?? this.window.height;\n    // this._AABBBounds.set(this._x, this._y, this._viewWidth + this._x, this._viewHeight + this._y);\n    // 背景色默认为纯白色\n    this._background = params.background ?? DefaultConfig.BACKGROUND;\n\n    // 创建一个默认layer图层\n    // this.appendChild(new Layer(this, this.global, this.window, { main: true }));\n    this.appendChild(this.layerService.createLayer(this, { main: true }));\n\n    this.nextFrameRenderLayerSet = new Set();\n    this.willNextFrameRender = false;\n    this.stage = this;\n    this.renderStyle = params.renderStyle;\n\n    // this.autoRender = params.autoRender;\n    if (params.autoRender) {\n      this.enableAutoRender();\n    }\n    if (params.autoRefresh) {\n      this.enableAutoRefresh();\n    }\n    // 默认不开启dirtyBounds\n    if (params.disableDirtyBounds === false) {\n      this.enableDirtyBounds();\n    }\n\n    if (params.enableHtmlAttribute) {\n      this.enableHtmlAttribute(params.enableHtmlAttribute);\n    }\n    if (params.ReactDOM) {\n      this.enableReactAttribute(params.ReactDOM);\n    }\n\n    params.enableLayout && this.enableLayout();\n    this.hooks.beforeRender.tap('constructor', this.beforeRender);\n    this.hooks.afterRender.tap('constructor', this.afterRender);\n    if (params.beforeRender) {\n      this._beforeRenderList.push(params.beforeRender);\n    }\n    if (params.afterRender) {\n      this._afterRenderList.push(params.afterRender);\n    }\n    this.hooks.afterClearScreen.tap('constructor', this.afterClearScreen);\n    this.hooks.afterClearRect.tap('constructor', this.afterClearRect);\n    this._afterClearScreen = params.afterClearScreen;\n    this._afterClearRect = params.afterClearRect;\n    this.supportInteractiveLayer = params.interactiveLayer !== false;\n    if (!params.optimize) {\n      params.optimize = {\n        tickRenderMode: 'effect'\n      };\n    }\n    this.optmize(params.optimize);\n    // 如果背景是图片，触发加载图片操作\n    if (params.background && isString(this._background) && this._background.includes('/')) {\n      this.setAttributes({ background: this._background });\n    }\n\n    this.initAnimate(params);\n    this.rafId = params.rafId ?? Math.floor(Math.random() * 6);\n  }\n\n  initAnimate(params: Partial<IStageParams>) {\n    if ((this as any).createTicker && (this as any).createTimeline) {\n      this._ticker = params.ticker || (this as any).createTicker(this);\n      this._ticker.bindStage(this);\n      if (this.params.optimize?.tickRenderMode === 'performance') {\n        this._ticker.setFPS(30);\n      }\n      this.timeline = (this as any).createTimeline();\n      this._ticker.addTimeline(this.timeline);\n      this._ticker.on('tick', this.afterTickCb);\n    }\n  }\n\n  startAnimate() {\n    if (this._ticker && this.timeline) {\n      this._ticker.start();\n      this.timeline.resume();\n    }\n  }\n\n  pauseRender(sr: number = -1) {\n    this._skipRender = sr;\n  }\n\n  resumeRender() {\n    this._skipRender = 0;\n  }\n\n  protected tryInitEventSystem() {\n    if (this.global.supportEvent && !this._eventSystem) {\n      this._eventSystem = new EventSystem({\n        targetElement: this.window,\n        resolution: this.window.dpr || this.global.devicePixelRatio,\n        rootNode: this as any,\n        global: this.global,\n        supportsPointerEvents: this.params.supportsPointerEvents,\n        supportsTouchEvents: this.params.supportsTouchEvents,\n        ...this.params.event\n      });\n    }\n  }\n\n  preventRender(prevent: boolean) {\n    if (prevent) {\n      this._skipRender = -Infinity;\n    } else {\n      // 判断是否需要outRange优化\n      if (this.params.optimize.skipRenderWithOutRange !== false) {\n        this._skipRender = this.window.isVisible() ? 0 : 1;\n      } else {\n        this._skipRender = 0;\n      }\n    }\n  }\n\n  // 优化策略\n  optmize(params: IOptimizeType) {\n    this.optmizeRender(params.skipRenderWithOutRange);\n    this.params.optimize = params;\n  }\n\n  // 优化渲染\n  protected optmizeRender(skipRenderWithOutRange: boolean = false) {\n    if (!skipRenderWithOutRange) {\n      return;\n    }\n    // 不在视口内的时候，跳过渲染\n    this._skipRender = this._skipRender < 0 ? this._skipRender : this.window.isVisible() ? 0 : 1;\n    this.window.onVisibleChange(this._onVisibleChange);\n  }\n\n  protected _onVisibleChange = (visible: boolean) => {\n    if (this._skipRender < 0) {\n      return;\n    }\n    if (visible) {\n      if (this.dirtyBounds) {\n        const b = this.window.getViewBox();\n        this.dirtyBounds.setValue(b.x1, b.y1, b.width(), b.height());\n      }\n      if (this._skipRender > 1) {\n        this.renderNextFrame();\n      }\n      this._skipRender = 0;\n    } else {\n      this._skipRender = 1;\n    }\n  };\n\n  getTimeline() {\n    return this.timeline;\n  }\n\n  get3dOptions(options: IOption3D) {\n    const {\n      center = { x: this.width / 2, y: this.height / 2, z: 0, dx: 0, dy: 0, dz: 0 },\n      light = {},\n      alpha = 0,\n      beta = 0,\n      camera,\n      fieldRatio = 1,\n      fieldDepth\n    } = options;\n\n    return {\n      ...options,\n      center,\n      light,\n      alpha,\n      beta,\n      camera,\n      fieldRatio,\n      fieldDepth\n    };\n  }\n\n  set3dOptions(options: IOption3D) {\n    this.option3d = options;\n    const options3d = this.get3dOptions(options);\n    const { light, center, camera, alpha, beta, fieldRatio, fieldDepth } = options3d;\n    const { dir = [1, 1, -1], color = 'white', ambient } = light;\n\n    const centerX = (center.x ?? this.width / 2) + (center.dx ?? 0);\n    const centerY = (center.y ?? this.height / 2) + (center.dy ?? 0);\n    const centerZ = (center.z ?? 0) + (center.dz ?? 0);\n    const centerVec3: vec3 = [centerX, centerY, centerZ];\n    const z = 1;\n    let cameraX = 0;\n    let cameraY = 0;\n    let cameraZ = 0;\n    if (!camera) {\n      cameraX = Math.sin(alpha) + centerX;\n      cameraY = Math.sin(beta) + centerY;\n      cameraZ = Math.cos(alpha) * Math.cos(beta) * z;\n    }\n\n    const DirectionalLight = Factory.getPlugin('DirectionalLight');\n\n    if (DirectionalLight) {\n      this.light = new DirectionalLight(dir, color, ambient);\n    }\n    const cameraParams = {\n      left: 0,\n      right: this.width,\n      top: 0,\n      bottom: this.height,\n      fieldRatio: fieldRatio,\n      fieldDepth,\n      viewParams: {\n        pos: [cameraX, cameraY, cameraZ] as vec3,\n        center: centerVec3,\n        up: [0, 1, 0] as vec3\n      }\n    };\n    if (this.camera) {\n      this.camera.params = cameraParams;\n    } else {\n      const OrthoCamera = Factory.getPlugin('OrthoCamera');\n      if (OrthoCamera) {\n        this.camera = new OrthoCamera(cameraParams);\n      }\n    }\n\n    if (options.enableView3dTransform) {\n      this.enableView3dTransform();\n    }\n  }\n\n  protected beforeRender = (stage: IStage) => {\n    this._beforeRenderList.forEach(cb => cb(stage));\n  };\n  protected afterClearScreen = (drawParams: any) => {\n    this._afterClearScreen && this._afterClearScreen(drawParams);\n  };\n  protected afterClearRect = (drawParams: any) => {\n    this._afterClearRect && this._afterClearRect(drawParams);\n  };\n\n  protected afterRender = (stage: IStage) => {\n    this.renderCount++;\n    this._afterRenderList.forEach(cb => cb(stage));\n    this._afterNextRenderCbs && this._afterNextRenderCbs.forEach(cb => cb(stage));\n    this._afterNextRenderCbs = null;\n    this.tickedBeforeRender = false;\n  };\n\n  protected afterTickCb = () => {\n    this.tickedBeforeRender = true;\n    // 性能模式不用立刻渲染\n    this.state !== 'rendering' && this.renderNextFrame();\n  };\n\n  setBeforeRender(cb: (stage: IStage) => void) {\n    this._beforeRenderList.push(cb);\n  }\n\n  removeBeforeRender(cb: (stage: IStage) => void) {\n    this._beforeRenderList = this._beforeRenderList.filter(c => c !== cb);\n  }\n\n  setAfterRender(cb: (stage: IStage) => void) {\n    this._afterRenderList.push(cb);\n  }\n\n  removeAfterRender(cb: (stage: IStage) => void) {\n    this._afterRenderList = this._afterRenderList.filter(c => c !== cb);\n  }\n\n  afterNextRender(cb: (stage: IStage) => void) {\n    if (!this._afterNextRenderCbs) {\n      this._afterNextRenderCbs = [];\n    }\n    this._afterNextRenderCbs.push(cb);\n  }\n\n  enableView3dTransform() {\n    if (this.view3dTranform) {\n      return;\n    }\n    this.view3dTranform = true;\n    const ViewTransform3dPlugin = Factory.getPlugin('ViewTransform3dPlugin');\n\n    if (ViewTransform3dPlugin) {\n      this.pluginService.register(new ViewTransform3dPlugin());\n    }\n  }\n\n  disableView3dTranform() {\n    if (!this.view3dTranform) {\n      return;\n    }\n    this.view3dTranform = false;\n    this.pluginService.findPluginsByName('ViewTransform3dPlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n\n  enableAutoRender() {\n    if (this.autoRender) {\n      return;\n    }\n    this.autoRender = true;\n    this.pluginService.register(new AutoRenderPlugin());\n  }\n  disableAutoRender() {\n    if (!this.autoRender) {\n      return;\n    }\n    this.autoRender = false;\n    this.pluginService.findPluginsByName('AutoRenderPlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n  enableAutoRefresh() {\n    if (this.autoRefresh) {\n      return;\n    }\n    this.autoRefresh = true;\n    this.pluginService.register(new AutoRefreshPlugin());\n  }\n  disableAutoRefresh() {\n    if (!this.autoRefresh) {\n      return;\n    }\n    this.autoRefresh = false;\n    this.pluginService.findPluginsByName('AutoRefreshPlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n  enableIncrementalAutoRender() {\n    if (this.increaseAutoRender) {\n      return;\n    }\n    this.increaseAutoRender = true;\n    this.pluginService.register(new IncrementalAutoRenderPlugin());\n  }\n  disableIncrementalAutoRender() {\n    if (!this.increaseAutoRender) {\n      return;\n    }\n    this.increaseAutoRender = false;\n    this.pluginService.findPluginsByName('IncrementalAutoRenderPlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n  enableDirtyBounds() {\n    if (this.dirtyBounds) {\n      return;\n    }\n    this.dirtyBounds = new Bounds();\n    let plugin = this.pluginService.findPluginsByName('DirtyBoundsPlugin')[0];\n    if (!plugin) {\n      plugin = new DirtyBoundsPlugin();\n      this.pluginService.register(plugin);\n    } else {\n      plugin.activate(this.pluginService);\n    }\n  }\n  disableDirtyBounds() {\n    if (!this.dirtyBounds) {\n      return;\n    }\n    this.dirtyBounds = null;\n    this.pluginService.findPluginsByName('DirtyBoundsPlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n  enableLayout() {\n    if (this._enableLayout) {\n      return;\n    }\n    this._enableLayout = true;\n\n    const FlexLayoutPlugin = Factory.getPlugin('FlexLayoutPlugin');\n\n    if (FlexLayoutPlugin) {\n      this.pluginService.register(new FlexLayoutPlugin());\n    }\n  }\n  disableLayout() {\n    if (!this._enableLayout) {\n      return;\n    }\n    this._enableLayout = false;\n    this.pluginService.findPluginsByName('FlexLayoutPlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n  enableHtmlAttribute(container?: any) {\n    if (this.htmlAttribute) {\n      return;\n    }\n    const HtmlAttributePlugin = Factory.getPlugin('HtmlAttributePlugin');\n\n    if (HtmlAttributePlugin) {\n      this.htmlAttribute = container;\n      this.pluginService.register(new HtmlAttributePlugin());\n    }\n  }\n  disableHtmlAttribute() {\n    if (!this.htmlAttribute) {\n      return;\n    }\n    this.htmlAttribute = false;\n    this.pluginService.findPluginsByName('HtmlAttributePlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n  enableReactAttribute(container?: any) {\n    if (this.reactAttribute) {\n      return;\n    }\n    const ReactAttributePlugin = Factory.getPlugin('ReactAttributePlugin');\n\n    if (ReactAttributePlugin) {\n      this.reactAttribute = container;\n      this.pluginService.register(new ReactAttributePlugin());\n    }\n  }\n  disableReactAttribute() {\n    if (!this.reactAttribute) {\n      return;\n    }\n    this.reactAttribute = false;\n    this.pluginService.findPluginsByName('ReactAttributePlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n\n  getPluginsByName(name: string): IPlugin[] {\n    return this.pluginService.findPluginsByName(name);\n  }\n\n  // /**\n  //  * stage的appendChild，add\n  //  * @param node\n  //  * @returns\n  //  */\n  // appendChild<T extends Node>(node: T): T | null {\n  //   const layer = this.at(0);\n  //   if (!layer) {\n  //     return null;\n  //   }\n  //   return layer.appendChild<T>(node);\n  // }\n\n  protected tryUpdateAABBBounds(): IAABBBounds {\n    const viewBox = this.window.getViewBox();\n    this._AABBBounds.setValue(viewBox.x1, viewBox.y1, viewBox.x2, viewBox.y2);\n    return this._AABBBounds;\n  }\n\n  combineLayer(ILayer1: ILayer, ILayer2: ILayer): ILayer {\n    throw new Error('暂不支持');\n  }\n  // 如果传入CanvasId，如果存在相同Id，说明这两个图层使用相同的Canvas绘制\n  // 但需要注意的是依然是两个图层（用于解决Table嵌入ChartSpace不影响Table的绘制）\n  createLayer(canvasId?: string, layerMode?: LayerMode): ILayer {\n    if (this.releaseStatus === 'released') {\n      return;\n    }\n    // 创建一个默认layer图层\n    const layer = this.layerService.createLayer(this, {\n      main: false,\n      layerMode,\n      canvasId\n    });\n    this.appendChild(layer);\n    return layer;\n    // const layer = new Layer(this, this.global, this.window, {\n    //   main: false,\n    //   canvasId\n    // });\n    // this.appendChild(layer);\n    // return layer;\n  }\n  sortLayer(cb: (ILayer1: ILayer, layer2: ILayer) => number): void {\n    const children = this.children;\n    children.sort(cb);\n    this.removeAllChild();\n    children.forEach(c => {\n      this.appendChild(c);\n    });\n  }\n  removeLayer(ILayerId: number): ILayer | false {\n    return this.removeChild(this.findChildByUid(ILayerId) as IGraphic) as ILayer;\n  }\n  tryInitInteractiveLayer() {\n    if (this.releaseStatus === 'released') {\n      return;\n    }\n    // TODO：顺序可能会存在问题\n    // 支持交互层，且没有创建过，那就创建\n    if (this.supportInteractiveLayer && !this.interactiveLayer) {\n      this.interactiveLayer = this.createLayer();\n      this.interactiveLayer.name = '_builtin_interactive';\n      this.interactiveLayer.attribute.pickable = false;\n      this.nextFrameRenderLayerSet.add(this.interactiveLayer as any); // to be fixed\n    }\n    // this.interactiveLayer.afterDraw(l => {\n    //   l.removeAllChild();\n    // });\n  }\n\n  clearViewBox(color?: string) {\n    this.window.clearViewBox(color);\n  }\n\n  render(layers?: ILayer[], params?: Partial<IDrawContext>): void {\n    if (this.releaseStatus === 'released') {\n      return;\n    }\n    this.startAnimate();\n    const state = this.state;\n    this.state = 'rendering';\n    this.layerService.prepareStageLayer(this);\n    if (!this._skipRender) {\n      this.lastRenderparams = params;\n      this.hooks.beforeRender.call(this);\n      if (!this._skipRender) {\n        this.renderLayerList(this.children as ILayer[]);\n        this.combineLayersToWindow();\n        this.nextFrameRenderLayerSet.clear();\n      }\n      this.hooks.afterRender.call(this);\n    }\n    this.state = state;\n    this._skipRender && this._skipRender++;\n  }\n\n  protected combineLayersToWindow() {\n    // TODO 后续支持通用的渲染模型\n    if (this.global.env === 'harmony') {\n      const ctx = this.window.getContext().nativeContext;\n      this.forEachChildren<ILayer>((layer, i) => {\n        if (i > 0) {\n          const image = layer\n            .getNativeHandler()\n            .getContext()\n            .canvas.nativeCanvas.nativeCanvas._c.transferToImageBitmap();\n          ctx.transferFromImageBitmap(image);\n        }\n      });\n    }\n    return;\n    // this.forEach<ILayer>((layer, i) => {\n    //   layer.combineTo(this.window, {\n    //     clear: i === 0,\n    //     x: this.x,\n    //     y: this.y,\n    //     width: this.viewWidth,\n    //     height: this.viewHeight,\n    //     renderService: this.renderService,\n    //     background: layer === this.defaultLayer ? this.background : undefined,\n    //     updateBounds: !!this.dirtyBounds\n    //   });\n    // });\n  }\n\n  renderNextFrame(layers?: ILayer[], force?: boolean): void {\n    // render状态中调用的不会触发nextFrame，避免loop\n    // if (this.state === 'rendering' && !force) {\n    //   console.log('abc');\n    //   return;\n    // }\n    // 性能优化，避免重复add\n    if (this.nextFrameRenderLayerSet.size !== this.childrenCount) {\n      (layers || this).forEach<ILayer>((layer: any) => {\n        this.nextFrameRenderLayerSet.add(layer);\n      });\n    }\n    if (!this.willNextFrameRender) {\n      this.willNextFrameRender = true;\n      this.global.getSpecifiedRequestAnimationFrame(this.rafId)(() => {\n        this._doRenderInThisFrame(), (this.willNextFrameRender = false);\n      });\n    }\n  }\n\n  _doRenderInThisFrame() {\n    if (this.releaseStatus === 'released') {\n      return;\n    }\n    this.startAnimate();\n    const state = this.state;\n    this.state = 'rendering';\n    this.layerService.prepareStageLayer(this);\n    if (this.nextFrameRenderLayerSet.size && !this._skipRender) {\n      this.hooks.beforeRender.call(this);\n      if (!this._skipRender) {\n        this.renderLayerList(Array.from(this.nextFrameRenderLayerSet.values()), this.lastRenderparams || {});\n        this.combineLayersToWindow();\n        this.nextFrameRenderLayerSet.clear();\n      }\n      this.hooks.afterRender.call(this);\n    }\n    this.state = state;\n    this._skipRender && this._skipRender++;\n  }\n\n  protected renderLayerList(layerList: ILayer[], params?: Partial<IDrawContext>) {\n    const list: ILayer[] = [];\n    // 只需要render main layer即可\n    for (let i = 0; i < layerList.length; i++) {\n      let l = layerList[i];\n      if (l.layerMode === 'virtual') {\n        l = l.getNativeHandler().mainHandler.layer;\n      }\n      if (!list.includes(l)) {\n        list.push(l);\n      }\n    }\n    list.forEach(layer => {\n      // 记录当前的stamp，避免重复绘制layer（如果存在virtual layer）\n      if (layer.renderCount > this.renderCount) {\n        return;\n      }\n      layer.renderCount = this.renderCount + 1;\n\n      if (layer === this.interactiveLayer) {\n        // 交互层由于其特殊性，不使用dirtyBounds\n        this.dirtyBounds && this.dirtyBounds.clear();\n      }\n      layer.render(\n        {\n          renderService: this.renderService,\n          background: layer === this.defaultLayer ? this.background : undefined,\n          updateBounds: !!(this.dirtyBounds && !this.dirtyBounds.empty()),\n          viewBox: this.window.getViewBox(),\n          transMatrix: this.window.getViewBoxTransform()\n        },\n        { renderStyle: this.renderStyle, ...params }\n      );\n    });\n\n    // 添加交互层渲染\n    if (this.interactiveLayer && !layerList.includes(this.interactiveLayer)) {\n      // 交互层由于其特殊性，不使用dirtyBounds\n      this.dirtyBounds && this.dirtyBounds.clear();\n      this.interactiveLayer.render(\n        {\n          renderService: this.renderService,\n          updateBounds: !!(this.dirtyBounds && !this.dirtyBounds.empty()),\n          viewBox: this.window.getViewBox(),\n          transMatrix: this.window.getViewBoxTransform()\n        },\n        { renderStyle: this.renderStyle, ...params }\n      );\n    }\n  }\n\n  resizeWindow(w: number, h: number, rerender: boolean = true) {\n    this.window.resize(w, h);\n    rerender && this.render();\n  }\n\n  /**\n   * 语法糖，如果viewBox和window宽高一样的话，那么会同时缩放window和viewBox\n   * @param w\n   * @param h\n   * @param rerender\n   */\n  resize(w: number, h: number, rerender: boolean = true): void {\n    if (this.releaseStatus === 'released') {\n      return;\n    }\n    // 如果不是子图的stage，那么认为用户也想要resize view\n    if (!this.window.hasSubView()) {\n      this.viewBox.setValue(this.viewBox.x1, this.viewBox.y1, this.viewBox.x1 + w, this.viewBox.y1 + h);\n    }\n    this.window.resize(w, h);\n    this.forEachChildren<ILayer>(c => {\n      c.resize(w, h);\n    });\n    // 设置camera\n    // this.camera && (this.camera.params = { ...this.camera.params, right: this.width, bottom: this.height });\n    this.camera && this.option3d && this.set3dOptions(this.option3d);\n    rerender && this.render();\n  }\n  resizeView(w: number, h: number, rerender: boolean = true) {\n    if (this.releaseStatus === 'released') {\n      return;\n    }\n    this.viewBox.setValue(this.viewBox.x1, this.viewBox.y1, this.viewBox.x1 + w, this.viewBox.y1 + h);\n    this.forEachChildren<ILayer>(c => {\n      c.resizeView(w, h);\n    });\n    // 设置camera\n    this.camera && (this.camera.params = { ...this.camera.params, right: this.width, bottom: this.height });\n    rerender && this.render();\n  }\n  setViewBox(viewBox: IBoundsLike, rerender: boolean): void;\n  setViewBox(x: number, y: number, w: number, h: number, rerender: boolean): void;\n  setViewBox(x: number | IBoundsLike, y: number | boolean, w?: number, h?: number, rerender?: boolean): void {\n    let isRerender: boolean = true;\n\n    if (typeof x === 'object') {\n      this.viewBox.setValue(x.x1, x.y1, x.x2, x.y2);\n      if (y === false) {\n        isRerender = false;\n      }\n    } else {\n      this.viewBox.setValue(x, y as number, x + w, (y as number) + h);\n\n      if (rerender === false) {\n        isRerender = false;\n      }\n    }\n\n    this.forEachChildren<ILayer>(c => {\n      c.resizeView(this.viewBox.width(), this.viewBox.height());\n    });\n    isRerender && this.render();\n  }\n  setDpr(dpr: number, rerender: boolean = true): void {\n    // this.window.setDpr(dpr);\n    this.forEachChildren<ILayer>(c => {\n      c.setDpr(dpr);\n    });\n\n    rerender && this.render();\n  }\n  setOrigin(x: number, y: number): void {\n    throw new Error('暂不支持');\n  }\n  export(type: IExportType): HTMLCanvasElement | ImageData {\n    throw new Error('暂不支持');\n  }\n  pick(x: number, y: number): PickResult | false {\n    if (this.releaseStatus === 'released') {\n      return;\n    }\n    // 暂时不提供layer的pick\n    const result = this.getPickerService().pick(this.children as unknown as IGraphic[], new Point(x, y), {\n      bounds: this.AABBBounds\n    });\n    if (result?.graphic || result?.group) {\n      return result;\n    }\n    return false;\n  }\n\n  setToFrame(t: number): void {\n    throw new Error('暂不支持');\n  }\n\n  release() {\n    super.release();\n\n    this.hooks.beforeRender.unTap('constructor', this.beforeRender);\n    this.hooks.afterRender.unTap('constructor', this.afterRender);\n\n    this.eventSystem && this.eventSystem.release();\n    this.layerService.releaseStage(this);\n    this.pluginService.release();\n    this.forEach(layer => {\n      layer.release();\n    });\n    // 额外删除掉interactiveLayer的节点\n    if (this.interactiveLayer) {\n      this.interactiveLayer.forEachChildren((item: IGraphic) => {\n        item.setStage && item.setStage(null, null);\n        this.interactiveLayer.removeChild(item);\n      });\n      this.interactiveLayer.release();\n    }\n    this.window.release();\n    this._ticker?.remTimeline(this?.timeline);\n    this._ticker?.removeListener('tick', this.afterTickCb);\n    this.renderService.renderTreeRoots = [];\n  }\n\n  setStage(stage?: IStage) {\n    return;\n    // this.stage = this;\n    // this.forEachChildren(item => {\n    //   (item as Layer).setStage(this);\n    // });\n  }\n\n  /**\n   * 添加dirty区域，会修改参数b\n   * @param b\n   * @param matrix\n   */\n  dirty(b: IBounds, matrix?: IMatrix) {\n    if (this.releaseStatus === 'released') {\n      return;\n    }\n    if (matrix) {\n      b.transformWithMatrix(matrix);\n    }\n    if (this.dirtyBounds.empty()) {\n      this.dirtyBounds.setValue(b.x1, b.y1, b.x2, b.y2);\n    }\n    this.dirtyBounds.union(b);\n  }\n\n  getLayer(name: string): undefined | ILayer {\n    const layer = this.children.filter(layer => layer.name === name);\n    return layer[0] as ILayer;\n  }\n\n  renderTo(window: IWindow) {\n    if (this.releaseStatus === 'released') {\n      return;\n    }\n    this.forEachChildren<ILayer>((layer, i) => {\n      layer.drawTo(window, {\n        // ...params,\n        renderService: this.renderService,\n        viewBox: window.getViewBox(),\n        transMatrix: window.getViewBoxTransform(),\n        background: layer === this.defaultLayer ? this.background : undefined,\n        clear: i === 0, // 第一个layer需要clear\n        updateBounds: !!(this.dirtyBounds && !this.dirtyBounds.empty())\n      });\n    });\n  }\n\n  /**\n   * 渲染到新的window上去\n   * @param fullImage 是否是全量的image，因为可能之前的window有一部分场景树超过window的帧缓冲了\n   * @returns\n   */\n  renderToNewWindow(fullImage: boolean = true, viewBox?: IAABBBounds): IWindow {\n    if (this.releaseStatus === 'released') {\n      return;\n    }\n    const window = container.get<IWindow>(VWindow);\n    const x1 = viewBox ? -viewBox.x1 : 0;\n    const y1 = viewBox ? -viewBox.y1 : 0;\n    const x2 = viewBox ? viewBox.x2 : this.viewWidth;\n    const y2 = viewBox ? viewBox.y2 : this.viewHeight;\n    const width = viewBox ? viewBox.width() : this.viewWidth;\n    const height = viewBox ? viewBox.height() : this.viewHeight;\n    if (fullImage) {\n      window.create({\n        viewBox: { x1, y1, x2, y2 },\n        width,\n        height,\n        dpr: this.window.dpr,\n        canvasControled: true,\n        offscreen: true,\n        title: ''\n      });\n    } else {\n      window.create({\n        viewBox: { x1, y1, x2, y2 },\n        width,\n        height,\n        dpr: this.window.dpr,\n        canvasControled: true,\n        offscreen: true,\n        title: ''\n      });\n    }\n\n    this.renderTo(window);\n    return window;\n  }\n\n  toCanvas(fullImage: boolean = true, viewBox?: IAABBBounds): HTMLCanvasElement | null {\n    if (this.releaseStatus === 'released') {\n      return;\n    }\n    const window = this.renderToNewWindow(fullImage, viewBox);\n    const c = window.getNativeHandler();\n    if (c.nativeCanvas) {\n      return c.nativeCanvas;\n    }\n    return null;\n  }\n\n  setCursor(mode?: string): void {\n    this._cursor = mode;\n    this.eventSystem.setCursor(mode, 'ignore');\n  }\n\n  getCursor() {\n    return this._cursor;\n  }\n\n  eventPointTransform(e: PointerEvent | WheelEvent | TouchEvent): { x: number; y: number } {\n    const point = this.global.mapToCanvasPoint(e, this.window);\n\n    return this.stage.window.pointTransform(point.x, point.y);\n  }\n\n  pauseTriggerEvent() {\n    this._eventSystem && this._eventSystem.pauseTriggerEvent();\n  }\n  resumeTriggerEvent() {\n    this._eventSystem && this._eventSystem.resumeTriggerEvent();\n  }\n\n  getPickerService() {\n    if (!this.pickerService) {\n      this.pickerService = container.get<IPickerService>(PickerService);\n    }\n    return this.pickerService;\n  }\n\n  reInit() {\n    this.renderService.reInit();\n    this.pickerService.reInit();\n  }\n}\n"]}