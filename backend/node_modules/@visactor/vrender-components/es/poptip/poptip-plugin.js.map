{"version":3,"sources":["../src/poptip/poptip-plugin.ts"],"names":[],"mappings":"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","file":"poptip-plugin.js","sourcesContent":["import type { FederatedPointerEvent, IGraphic, IPlugin, IPluginService } from '@visactor/vrender-core';\nimport { Generator, injectable } from '@visactor/vrender-core';\n\n// _showPoptip: 0-没有，1-添加，2-删除\n\nexport abstract class PopTipPluginBase {\n  activeEvent: 'onRegister' = 'onRegister';\n  pluginService: IPluginService;\n  _uid: number = Generator.GenAutoIncrementId();\n  activeGraphic: IGraphic;\n\n  activate(context: IPluginService): void {\n    this.pluginService = context;\n    const { stage } = this.pluginService;\n\n    stage.addEventListener('pointerover', this.poptip);\n  }\n\n  needHide(graphic: IGraphic) {\n    return graphic.isContainer || !graphic.attribute;\n  }\n\n  needShow(graphic: IGraphic) {\n    return !!(graphic.attribute as any).poptip;\n  }\n\n  poptip = (e: FederatedPointerEvent) => {\n    const graphic = e.target as any;\n    if (this.needHide(graphic)) {\n      this.unpoptip(e);\n      return;\n    }\n    // 触发graphic重绘\n    if (graphic === this.activeGraphic) {\n      return;\n    }\n    if (this.needShow(graphic)) {\n      graphic.setAttributes({});\n      graphic._showPoptip = 1;\n    }\n\n    if (this.activeGraphic) {\n      this.activeGraphic.setAttributes({});\n      this.activeGraphic._showPoptip = 2;\n    }\n    // console.log(graphic)\n    this.setActiveGraphic(graphic, true);\n  };\n\n  unpoptip = (e: FederatedPointerEvent) => {\n    if (!this.activeGraphic) {\n      return;\n    }\n    this.activeGraphic.setAttributes({});\n    this.activeGraphic._showPoptip = 2;\n    this.setActiveGraphic(null, true);\n  };\n\n  setActiveGraphic(graphic: any | null, rerender?: boolean) {\n    this.activeGraphic = graphic;\n    // 触发重绘\n    this.pluginService.stage.renderNextFrame();\n  }\n\n  deactivate(context: IPluginService): void {\n    const { stage } = this.pluginService;\n    stage.removeEventListener('pointerover', this.poptip);\n  }\n}\n\n@injectable()\nexport class PopTipPlugin extends PopTipPluginBase implements IPlugin {\n  name: 'poptip' = 'poptip';\n  key: string = this.name + this._uid;\n}\n\n@injectable()\nexport class PopTipForClipedTextPlugin extends PopTipPluginBase implements IPlugin {\n  name: 'poptipForText' = 'poptipForText';\n  key: string = this.name + this._uid;\n\n  activate(context: IPluginService): void {\n    super.activate(context);\n\n    const { stage } = this.pluginService;\n\n    stage.addEventListener('pointerleave', this.pointerlave);\n  }\n  pointerlave = (e: any) => {\n    const { stage } = this.pluginService;\n    if (e.target === stage) {\n      this.unpoptip(e);\n    }\n  };\n\n  needHide(graphic: IGraphic) {\n    return (\n      graphic.type !== 'text' ||\n      !graphic.cliped ||\n      graphic.isContainer ||\n      !graphic.attribute ||\n      (graphic as any).attribute.disableAutoClipedPoptip\n    );\n  }\n  needShow(graphic: IGraphic): boolean {\n    return true;\n  }\n\n  deactivate(context: IPluginService): void {\n    const { stage } = this.pluginService;\n    super.deactivate(context);\n    stage.removeEventListener('pointerleave', this.pointerlave);\n  }\n}\n"]}