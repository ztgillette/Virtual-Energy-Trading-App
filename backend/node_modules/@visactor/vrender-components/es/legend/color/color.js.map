{"version":3,"sources":["../src/legend/color/color.ts"],"names":[],"mappings":"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","file":"color.js","sourcesContent":["/**\n * @description 连续颜色图例\n * TODO:\n * showHandlers 测试\n */\nimport { merge, isEmpty, get, isNil } from '@visactor/vutils';\nimport type { FederatedPointerEvent, FederatedEvent, IColor, ILinearGradient, INode } from '@visactor/vrender-core';\nimport type { ILinearScale } from '@visactor/vscale';\nimport { LinearScale } from '@visactor/vscale';\nimport { LegendBase } from '../base';\nimport { Slider } from '../../slider';\nimport { DEFAULT_TITLE_SPACE } from '../constant';\nimport type { ColorLegendAttributes } from './type';\nimport type { ComponentOptions } from '../../interface';\nimport { loadColorContinuousLegendComponent } from '../register';\n\nloadColorContinuousLegendComponent();\nexport class ColorContinuousLegend extends LegendBase<ColorLegendAttributes> {\n  name = 'colorLegend';\n\n  static defaultAttributes = {\n    layout: 'horizontal',\n    title: {\n      // orient: 'top',\n      align: 'start',\n      space: DEFAULT_TITLE_SPACE,\n      textStyle: {\n        fontSize: 12,\n        fontWeight: 'bold',\n        fill: 'rgba(46, 47, 50, 1)'\n      }\n    },\n    handlerSize: 10,\n    handlerStyle: {\n      fill: null as any,\n      lineWidth: 4,\n      stroke: '#fff',\n      outerBorder: {\n        distance: 2,\n        lineWidth: 1,\n        stroke: '#ccc'\n      }\n    },\n    tooltip: {\n      shapeStyle: {\n        lineWidth: 4,\n        stroke: '#fff'\n      }\n    }\n  };\n\n  private _slider!: Slider;\n  private _colorScale!: ILinearScale;\n  private _color: IColor | undefined;\n\n  constructor(attributes: ColorLegendAttributes, options?: ComponentOptions) {\n    super(options?.skipDefault ? attributes : merge({}, ColorContinuousLegend.defaultAttributes, attributes));\n  }\n\n  /**\n   * 更新数据选中范围\n   * @param value 选中数据范围\n   * @returns\n   */\n  setSelected(value: number[]) {\n    if (!this._slider) {\n      return;\n    }\n    this._slider.setValue(value);\n    this._updateColor();\n  }\n\n  protected _renderContent(): void {\n    const {\n      colors,\n      slidable,\n      layout,\n      align,\n      min,\n      max,\n      value,\n      railWidth,\n      railHeight,\n      showHandler = true,\n      handlerSize,\n      handlerStyle,\n      railStyle,\n      trackStyle,\n      startText,\n      endText,\n      handlerText,\n      showTooltip,\n      tooltip,\n      inverse,\n      disableTriggerEvent\n    } = this.attribute as ColorLegendAttributes;\n\n    // 创建 colorScale\n    const domain = [];\n    const step = (max - min) / (colors.length - 1);\n    for (let i = 0; i < colors.length; i++) {\n      domain.push(min + step * i);\n    }\n\n    this._colorScale = new LinearScale().domain(domain, true).range(colors);\n    this._color = this._getTrackColor();\n\n    const slider = new Slider({\n      x: 0,\n      y: 0,\n      range: {\n        draggableTrack: true\n      },\n      slidable,\n      layout,\n      align,\n      min,\n      max,\n      value,\n      railWidth,\n      railHeight,\n      showHandler,\n      handlerSize,\n      handlerStyle,\n      railStyle,\n      trackStyle: {\n        fill: this._color,\n        ...trackStyle\n      },\n      startText,\n      endText,\n      handlerText,\n      showTooltip,\n      tooltip,\n      disableTriggerEvent,\n      inverse\n    });\n    this._innerView.add(slider as unknown as INode);\n    this._slider = slider;\n    // 做下位置调整，对齐\n    slider.translateTo(\n      0 - slider.AABBBounds.x1,\n      (this._title ? this._title.AABBBounds.height() + get(this.attribute, 'title.space', DEFAULT_TITLE_SPACE) : 0) -\n        slider.AABBBounds.y1\n    );\n    this._updateColor();\n  }\n\n  protected _bindEvents(): void {\n    if (this.attribute.disableTriggerEvent) {\n      return;\n    }\n    if (this._slider) {\n      this._slider.addEventListener('change', this._onSliderChange as EventListenerOrEventListenerObject);\n      this._slider.addEventListener('sliderTooltip', this._onSliderToolipChange as EventListenerOrEventListenerObject);\n    }\n  }\n\n  private _getTrackColor(): IColor | undefined {\n    const { colors, layout, inverse } = this.attribute as ColorLegendAttributes;\n\n    if (isEmpty(colors)) {\n      return undefined;\n    }\n    const count = colors.length;\n    if (count === 1) {\n      return colors[0];\n    }\n    const stops = [];\n\n    for (let i = 0; i < count; i++) {\n      const percent = i / (count - 1);\n      stops.push({\n        offset: percent,\n        color: colors[i]\n      });\n    }\n    const isHorizontal = layout === 'horizontal';\n\n    const res: IColor = {\n      gradient: 'linear',\n      stops,\n      x0: 0,\n      y0: 0,\n      x1: isHorizontal ? 1 : 0,\n      y1: isHorizontal ? 0 : 1\n    };\n\n    if (inverse) {\n      if (isHorizontal) {\n        res.x0 = 1;\n        res.x1 = 0;\n      } else {\n        res.y0 = 1;\n        res.y1 = 0;\n      }\n    }\n\n    return res;\n  }\n\n  private _onSliderToolipChange = (e: FederatedEvent) => {\n    const tooltipShape = this._slider.tooltipShape;\n\n    if (tooltipShape && e.detail && !isNil(e.detail.value)) {\n      const color = this._colorScale.scale(e.detail.value);\n\n      tooltipShape.setAttribute('fill', color);\n    }\n\n    this.dispatchEvent(e);\n  };\n\n  private _onSliderChange = (e: FederatedEvent) => {\n    // 更新 handler 以及 track 的渐变色\n    this._updateColor();\n    this.dispatchEvent(e);\n  };\n\n  private _updateColor() {\n    const { layout = 'horizontal', colors, railWidth, railHeight } = this.attribute as ColorLegendAttributes;\n    const { startHandler, endHandler, track, attribute } = this._slider;\n    const { startValue, endValue, startPos, endPos } = this._slider.currentValue;\n    const handlerColor = attribute.handlerStyle?.fill;\n    // 计算颜色\n    if (startHandler && !handlerColor) {\n      const startHandlerColor = this._colorScale.scale(startValue);\n      startHandler.setAttribute('fill', startHandlerColor);\n    }\n\n    if (endHandler && !handlerColor) {\n      const endHandlerColor = this._colorScale.scale(endValue);\n      endHandler.setAttribute('fill', endHandlerColor);\n    }\n\n    const isHorizontal = layout === 'horizontal';\n    const railLen = isHorizontal ? railWidth : railHeight;\n    const trackLength = Math.abs((startPos as number) - (endPos as number));\n\n    // 计算渐变色\n    if (trackLength !== railLen && colors && colors.length > 1) {\n      const stops = (this._color as ILinearGradient).stops;\n      const start = Math.min(startPos as number, endPos as number);\n      const end = Math.max(startPos as number, endPos as number);\n      const startRatio = start / railLen;\n      const endRatio = end / railLen;\n      const range = endRatio - startRatio;\n      const betweenStops = stops.filter(stop => stop.offset > startRatio && stop.offset < endRatio);\n\n      const minValue = Math.min(startValue, endValue);\n      const maxValue = Math.max(startValue, endValue);\n      const startColor = this._colorScale.scale(minValue);\n      const endColor = this._colorScale.scale(maxValue);\n      const newStops = [{ offset: 0, color: startColor }];\n      betweenStops.forEach(stop => {\n        newStops.push({\n          offset: (stop.offset - startRatio) / range,\n          color: stop.color\n        });\n      });\n      newStops.push({\n        offset: 1,\n        color: endColor\n      });\n      track.setAttribute('fill', {\n        ...(this._color as ILinearGradient),\n        stops: newStops\n      });\n    }\n  }\n}\n"]}