{"version":3,"sources":["../src/marker/base.ts"],"names":[],"mappings":"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","file":"base.js","sourcesContent":["import type { FederatedPointerEvent, IGraphic, IGroup, IImage, IRichText, ISymbol } from '@visactor/vrender-core';\n// eslint-disable-next-line no-duplicate-imports\nimport { graphicCreator } from '@visactor/vrender-core';\nimport { AbstractComponent } from '../core/base';\nimport type { Tag } from '../tag';\nimport type { MarkerAnimationState, MarkerAttrs, MarkerExitAnimation, MarkerUpdateAnimation } from './type';\nimport { dispatchClickState, dispatchHoverState, dispatchUnHoverState } from '../util/interaction';\nimport { isObject, merge } from '@visactor/vutils';\n\nexport abstract class Marker<T extends MarkerAttrs<AnimationAttr>, AnimationAttr> extends AbstractComponent<\n  Required<T>\n> {\n  name = 'marker';\n\n  private _containerClip!: IGroup;\n  protected _container!: IGroup;\n\n  /** animate */\n  static _animate?: (\n    marker: any,\n    label: (Tag | IRichText | ISymbol | IImage) | (Tag | IRichText | ISymbol | IImage)[],\n    animationConfig: any,\n    state: MarkerAnimationState\n  ) => void;\n\n  defaultUpdateAnimation!: MarkerUpdateAnimation<AnimationAttr>;\n  defaultExitAnimation!: MarkerExitAnimation;\n\n  protected _animationConfig?: {\n    enter: MarkerUpdateAnimation<AnimationAttr>;\n    exit: MarkerExitAnimation;\n    update: MarkerUpdateAnimation<AnimationAttr>;\n  };\n\n  private _lastHover: IGraphic;\n  private _lastSelect: IGraphic;\n\n  protected abstract setLabelPos(labelNode: IGroup, labelAttrs: any): any;\n  protected abstract initMarker(container: IGroup): any;\n  protected abstract updateMarker(): any;\n  protected abstract isValidPoints(): any;\n  protected abstract markerAnimate(state: MarkerAnimationState): void;\n\n  private transAnimationConfig(): void {\n    if (this.attribute.animation !== false) {\n      const animation = isObject(this.attribute.animation) ? this.attribute.animation : {};\n      this._animationConfig = {\n        enter: merge(\n          {},\n          this.defaultUpdateAnimation,\n          animation,\n          this.attribute.animationEnter ?? {}\n        ) as MarkerUpdateAnimation<AnimationAttr>,\n        exit: merge({}, this.defaultExitAnimation, animation, this.attribute.animationExit ?? {}),\n        update: merge(\n          {},\n          this.defaultUpdateAnimation,\n          animation,\n          this.attribute.animationUpdate ?? {}\n        ) as MarkerUpdateAnimation<AnimationAttr>\n      };\n    }\n  }\n  setAttribute(key: string, value: any, forceUpdateTag?: boolean | undefined): void {\n    super.setAttribute(key, value, forceUpdateTag);\n    if (key === 'visible') {\n      this.render();\n    }\n  }\n\n  private _bindEvent() {\n    if (!this.attribute.interactive) {\n      return;\n    }\n    const { hover, select } = this.attribute;\n\n    if (hover) {\n      this._container?.addEventListener('pointermove', this._onHover as EventListenerOrEventListenerObject);\n      this._container?.addEventListener('pointerout', this._onUnHover as EventListenerOrEventListenerObject);\n    }\n\n    if (select) {\n      this._container?.addEventListener('pointerdown', this._onClick as EventListenerOrEventListenerObject);\n    }\n  }\n\n  private _releaseEvent() {\n    this._container?.removeEventListener('pointermove', this._onHover as EventListenerOrEventListenerObject);\n    this._container?.removeEventListener('pointerout', this._onUnHover as EventListenerOrEventListenerObject);\n    this._container?.removeEventListener('pointerdown', this._onClick as EventListenerOrEventListenerObject);\n  }\n\n  private _onHover = (e: FederatedPointerEvent) => {\n    this._lastHover = dispatchHoverState(e, this._container, this._lastHover);\n  };\n\n  private _onUnHover = (e: FederatedPointerEvent) => {\n    this._lastHover = dispatchUnHoverState(e, this._container, this._lastHover);\n  };\n\n  private _onClick = (e: FederatedPointerEvent) => {\n    this._lastSelect = dispatchClickState(e, this._container, this._lastSelect);\n  };\n\n  private _initContainer() {\n    const { limitRect = {} as T['limitRect'], clipInRange } = this.attribute;\n    let group;\n    if (clipInRange) {\n      // 如果用户配置了剪切\n      const groupClip = graphicCreator.group({\n        ...limitRect,\n        clip: true,\n        pickable: false\n      });\n      group = graphicCreator.group({\n        x: -(limitRect.x ?? 0),\n        y: -(limitRect.y ?? 0),\n        pickable: false\n      });\n      groupClip.add(group);\n      this._containerClip = groupClip;\n      this.add(groupClip);\n    } else {\n      group = graphicCreator.group({\n        x: 0,\n        y: 0,\n        pickable: false\n      });\n      this.add(group);\n    }\n    group.name = 'marker-container';\n    this._container = group;\n  }\n\n  private _updateContainer() {\n    const { limitRect = {} as T['limitRect'], clipInRange } = this.attribute;\n    if (this._containerClip) {\n      this._containerClip.setAttributes({\n        ...limitRect\n      });\n    }\n\n    this._container.setAttributes({\n      x: clipInRange ? -(limitRect.x ?? 0) : 0,\n      y: clipInRange ? -(limitRect.y ?? 0) : 0\n    });\n  }\n\n  protected render() {\n    this.transAnimationConfig();\n\n    // 因为标注本身不规则，所以默认将组件的 group 设置为不可拾取\n    this.setAttribute('pickable', false);\n\n    const markerVisible = this.attribute.visible ?? true;\n    if (this.attribute.interactive === false) {\n      this.setAttribute('childrenPickable', false);\n    }\n\n    if (markerVisible && this.isValidPoints()) {\n      if (!this._container) {\n        this._initContainer();\n        this.initMarker(this._container);\n        this.markerAnimate('enter');\n      } else {\n        this._updateContainer();\n        this.updateMarker();\n        this.markerAnimate('update');\n      }\n    } else {\n      this.markerAnimate('exit');\n      this._container = null;\n      this.removeAllChild(true);\n    }\n\n    // 先把之前的event都release掉，否则会重复触发\n    this._releaseEvent();\n    this._bindEvent();\n  }\n\n  release(): void {\n    this.markerAnimate('exit');\n    super.release();\n    this._releaseEvent();\n    this._container = null;\n  }\n}\n"]}